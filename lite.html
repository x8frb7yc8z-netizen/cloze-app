<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Cloze Master Fusion</title>
<style>
:root { --primary: #43a047; --bg: #f8f9fa; --danger: #ff5252; --accent: #42a5f5; --input-bg: #fffde7; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; width:100%; height:100dvh; font-family:-apple-system, system-ui, sans-serif; background:#fff; overflow:hidden; }

/* 1. å¸ƒå±€ç»“æ„ */
.app-container { display: flex; flex-direction: column; height: 100dvh; }
.hidden { display: none !important; }

/* 2. é¡¶éƒ¨å¯¼èˆªæ¡ (ä¼˜åŒ–è‡ª Sync ç‰ˆ) */
.nav-bar { 
    display: flex; background: #fff; position: fixed; top: 0; left: 0; width: 100%; 
    z-index: 1000; height: 40px; border-bottom: 1px solid #ddd; 
}
.nav-bar button { 
    flex: 1; border: none; font-weight: bold; cursor: pointer; font-size: 14px; 
    display: flex; align-items: center; justify-content: center; transition: 0.2s;
}
.btn-primary { background: var(--primary); color: white; }
.btn-accent { background: var(--accent); color: white; }
.btn-back { background: #f8f9fa; color: #333; }

.font-ctrl { display: flex; align-items: center; gap: 5px; padding: 0 10px; font-size: 14px; background: #fff; border-right: 1px solid #eee; }
.font-btn { background:none; border:none; font-weight:bold; padding:5px; cursor:pointer; }

/* 3. å†…å®¹åŒº (èåˆæ’ç‰ˆ) */
.main-area { flex: 1; position: relative; margin-top: 40px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
textarea, #clozeContent {
    width: 100%; min-height: calc(100vh - 40px); text-align: center;
    padding: 30px 15px; border: none; outline: none; line-height: 1.6;
    white-space: pre-wrap; word-break: break-word; font-family: inherit;
}
textarea { resize: none; display: block; }
#clozeContent { display: none; padding-bottom: 60vh; }

/* 4. ç»ƒä¹ æ¨¡å¼æ ·å¼ */
.exercise-mode textarea { display: none; }
.exercise-mode #clozeContent { display: block; }

.cloze-input { 
    font-size: inherit; border: none; border-bottom: 1.5px solid #666; 
    background: var(--input-bg); text-align: center; margin: 0 2px;
    outline: none; border-radius: 0; vertical-align: baseline;
}
.word-span { cursor: pointer; }

/* 5. è·Ÿæ‰“æ¨¡å¼æ ·å¼ */
.typing-container { font-family: 'Consolas', monospace; color: #ccc; text-align: left; max-width: 800px; margin: 0 auto; }
.char-correct { color: var(--primary); }
.char-wrong { color: var(--danger); background: #ffebee; }
.char-current { color: #333; border-bottom: 3px solid var(--primary); background: #e8f5e9; }
#hiddenInput { position: fixed; left: -999px; opacity: 0; }
</style>
</head>

<body>
<div class="app-container" id="app">
    <nav class="nav-bar">
        <div class="font-ctrl edit-only">
            <button class="font-btn" onclick="changeFontSize(-2)">A-</button>
            <span id="fontSizeLabel">26</span>
            <button class="font-btn" onclick="changeFontSize(2)">A+</button>
        </div>
        <button id="generateBtn" class="btn-primary edit-only">æ¯ 4 è¯ç”Ÿæˆ</button>
        <button class="btn-accent edit-only" onclick="startTypingMode()">è·Ÿæ‰“æ¨¡å¼</button>
        <button id="customBtn" class="edit-only" style="background:#fff" onclick="renderCloze(true)">æ‰‹åŠ¨æŒ–ç©º</button>
        
        <button class="btn-back exercise-only hidden" onclick="exitExercise()">â† è¿”å›ç¼–è¾‘</button>
        <button id="delModeBtn" class="exercise-only hidden" onclick="toggleDeleteMode()" style="background:#fffde7">é‡ç½®: å…³</button>
    </nav>

    <main class="main-area">
        <textarea id="inputText" placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹..."></textarea>
        <div id="clozeContent"></div>
        <input type="text" id="hiddenInput" autocomplete="off">
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
        authDomain: "cloze-master-pro.firebaseapp.com",
        databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "cloze-master-pro",
        storageBucket: "cloze-master-pro.firebasestorage.app",
        messagingSenderId: "697808901954",
        appId: "1:697808901954:web:32455d94bf67e522e01adb"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getDatabase(fbApp);

    window.syncData = async (mode, data = null) => {
        const text = document.getElementById('inputText').value.trim();
        if (!text) return;
        const id = btoa(unescape(encodeURIComponent(text.substring(0, 25)))).replace(/[/+=]/g, "");
        if (mode === 'upload') set(ref(db, 'clozes/' + id), { positions: data, ts: Date.now() });
        if (mode === 'download') {
            const snap = await get(child(ref(db), 'clozes/' + id));
            return snap.exists() ? snap.val().positions : null;
        }
    };
</script>

<script>
let currentFontSize = 26;
let manualPositions = JSON.parse(localStorage.getItem('cloze_single_positions')) || [];
let currentInterval = 4;
let answers = [];
let isDeleteMode = false;
let typingIndex = 0;
let rawTextArray = [];

const app = document.getElementById('app');
const inputArea = document.getElementById('inputText');
const clozeContent = document.getElementById('clozeContent');
const genBtn = document.getElementById('generateBtn');

// --- åˆå§‹åŒ– ---
window.onload = () => {
    inputArea.value = localStorage.getItem('cloze_single_content') || "Practice makes perfect.";
    currentFontSize = parseInt(localStorage.getItem('cloze_font_size')) || 26;
    applyFontSize(currentFontSize);
    setupFusionButton();
};

function applyFontSize(size) {
    inputArea.style.fontSize = clozeContent.style.fontSize = size + "px";
    document.getElementById('fontSizeLabel').innerText = size;
    localStorage.setItem('cloze_font_size', size);
}

function changeFontSize(delta) { applyFontSize(currentFontSize += delta); }

// --- æ¨¡å¼åˆ‡æ¢æ§åˆ¶ ---
function toggleUIMode(isExercise) {
    app.classList.toggle('exercise-mode', isExercise);
    document.querySelectorAll('.edit-only').forEach(el => el.classList.toggle('hidden', isExercise));
    document.querySelectorAll('.exercise-only').forEach(el => el.classList.toggle('hidden', !isExercise));
}

function exitExercise() {
    toggleUIMode(false);
    clozeContent.innerHTML = "";
}

// --- æ ¸å¿ƒï¼šé•¿æŒ‰+ç‚¹å‡»èåˆæŒ‰é’® ---
function setupFusionButton() {
    let timer, isLong = false;
    const start = (e) => {
        isLong = false;
        timer = setTimeout(() => {
            isLong = true;
            currentInterval = currentInterval >= 6 ? 2 : currentInterval + 1;
            genBtn.innerText = `æ¯ ${currentInterval} è¯ç”Ÿæˆ`;
        }, 600);
    };
    const end = () => {
        clearTimeout(timer);
        if (!isLong) renderCloze(false);
    };
    genBtn.addEventListener('touchstart', (e) => { e.preventDefault(); start(); });
    genBtn.addEventListener('touchend', end);
    genBtn.addEventListener('mousedown', start);
    genBtn.addEventListener('mouseup', end);
}

// --- æ¸²æŸ“é€»è¾‘ ---
async function renderCloze(isManual = false) {
    const text = inputArea.value.trim();
    if (!text) return;

    if (isManual && window.syncData) {
        const remote = await window.syncData('download');
        if (remote) manualPositions = remote;
    }

    const regex = /([a-zA-Z]+|[\u4e00-\u9fa5]|[^\s\w\u4e00-\u9fa5]+)/g;
    const segments = text.split(regex);
    answers = [];
    let unitCount = 0;

    clozeContent.innerHTML = segments.map(seg => {
        if (!seg || !seg.trim()) return seg;
        const idx = unitCount++;
        const isTarget = isManual ? manualPositions.includes(idx) : (idx % currentInterval === 0);

        if (isTarget) {
            answers.push(seg);
            const isChinese = /[\u4e00-\u9fa5]/.test(seg);
            return `<input class="cloze-input" data-id="${answers.length-1}" data-index="${idx}" 
                    style="width:${isChinese ? 2 : seg.length + 0.5}ch;" 
                    placeholder="${isChinese ? '?' : seg[0] + '_'}" 
                    oninput="validateInput(this)" onkeydown="handleSpace(event, this)">`;
        }
        return `<span class="word-span" data-index="${idx}" onclick="handleWordClick(this)">${seg}</span>`;
    }).join("");

    toggleUIMode(true);
}

// --- äº¤äº’é€»è¾‘ ---
function validateInput(el) {
    const ans = answers[el.dataset.id].toLowerCase();
    const val = el.value.trim().toLowerCase();
    el.style.backgroundColor = (val === ans) ? "#c8f7c5" : (ans.startsWith(val) ? "var(--input-bg)" : "#f7c5c5");
    if (val === ans) checkDone();
}

function handleWordClick(el) {
    if (!app.classList.contains('exercise-mode')) return;
    const idx = parseInt(el.dataset.index);
    if (!manualPositions.includes(idx)) {
        manualPositions.push(idx);
        saveAndSync();
        renderCloze(true);
    }
}

function toggleDeleteMode() {
    isDeleteMode = !isDeleteMode;
    document.getElementById('delModeBtn').innerText = isDeleteMode ? "é‡ç½®: å¼€" : "é‡ç½®: å…³";
    clozeContent.onclick = (e) => {
        if (isDeleteMode && e.target.tagName === 'INPUT') {
            manualPositions = manualPositions.filter(i => i !== parseInt(e.target.dataset.index));
            saveAndSync();
            renderCloze(true);
        }
    };
}

function handleSpace(e, el) {
    if (e.keyCode === 32) {
        e.preventDefault();
        const ans = answers[el.dataset.id];
        el.value = ans.substring(0, el.value.length + 1);
        validateInput(el);
    }
}

// --- è·Ÿæ‰“æ¨¡å¼ ---
function startTypingMode() {
    const text = inputArea.value;
    if (!text) return;
    rawTextArray = text.split("");
    typingIndex = 0;
    clozeContent.innerHTML = `<div class="typing-container" id="typeBox" onclick="document.getElementById('hiddenInput').focus()"></div>`;
    document.getElementById("typeBox").innerHTML = rawTextArray.map((char, i) => {
        let displayChar = char === '\n' ? 'â†µ<br>' : (char === ' ' ? '&nbsp;' : char);
        return `<span id="char-${i}">${displayChar}</span>`;
    }).join("");
    
    toggleUIMode(true);
    updateTyping();
    
    const hid = document.getElementById('hiddenInput');
    hid.focus();
    hid.oninput = (e) => {
        const input = e.target.value.slice(-1);
        if (input.toLowerCase() === rawTextArray[typingIndex].toLowerCase()) {
            document.getElementById(`char-${typingIndex}`).className = "char-correct";
            typingIndex++;
            updateTyping();
        } else {
            document.getElementById(`char-${typingIndex}`).className = "char-wrong";
        }
        e.target.value = "";
    };
}

function updateTyping() {
    if (typingIndex >= rawTextArray.length) { alert("ğŸ‰ å®Œå·¥ï¼"); return exitExercise(); }
    const cur = document.getElementById(`char-${typingIndex}`);
    cur.className = "char-current";
    cur.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function checkDone() {
    const all = Array.from(clozeContent.querySelectorAll('input'));
    if (all.length > 0 && all.every(i => i.value.trim().toLowerCase() === answers[i.dataset.id].toLowerCase())) {
        setTimeout(() => { alert("ğŸ‰ å®Œç¾ï¼"); exitExercise(); }, 200);
    }
}

function saveAndSync() {
    localStorage.setItem('cloze_single_positions', JSON.stringify(manualPositions));
    localStorage.setItem('cloze_single_content', inputArea.value);
    if (window.syncData) window.syncData('upload', manualPositions);
}
inputArea.oninput = () => localStorage.setItem('cloze_single_content', inputArea.value);
</script>
</body>
</html>
