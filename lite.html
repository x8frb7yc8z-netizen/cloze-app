<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

<title>Cloze Master Pro</title>

<style>
:root{
  --primary:#43a047;
  --danger:#ff5252;
  --bg-light:#f8f9fa;
}

*{box-sizing:border-box;}
html,body{
  margin:0;
  padding:0;
  height:100dvh;
  overflow:hidden;
  font-family:-apple-system,system-ui,"Microsoft YaHei",sans-serif;
}

.hidden{display:none!important;}

textarea{
  flex:1;
  width:100%;
  border:none;
  outline:none;
  padding:15px;
  font-size:18px;
  line-height:1.6;
  resize:none;
}

/* Cloze Display */
.cloze-display{
  position:absolute;
  inset:0;
  padding:15px;
  display:none;
  overflow-y:auto;
  white-space:pre-wrap;
  background:#fff;
}
.cloze-display.active{display:block;}

.cloze-display input{
  min-width:3ch;
  border:none;
  border-bottom:2px solid #666;
  background:#fffde7;
  text-align:center;
  font-size:inherit;
}

/* Footer */
.footer-bar{
  background:#111;
  color:#bbb;
  padding:12px 15px calc(12px + env(safe-area-inset-bottom));
  display:flex;
  justify-content:space-between;
}

/* Typing Mode */
.typing-container{
  font-family:Consolas,monospace;
  font-size:24px;
  line-height:1.6;
  color:#ccc;
  user-select:none;
}
.char-correct{color:#43a047;}
.char-wrong{color:#ff5252;background:#ffebee;}
.char-current{
  color:#333;
  border-bottom:3px solid var(--primary);
  background:#e8f5e9;
}
</style>
</head>

<body>
<div class="app-container">

<!-- Top -->
<div id="topSection">
  <div style="padding:10px;background:var(--bg-light);border-bottom:1px solid #ddd;">
    <b style="color:var(--primary)">å®Œå½¢å¡«ç©º Cloze Master</b>
  </div>
</div>

<!-- Input -->
<div class="input-wrapper" style="flex:1;position:relative;">
  <textarea id="inputText" placeholder="åœ¨æ­¤ç²˜è´´æ–‡æœ¬..."></textarea>

  <div id="clozeDisplay" class="cloze-display">
    <button onclick="exitExercise()" style="padding:8px 14px;">â† è¿”å›</button>

    <input id="hiddenInput"
           style="position:fixed;opacity:0;width:1px;height:1px;bottom:20px;left:20px;">

    <div id="clozeContent" style="margin-top:15px;"></div>

    <div id="scoreResult"
         style="margin-top:20px;text-align:center;font-weight:bold;color:var(--primary);"></div>

    <button id="submitBtn"
            onclick="calculateScore()"
            style="width:100%;padding:15px;margin-top:15px;
                   background:var(--primary);color:white;
                   border:none;border-radius:8px;">
      æäº¤å¹¶è¯„åˆ†
    </button>
  </div>
</div>

<!-- Bottom Buttons -->
<div id="bottomAction" style="display:flex;border-top:1px solid #ddd;">
  <button onclick="handleGenerate()" style="flex:1;padding:14px;">ç”Ÿæˆç»ƒä¹ </button>
  <button onclick="enableCustomCloze()" style="flex:1;padding:14px;">æ‰‹åŠ¨æŒ–ç©º</button>
  <button onclick="startTypingMode()" style="flex:1;padding:14px;background:#42a5f5;color:white;">
    è·Ÿæ‰“æ¨¡å¼
  </button>
</div>

<!-- Footer -->
<div id="footerSection" class="footer-bar">
  <span onclick="toggleLanguage()" style="cursor:pointer;">ğŸŒ EN/ä¸­æ–‡</span>
  <span onclick="openLoginModal()" id="loginBtnLabel" style="cursor:pointer;color:#42a5f5;">
    ğŸ‘¤ ç™»å½•/åŒæ­¥
  </span>
</div>

</div>

<!-- ===================== Core Script ===================== -->
<script>
/* ---------------- Global State ---------------- */
let answers = [];
let currentLang = "zh";

window.customIndices = [];
window.currentCID = null;
window.currentUser = null;

/* ---------------- Cloze Generate ---------------- */
function generateCloze(text){
  let index=0;
  answers=[];

  return text.replace(/[a-zA-Z]+|[\u4e00-\u9fa5]/g,(w)=>{
    index++;
    if(index%4===1){
      let id=answers.length;
      answers.push(w);
      return `<input data-id="${id}" autocomplete="off">`;
    }
    return w;
  });
}

function handleGenerate(){
  const text=inputText.value.trim();
  if(!text) return;

  clozeContent.innerHTML=generateCloze(text);

  hideMainUI();
  clozeDisplay.classList.add("active");

  submitBtn.style.display="block";
}

/* ---------------- Score ---------------- */
function calculateScore(){
  const inputs=document.querySelectorAll("#clozeContent input");
  let correct=0;

  inputs.forEach(inp=>{
    let ans=answers[inp.dataset.id];
    if(inp.value.trim().toLowerCase()===ans.toLowerCase()){
      correct++;
      inp.style.border="2px solid #43a047";
    }else{
      inp.style.border="2px solid var(--danger)";
    }
  });

  let score=Math.round(correct/inputs.length*100);
  scoreResult.innerHTML=`å¾—åˆ†: ${score}% (${correct}/${inputs.length})`;
}

/* ---------------- Typing Mode ---------------- */
let typingIndex=0;
let rawTextArray=[];
window.typingModeActive=false;

function startTypingMode(){
  const text=inputText.value.trim();
  if(!text) return;

  rawTextArray=text.split("");
  typingIndex=0;
  window.typingModeActive=true;

  clozeContent.innerHTML=
    `<div class="typing-container" id="typeBox"></div>`;

  const typeBox=document.getElementById("typeBox");
  typeBox.innerHTML=rawTextArray.map((c,i)=>{
    let d=(c===" "?"&nbsp;":c);
    return `<span id="char-${i}">${d}</span>`;
  }).join("");

  hideMainUI();
  clozeDisplay.classList.add("active");
  submitBtn.style.display="none";

  focusTyping();
  updateTypingCursor();

  hiddenInput.oninput=(e)=>{
    let v=e.target.value;
    if(v){
      handleTypingChar(v.slice(-1));
      e.target.value="";
    }
  };

  hiddenInput.onkeydown=(e)=>{
    if(e.key==="Enter") handleTypingChar("\n");
  };
}

function focusTyping(){
  hiddenInput.focus({preventScroll:true});
}

function handleTypingChar(ch){
  if(typingIndex>=rawTextArray.length) return;

  let target=rawTextArray[typingIndex];
  let el=document.getElementById(`char-${typingIndex}`);

  if(ch.toLowerCase()===target.toLowerCase()){
    el.className="char-correct";
    typingIndex++;
    updateTypingCursor();
  }else{
    el.className="char-wrong";
  }

  if(typingIndex>=rawTextArray.length){
    alert("ğŸ‰ è·Ÿæ‰“å®Œæˆï¼");
    exitExercise();
  }
}

function updateTypingCursor(){
  document.querySelectorAll(".char-current")
    .forEach(e=>e.classList.remove("char-current"));

  let el=document.getElementById(`char-${typingIndex}`);
  if(el){
    el.classList.add("char-current");
    el.scrollIntoView({block:"center"});
  }
}

/* ---------------- Manual Cloze ---------------- */
function enableCustomCloze(){
  const text=inputText.value.trim();
  if(!text) return;

  let words=text.split(/\s+/);
  answers=[];

  clozeContent.innerHTML=words.map((w,i)=>{
    if(customIndices.includes(i)){
      answers.push(w);
      return `<input data-id="${answers.length-1}" data-index="${i}">`;
    }
    return `<span class="word-span" data-index="${i}"
            style="cursor:pointer;padding:2px;">${w}</span>`;
  }).join(" ");

  hideMainUI();
  clozeDisplay.classList.add("active");

  bindCustomEvents();
}

function bindCustomEvents(){
  document.querySelectorAll(".word-span").forEach(span=>{
    span.onclick=()=>{
      let idx=parseInt(span.dataset.index);
      if(!customIndices.includes(idx)){
        customIndices.push(idx);
        save();
        enableCustomCloze();
      }
    };
  });

  document.querySelectorAll("#clozeContent input").forEach(inp=>{
    let timer=null;

    inp.ontouchstart=()=>{
      timer=setTimeout(()=>{
        let idx=parseInt(inp.dataset.index);
        customIndices=customIndices.filter(x=>x!==idx);
        save();
        enableCustomCloze();
      },800);
    };

    inp.ontouchend=()=>clearTimeout(timer);
  });
}

/* ---------------- Save + Sync ---------------- */
function save(){
  if(!currentCID) return;
  localStorage.setItem("cloze_"+currentCID,JSON.stringify(customIndices));

  if(currentUser && window.syncCardToCloud){
    syncCardToCloud(customIndices);
  }
}

/* ---------------- Exit Exercise (å”¯ä¸€) ---------------- */
function exitExercise(){
  window.typingModeActive=false;

  hiddenInput.oninput=null;
  hiddenInput.onkeydown=null;

  showMainUI();
  clozeDisplay.classList.remove("active");
}

/* ---------------- UI Helpers ---------------- */
function hideMainUI(){
  topSection.classList.add("hidden");
  bottomAction.classList.add("hidden");
  footerSection.classList.add("hidden");
  inputText.classList.add("hidden");
}

function showMainUI(){
  topSection.classList.remove("hidden");
  bottomAction.classList.remove("hidden");
  footerSection.classList.remove("hidden");
  inputText.classList.remove("hidden");
}

/* ---------------- Language ---------------- */
function toggleLanguage(){
  currentLang=(currentLang==="zh"?"en":"zh");
  alert("åˆ‡æ¢è¯­è¨€: "+currentLang);
}

/* ---------------- Init Anki ---------------- */
(function init(){
  const params=new URLSearchParams(location.search);
  if(params.get("cid")){
    currentCID=params.get("cid");
    customIndices=JSON.parse(localStorage.getItem("cloze_"+currentCID)||"[]");
  }
})();
</script>

<!-- ================= Firebase Sync ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

const firebaseConfig={
  apiKey:"AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
  authDomain:"cloze-master-pro.firebaseapp.com",
  databaseURL:"https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"cloze-master-pro"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const auth=getAuth(app);
const provider=new GoogleAuthProvider();

/* Google Login */
window.openLoginModal=async()=>{
  const result=await signInWithPopup(auth,provider);
  console.log("ç™»å½•æˆåŠŸ:",result.user.email);
};

onAuthStateChanged(auth,user=>{
  window.currentUser=user;
  if(user){
    loginBtnLabel.innerText="âœ… å·²åŒæ­¥";
    loginBtnLabel.style.color="#43a047";

    if(window.currentCID){
      const cardRef=ref(db,`users/${user.uid}/clozes/${window.currentCID}`);
      onValue(cardRef,snap=>{
        if(snap.exists()){
          window.customIndices=snap.val();
          if(clozeDisplay.classList.contains("active")){
            enableCustomCloze();
          }
        }
      });
    }
  }
});

/* Sync Function (å”¯ä¸€) */
window.syncCardToCloud=async(indices)=>{
  if(!window.currentUser||!window.currentCID) return;
  const path=`users/${window.currentUser.uid}/clozes/${window.currentCID}`;
  await set(ref(db,path),indices);
  console.log("â˜ï¸ å·²åŒæ­¥äº‘ç«¯");
};
</script>

</body>
</html>
