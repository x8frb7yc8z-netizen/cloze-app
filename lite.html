<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI æ„ç¾¤åŒæ­¥æ’­æ”¾å™¨ - White Edition</title>
    <style>
        /* --- 1. å…¨å±€å¸ƒå±€é”å®š --- */
        html, body {
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #ffffff;
            -webkit-overflow-scrolling: touch;
        }

        :root {
            --primary: #007aff; 
            --text-main: #1d1d1f;
            --text-dim: #86868b;
            --bg: #ffffff;
            --active-bg: #f5f5f7;
        }

        body {
            font-family: -apple-system, "SF Pro Display", "PingFang SC", sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* éšè—é¡¶éƒ¨å†—ä½™çŠ¶æ€æ  */
        .header { height: 0; padding: 0; border: none; overflow: hidden; }

        /* --- 2. è§†é¢‘åŒºåŸŸ --- */
        .video-wrapper {
            flex: 0 0 auto;
            background: #000;
            width: 100%;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        video {
            width: 100%;
            max-height: 40vh;
            display: block;
        }

        /* --- 3. å­—å¹•å®¹å™¨ --- */
        .transcript-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px 0; /* ä¸Šä¸‹ç•™ç™½ï¼Œå·¦å³ 0 ç¡®ä¿æ–‡å­—è´´è¾¹ */
            scroll-behavior: smooth;
        }

        /* --- 4. æ„ç¾¤æ ·å¼ï¼šåŸæ–‡ä¸ç¿»è¯‘åˆ†å±‚ --- */
        .line {
            padding: 20px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-bottom: 1px solid #f9f9f9;
        }

        .content-en {
            font-size: 24px;
            line-height: 1.4;
            font-weight: 400;
            color: var(--text-main);
            margin-bottom: 6px;
            max-width: 100%;
            word-wrap: break-word;
        }

        .content-zh {
            font-size: 16px;
            color: var(--text-dim);
            font-weight: 400;
        }

        /* æ¿€æ´»æ€ */
        .line.active {
            background: var(--active-bg);
        }
        .line.active .content-en {
            color: var(--primary);
            font-weight: 600;
            transform: scale(1.02);
        }
        .line.active .content-zh {
            color: #424245;
        }

        /* ä¸Šä¼ æŒ‰é’® - æ‚¬æµ®åŠé€æ˜ */
        .btn-upload {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 200;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(8px);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        .btn-upload:hover { opacity: 1; }
        input[type="file"] { display: none; }

        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: var(--text-dim);
        }
    </style>
</head>
<body>

<label class="btn-upload">ğŸ“<input type="file" id="videoInput" accept="video/*"></label>

<div class="main-content">
    <div class="video-wrapper">
        <video id="videoPlayer" controls playsinline></video>
    </div>

    <div class="transcript-container" id="transcript">
        <div class="empty-state">
            <p>è¯·åœ¨ Anki ä¸­å¡«å†™â€œå­—å¹•å†…å®¹â€<br>æˆ–æ‰‹åŠ¨ä¸Šä¼ è§†é¢‘</p>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('videoPlayer');
    const transcript = document.getElementById('transcript');
    const noteId = "{{Note ID}}"; // æ ¸å¿ƒï¼šç»‘å®š Anki å¡ç‰‡ ID

    // --- 1. è¿›åº¦è®°å½•é€»è¾‘ ---
    function getStorageKey() {
        return `anki_reader_pos_${noteId}`;
    }

    function saveProgress() {
        const activeLine = document.querySelector('.line.active');
        const progress = {
            scrollPos: transcript.scrollTop,
            activeTime: activeLine ? activeLine.dataset.time : null,
            timestamp: Date.now()
        };
        localStorage.setItem(getStorageKey(), JSON.stringify(progress));
    }

    function restoreProgress() {
        const data = localStorage.getItem(getStorageKey());
        if (!data) return;
        
        const progress = JSON.parse(data);
        
        // æ¢å¤é«˜äº®
        if (progress.activeTime) {
            const target = document.querySelector(`.line[data-time="${progress.activeTime}"]`);
            if (target) target.classList.add('active');
        }
        
        // æ¢å¤æ»šåŠ¨ä½ç½®
        setTimeout(() => {
            transcript.scrollTop = progress.scrollPos;
        }, 100);
    }

    // --- 2. è§†é¢‘ä¸æ–‡ä»¶å¤„ç† ---
    document.getElementById('videoInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            video.src = URL.createObjectURL(file);
        }
    });

    // --- 3. å­—å¹•è§£æé€»è¾‘ (æ”¯æŒ æ„ç¾¤ / ç¿»è¯‘ æ ¼å¼) ---
    function parseSubtitle(data) {
        let cleanData = data.replace(/<br\s*\/?>/gi, "\n")
                            .replace(/<\/p>|<\/div>/gi, "\n")
                            .replace(/<\/?[^>]+(>|$)/g, "");

        const doc = new DOMParser().parseFromString(cleanData, 'text/html');
        cleanData = doc.documentElement.textContent;

        const cues = [];
        const lines = cleanData.split('\n').map(l => l.trim()).filter(l => l !== "");

        for (let i = 0; i < lines.length; i++) {
            const timeMatch = lines[i].match(/(\d{1,2}:\d{2}:\d{2}[.,]\d{3})\s*-->\s*(\d{1,2}:\d{2}:\d{2}[.,]\d{3})/);
            if (timeMatch) {
                const start = timeToSeconds(timeMatch[1]);
                let textParts = [];
                let j = i + 1;
                while (j < lines.length && !lines[j].match(/-->/)) {
                    textParts.push(lines[j]);
                    j++;
                }
                
                const fullText = textParts.join(' ');
                let en = fullText, zh = "";
                
                // è‡ªåŠ¨è¯†åˆ«åˆ†éš”ç¬¦ï¼ˆå…¼å®¹ / æˆ– æ¢è¡Œï¼‰
                if (fullText.includes(' / ')) {
                    [en, zh] = fullText.split(' / ');
                } else if (textParts.length >= 2) {
                    en = textParts[0];
                    zh = textParts.slice(1).join(' ');
                }

                if (en) cues.push({ start, en, zh });
                i = j - 1;
            }
        }
        return cues;
    }

    function timeToSeconds(timeStr) {
        const parts = timeStr.trim().replace(',', '.').split(':');
        return (+parts[0]) * 3600 + (+parts[1]) * 60 + (+parts[2]);
    }

    function renderSubtitles(cues) {
        transcript.innerHTML = '';
        cues.forEach(cue => {
            const div = document.createElement('div');
            div.className = 'line';
            div.dataset.time = cue.start;
            div.innerHTML = `
                <div class="content-en">${cue.en}</div>
                ${cue.zh ? `<div class="content-zh">${cue.zh}</div>` : ''}
            `;
            
            div.onclick = () => {
                video.currentTime = cue.start;
                video.play();
                document.querySelector('.line.active')?.classList.remove('active');
                div.classList.add('active');
                saveProgress();
            };
            transcript.appendChild(div);
        });
        restoreProgress(); // æ¸²æŸ“åæ¢å¤è¿›åº¦
    }

    // --- 4. ç›‘å¬ä¸åŒæ­¥ ---
    // ç›‘å¬æ»šåŠ¨ä¿å­˜ä½ç½®
    let scrollTimeout;
    transcript.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(saveProgress, 500);
    });

    // è§†é¢‘åŒæ­¥é«˜äº®
    video.addEventListener('timeupdate', () => {
        const currentTime = video.currentTime;
        const lines = document.querySelectorAll('.line');
        lines.forEach((line, i) => {
            const start = parseFloat(line.dataset.time);
            const next = lines[i+1] ? parseFloat(lines[i+1].dataset.time) : Infinity;
            if (currentTime >= start && currentTime < next) {
                if (!line.classList.contains('active')) {
                    document.querySelector('.line.active')?.classList.remove('active');
                    line.classList.add('active');
                    line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    saveProgress();
                }
            }
        });
    });

    // å¤„ç†æ¥è‡ª Anki çš„æ¶ˆæ¯
    window.addEventListener('message', (event) => {
        if (event.data.type === 'LOAD_SUBTITLES') {
            const cues = parseSubtitle(event.data.data);
            renderSubtitles(cues);
        }
    });

    // é€šçŸ¥ Anki å·²å°±ç»ª
    window.parent.postMessage({ type: 'PLAYER_READY' }, '*');
</script>
</body>
</html>
