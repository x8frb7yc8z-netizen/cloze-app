<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI æ„ç¾¤åŒæ­¥æ’­æ”¾å™¨ - White Edition Pro</title>
    <style>
        /* --- å…¨å±€é”å®šä¸ iOS ä¼˜åŒ– --- */
        html, body { 
            width: 100%; margin: 0; padding: 0; 
            overflow: hidden; /* ç”±å®¹å™¨æ§åˆ¶æ»šåŠ¨ */
            background: #ffffff;
            -webkit-overflow-scrolling: touch; 
        }

        :root {
            --primary: #00a1d6;
            --primary-light: rgba(0, 161, 214, 0.08);
            --text-main: #1d1d1f;
            --text-dim: #86868b;
        }

        body {
            font-family: -apple-system, "SF Pro Display", sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- è§†é¢‘åŒºåŸŸ --- */
        .video-wrapper {
            flex: 0 0 auto;
            background: #000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 10;
        }
        video {
            max-height: 40vh; /* ç¨å¾®ç¼©å°è§†é¢‘é«˜åº¦ï¼Œç»™å­—å¹•ç•™ç©ºé—´ */
            width: 100%;
            display: block;
        }

        /* --- å­—å¹•åŒºåŸŸ --- */
        .transcript-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px 0; /* ä¸Šä¸‹ç•™ç™½ï¼Œå®ç°æ»šåŠ¨å±…ä¸­æ„Ÿ */
            background: #ffffff;
            scroll-behavior: smooth;
        }

        .line {
            padding: 18px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .line.active {
            color: var(--primary);
            transform: scale(1.04);
        }

        .content {
            line-height: 1.5;
            font-size: 24px;
            font-weight: 400;
            color: var(--text-main);
            max-width: 90%;
        }

        .line.active .content {
            font-weight: 600;
            color: #000;
        }

        /* çŠ¶æ€æ¡ */
        #status-bar {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 10px;
            color: var(--text-dim);
            background: rgba(255,255,255,0.7);
            padding: 2px 6px;
            border-radius: 4px;
            pointer-events: none;
            z-index: 100;
        }

        .btn-upload {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 200;
            opacity: 0.3;
            font-size: 20px;
            cursor: pointer;
        }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div id="status-bar">å‡†å¤‡å°±ç»ª...</div>
<label class="btn-upload">ğŸ“<input type="file" id="videoInput" accept="video/*"></label>

<div class="video-wrapper">
    <video id="videoPlayer" controls playsinline webkit-playsinline></video>
</div>

<div class="transcript-container" id="transcript">
    <div style="text-align: center; color: #86868b; margin-top: 50px;">
        ç­‰å¾… Anki ä¼ è¾“æ•°æ®...
    </div>
</div>



<script type="module">
import { getDatabase, ref, get, set, child, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// --- 1. Firebase åˆå§‹åŒ– ---
const firebaseConfig = {
    apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
    authDomain: "cloze-master-pro.firebaseapp.com",
    projectId: "cloze-master-pro"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app); // æ¢æˆ getDatabase

const video = document.getElementById('videoPlayer');
const transcript = document.getElementById('transcript');
const statusBar = document.getElementById('status-bar');

let currentNoteId = null;
let isAutoScrolling = false;
let lastSaveTime = 0;
// --- 2. å­—å¹•å¤„ç†é€»è¾‘ ---
function timeToSeconds(t) {
    if (!t) return 0;
    const p = t.replace(',', '.').trim().split(':');
    if (p.length === 3) {
        return (+p[0]) * 3600 + (+p[1]) * 60 + (+p[2]);
    }
    return (+p[0]) * 60 + (+p[1]);
}

function parseSubtitle(data) {
    if (!data) return [];

    // 1. å¤„ç† Anki å¯èƒ½å­˜åœ¨çš„ HTML è½¬ä¹‰å’Œæ ‡ç­¾æ±¡æŸ“
    const doc = new DOMParser().parseFromString(data, 'text/html');
    let cleanData = doc.documentElement.textContent;

    cleanData = cleanData.replace(/<br\s*\/?>/gi, "\n")
                         .replace(/<\/p>|<\/div>/gi, "\n")
                         .replace(/<\/?[^>]+(>|$)/g, "");

    // 2. åŒ¹é…æ—¶é—´è½´ï¼ˆå…¼å®¹æ ‡å‡† --> å’Œè½¬ä¹‰åçš„ --&gt;ï¼‰
    const lines = cleanData.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
    const cues = [];

    for (let i = 0; i < lines.length; i++) {
        const timeMatch = lines[i].match(/(\d{1,2}:\d{2}:\d{2}[.,]\d{3})\s*(?:-->|--&gt;)\s*(\d{1,2}:\d{2}:\d{2}[.,]\d{3})/);
        
        if (timeMatch) {
            const start = timeToSeconds(timeMatch[1]);
            let textParts = [];
            let j = i + 1;
            while (j < lines.length && !lines[j].match(/-->|--&gt;/)) {
                textParts.push(lines[j]);
                j++;
            }
            const text = textParts.join(' ');
            if (text) {
                cues.push({ start, text });
            }
            i = j - 1;
        }
    }

    console.log("è§£ææˆåŠŸï¼Œæ¡æ•°:", cues.length);
    return cues;
}

function renderSubtitles(cues) {
    transcript.innerHTML = '';
    if (cues.length === 0) {
        transcript.innerHTML = '<div style="text-align:center; padding:20px;">å­—å¹•è§£æå¤±è´¥æˆ–ä¸ºç©º</div>';
        return;
    }
    cues.forEach((cue, index) => {
        const div = document.createElement('div');
        div.className = 'line';
        div.dataset.time = cue.start;
        div.dataset.index = index;
        div.innerHTML = `<div class="content">${cue.text}</div>`;
        div.onclick = () => {
            video.currentTime = cue.start;
            video.play();
        };
        transcript.appendChild(div);
    });
}

// --- 3. è¿›åº¦ä¿å­˜ä¸æ¢å¤ ---
// --- 3. è¿›åº¦ä¿å­˜ä¸æ¢å¤ (Realtime Database ç‰ˆæœ¬) ---
async function fetchProgress(noteId) {
    if (!noteId) return;
    try {
        const dbRef = ref(db);
        const snapshot = await get(child(dbRef, `progress/${noteId}`));
        if (snapshot.exists()) {
            const data = snapshot.val();
            video.currentTime = data.lastTime || 0;
            
            setTimeout(() => {
                const target = document.querySelector(`.line[data-index="${data.lastIndex}"]`);
                if (target) {
                    isAutoScrolling = true;
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => isAutoScrolling = false, 1000);
                }
            }, 300);
        }
    } catch (e) { console.error("è¯»å–è¿›åº¦å¤±è´¥", e); }
}

async function saveProgress(noteId, time, index) {
    if (!noteId) return;
    const now = Date.now();
    if (now - lastSaveTime < 2500) return; 

    lastSaveTime = now;
    try {
        // ä½¿ç”¨ ref(db, 'è·¯å¾„') å†™å…¥
        await set(ref(db, 'progress/' + noteId), {
            lastTime: time,
            lastIndex: index,
            updatedAt: serverTimestamp() // æ³¨æ„ï¼šRTDB çš„ serverTimestamp ä¹Ÿæ˜¯å¯ç”¨çš„
        });
        
        statusBar.innerText = "åŒæ­¥å®Œæˆ: " + new Date().toLocaleTimeString();
        console.log("âœ… RTDB å†™å…¥æˆåŠŸ");
    } catch (e) { 
        console.error("âŒ RTDB å†™å…¥å¤±è´¥:", e); 
    }
}

// --- 4. äº‹ä»¶ç›‘å¬ ---
// ç›‘å¬æœ¬åœ°æ–‡ä»¶ä¸Šä¼ 
document.getElementById('videoInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) video.src = URL.createObjectURL(file);
});

// ç›‘å¬ Anki æ¶ˆæ¯
window.addEventListener('message', (event) => {
    if (event.data.type === 'LOAD_SUBTITLES') {
        currentNoteId = event.data.noteId;
        const cues = parseSubtitle(event.data.data);
        renderSubtitles(cues);
        fetchProgress(currentNoteId);
        statusBar.innerText = "å·²åŠ è½½å¡ç‰‡: " + currentNoteId;
    }
});

// è§†é¢‘è¿›åº¦è”åŠ¨
// è§†é¢‘è¿›åº¦è”åŠ¨
video.addEventListener('timeupdate', () => {
    const lines = document.querySelectorAll('.line');
    const currentTime = video.currentTime;

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const start = parseFloat(line.dataset.time);
        const next = lines[i+1] ? parseFloat(lines[i+1].dataset.time) : Infinity;

        if (currentTime >= start && currentTime < next) {
            if (!line.classList.contains('active')) {
                // 1. åˆ‡æ¢é«˜äº®
                document.querySelector('.line.active')?.classList.remove('active');
                line.classList.add('active');

                // 2. è§¦å‘ä¿å­˜ (ä¸å—æ»šåŠ¨é”å½±å“)
                // åªè¦ noteId å­˜åœ¨ä¸”é«˜äº®è¡Œåˆ‡æ¢äº†ï¼Œå°±è¿›å…¥ saveProgress (å†…éƒ¨æœ‰ 2.5s èŠ‚æµ)
                if (currentNoteId) {
                    saveProgress(String(currentNoteId), currentTime, i);
                }

                // 3. è§¦å‘è‡ªåŠ¨æ»šåŠ¨ (å—æ»šåŠ¨é”å½±å“ï¼Œé˜²æ­¢å¾ªç¯è§¦å‘)
                if (!isAutoScrolling) {
                    isAutoScrolling = true;
                    line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // ç¼©çŸ­é”å®šæ—¶é—´ï¼Œæé«˜çµæ•åº¦
                    setTimeout(() => isAutoScrolling = false, 800);
                }
            }
            break; 
        }
    }
});

// å‘ŠçŸ¥å®¿ä¸»å‡†å¤‡å¥½äº†
window.parent.postMessage({ type: 'PLAYER_READY' }, '*');
</script>
</body>
</html>
