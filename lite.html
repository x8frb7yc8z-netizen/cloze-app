<div id="video-container">
    <video id="ankiVideo" playsinline controls width="100%" poster=""></video>
    <div id="status-bar">
        <span id="load-status">æ­£åœ¨æ‰«æåª’ä½“åº“...</span>
        <button id="manual-btn" onclick="document.getElementById('fileInput').click()">æ‰‹åŠ¨å…³è”è§†é¢‘</button>
    </div>
    <input type="file" id="fileInput" accept="video/*" style="display:none">
</div>

<div id="script-display">
    </div>

<style>
    :root { --accent: #34c759; --bg: #ffffff; }
    body { font-family: -apple-system, system-ui, sans-serif; padding: 15px; background: var(--bg); color: #333; }
    
    /* è§†é¢‘æ ·å¼ */
    #video-container { position: sticky; top: 0; background: var(--bg); z-index: 100; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    video { width: 100%; border-radius: 10px; background: #000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    
    /* çŠ¶æ€æ¡ */
    #status-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 11px; color: #888; }
    #manual-btn { padding: 4px 8px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; color: #666; }

    /* å‰§æœ¬æ ·å¼ */
    #script-display { margin-top: 20px; }
    .sentence-row { display: flex; margin-bottom: 18px; align-items: flex-start; }
    .time-anchor { font-size: 12px; color: #bbb; min-width: 45px; padding-top: 4px; cursor: pointer; transition: color 0.2s; }
    .time-anchor:active { color: var(--accent); }
    
    /* å•è¯æ ·å¼ */
    .word-span { font-size: 19px; cursor: pointer; padding: 2px 4px; border-radius: 4px; display: inline-block; transition: all 0.1s; }
    .word-span:active { background: #e8e8e8; transform: scale(0.95); }
    .cloze-mode .word-span.is-cloze { color: var(--accent); font-weight: 600; border-bottom: 2px solid var(--accent); }
</style>

<script>
    // --- 1. æ•°æ®é…ç½® ---
    const v = document.getElementById('ankiVideo');
    const status = document.getElementById('load-status');
    const display = document.getElementById('script-display');
    
    const videoFileName = "{{VideoName}}".trim(); // å­—æ®µï¼šLost_S01E01.mp4
    const rawData = `{{TimestampText}}`;           // å­—æ®µï¼š[00:01.20] Text...
    const nid = "{{nid}}";                         // å­—æ®µï¼šå”¯ä¸€ç¬”è®°ID

    // --- 2. è§†é¢‘åŠ è½½é€»è¾‘ (å…³é”®) ---
    function initVideo() {
        if (!videoFileName) {
            status.innerText = "âŒ æœªæŒ‡å®šè§†é¢‘æ–‡ä»¶å";
            return;
        }

        v.src = videoFileName; // Anki å†…éƒ¨è‡ªåŠ¨æ˜ å°„ collection.media
        v.load();

        v.onloadedmetadata = () => {
            status.innerText = `âœ… å·²åŠ è½½: ${videoFileName}`;
            status.style.color = "#34c759";
            restoreProgress(); // åŠ è½½æˆåŠŸåæ¢å¤è¿›åº¦
        };

        v.onerror = () => {
            status.innerText = "âŒ è‡ªåŠ¨åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•æ‰‹åŠ¨å…³è”";
            status.style.color = "#ff3b30";
        };
    }

    // --- 3. å‰§æœ¬æ¸²æŸ“é€»è¾‘ ---
    function render() {
        // æŒ‰æ—¶é—´æˆ³åˆ‡å‰²å¥å­
        const segments = rawData.split(/(?=\[\d{2}:\d{2}\.\d{2}\])/g);
        
        display.innerHTML = segments.map(seg => {
            const timeMatch = seg.match(/\[(\d{2}):(\d{2})\.(\d{2})\]/);
            if (!timeMatch) return "";
            
            // è®¡ç®—ç§’æ•°ä½œä¸ºè·³è½¬åæ ‡
            const sec = parseInt(timeMatch[1]) * 60 + parseInt(timeMatch[2]) + parseInt(timeMatch[3]) / 100;
            const cleanText = seg.replace(/\[.*?\]/g, "").trim();
            const words = cleanText.split(/\s+/);

            return `
                <div class="sentence-row">
                    <div class="time-anchor" onclick="seek(${sec})">${timeMatch[1]}:${timeMatch[2]}</div>
                    <div class="words-wrapper">
                        ${words.map(w => `<span class="word-span" data-time="${sec}">${w}</span>`).join("")}
                    </div>
                </div>
            `;
        }).join("");
    }

    // --- 4. äº¤äº’ï¼šå•å‡»è·³è½¬/å¤åˆ¶ï¼ŒåŒå‡»æœå›¾ ---
    display.onclick = (e) => {
        if (!e.target.classList.contains('word-span')) return;
        const word = e.target.innerText.replace(/[^\w]/g, "");
        
        // å¤åˆ¶å•è¯
        navigator.clipboard.writeText(word);
        // æ‰§è¡Œè·³è½¬
        seek(parseFloat(e.target.dataset.time));
    };

    display.ondblclick = (e) => {
        if (!e.target.classList.contains('word-span')) return;
        const word = e.target.innerText;
        const sentence = e.target.closest('.sentence-row').innerText.replace(/\d{2}:\d{2}/, "");
        
        navigator.clipboard.writeText(sentence); // å¤åˆ¶æ•´å¥
        window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(word)}`); // æœå›¾
    };

    function seek(time) {
        v.currentTime = time;
        v.play();
    }

    // --- 5. è¿›åº¦è®°å¿†é€»è¾‘ ---
    function saveProgress() {
        const time = v.currentTime;
        if (time > 0) {
            localStorage.setItem(`progress_${nid}`, time); // å…ˆå­˜æœ¬åœ°
            // æ­¤å¤„å¯æ‰©å±•ï¼šfirebase.database().ref('progress/'+nid).set(time);
            console.log("è¿›åº¦å·²ä¿å­˜:", time);
        }
    }

    function restoreProgress() {
        const saved = localStorage.getItem(`progress_${nid}`);
        if (saved) {
            v.currentTime = parseFloat(saved);
        }
    }

    // å®šæ—¶ä¿å­˜è¿›åº¦ & æš‚åœæ—¶ä¿å­˜
    v.onpause = saveProgress;
    setInterval(() => { if(!v.paused) saveProgress(); }, 5000);

    // æ‰‹åŠ¨å…³è”å¤‡ä»½
    document.getElementById('fileInput').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            v.src = URL.createObjectURL(file);
            status.innerText = `ğŸ”µ æ‰‹åŠ¨å…³è”: ${file.name}`;
            v.play();
        }
    };

    // æ‰§è¡Œå¯åŠ¨
    render();
    setTimeout(initVideo, 200);
</script>
