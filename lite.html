
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>æç®€å®Œå½¢å¡«ç©º Pro</title>
<style>
:root { --primary: #43a047; --bg: #f8f9fa; --danger: #ff5252; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; width:100%; height:100dvh; font-family:-apple-system, sans-serif; background:#fff; overflow:hidden; }

.app-container { display:flex; flex-direction:column; height:100%; }
.header { display:flex; align-items:center; justify-content:space-between; padding:10px 15px; background:var(--bg); border-bottom:1px solid #ddd; }
.btn-group { display:flex; align-items:center; gap:8px; }
.small-btn { border:1px solid #ccc; background:#fff; padding:5px 10px; border-radius:6px; cursor:pointer; font-weight:bold; }

.main-area { flex:1; position:relative; overflow:hidden; }
textarea { width:100%; height:100%; padding:20px; border:none; outline:none; font-size:18px; line-height:1.6; resize:none; }

.cloze-display { 
    position:absolute; top:0; left:0; width:100%; height:100%; 
    background:#fff; display:none; overflow-y:auto; padding:20px; 
    line-height:2; z-index:10; padding-bottom:100px;
}
.cloze-display.active { display:block; }
.cloze-display input { 
    min-width:4ch; border:none; border-bottom:1.5px solid #666; 
    background:#fffde7; text-align:center; font-size:inherit; border-radius:0; outline:none;
}

.footer-actions { display:flex; border-top:1px solid #ddd; background:#fff; }
.footer-actions button { flex:1; padding:15px; border:none; font-weight:bold; cursor:pointer; font-size:15px; }
.btn-primary { background:var(--primary); color:white; }
.btn-danger { color:var(--danger); background:#fff8f8; }

.word-span { cursor:pointer; border-radius:3px; padding: 0 2px; }
.word-span:hover { background:#e8f5e9; }
.hidden { display:none !important; }
</style>
</head>

<body>
<div class="app-container">
    <header class="header" id="headerSection">
        <span style="font-weight:bold; color:var(--primary);">Cloze Master Lite</span>
        <div class="btn-group">
            <button class="small-btn" onclick="changeFontSize(-2)">A-</button>
            <span id="fontSizeLabel">20</span>
            <button class="small-btn" onclick="changeFontSize(2)">A+</button>
        </div>
    </header>

    <main class="main-area">
        <textarea id="inputText" placeholder="åœ¨æ­¤ç²˜è´´æ–‡ç« å†…å®¹..."></textarea>
        <div id="clozeDisplay" class="cloze-display">
            <button onclick="exitExercise()" style="margin-bottom:20px; padding:8px 15px; border-radius:5px; border:1px solid #ccc; cursor:pointer;">â† è¿”å›ä¿®æ”¹</button>
            <div id="clozeContent"></div>
        </div>
    </main>

    <nav class="footer-actions" id="footerActions">
        <button class="btn-danger" onclick="handleClear()">æ¸…ç©º</button>
        <button onclick="handlePaste()" style="background:#f0f0f0;">ğŸ“‹ ç²˜è´´</button>
        <button class="btn-primary" onclick="startManualCloze()">å¼€å§‹ç»ƒä¹ </button>
    </nav>
</div>

<script>
let currentFontSize = 20;
let manualPositions = JSON.parse(localStorage.getItem('cloze_single_positions')) || [];
let answers = [];

const inputArea = document.getElementById('inputText');
const displayArea = document.getElementById('clozeDisplay');
const clozeContent = document.getElementById('clozeContent');

function init() { 
    const urlParams = new URLSearchParams(window.location.search);
    const textFromAnki = urlParams.get('text');

    if (textFromAnki) {
        const decodedText = decodeURIComponent(textFromAnki.replace(/\+/g, ' '));
        inputArea.value = decodedText;

        const sizeLabel = document.getElementById("sizeLabel");
        if (sizeLabel) sizeLabel.innerText = currentFontSize;
    }
}

function changeFontSize(delta) {
    currentFontSize += delta;
    if (currentFontSize < 12) currentFontSize = 12;
    inputArea.style.fontSize = displayArea.style.fontSize = currentFontSize + "px";
    document.getElementById('fontSizeLabel').innerText = currentFontSize;
}

function handleClear() {
    if (confirm("ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ")) {
        inputArea.value = "";
        manualPositions = [];
        saveContent();
        savePositions();
    }
}

async function handlePaste() {
    try {
        const text = await navigator.clipboard.readText();
        if (text) { inputArea.value = text; saveContent(); }
    } catch (err) { alert("ç²˜è´´å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰è¾“å…¥æ¡†ç²˜è´´"); }
}

function startManualCloze() {
    const text = inputArea.value.trim();
    if (!text) return alert("è¯·å…ˆè¾“å…¥å†…å®¹");
    saveContent();

    const regex = /([a-zA-Z]+|[\u4e00-\u9fa5]|[^\s\w\u4e00-\u9fa5]+)/g;
    const segments = text.split(regex);
    
    answers = [];
    let unitCount = 0;

    clozeContent.innerHTML = segments.map(seg => {
        if (!seg || !seg.trim()) return seg;
        const idx = unitCount++;
        const isChinese = /[\u4e00-\u9fa5]/.test(seg);

        if (manualPositions.includes(idx)) {
            answers.push(seg);
            return `<input data-id="${answers.length - 1}" data-index="${idx}" 
                    style="width:${isChinese ? 2 : seg.length + 1}ch;" 
                    oninput="validateInput(this)" onkeydown="handleSpaceKey(event, this)"
                    placeholder="${isChinese ? '?' : getHint(seg)}">`;
        }
        return `<span class="word-span" data-index="${idx}">${seg}</span>`;
    }).join("");

    displayArea.classList.add('active');
    document.getElementById('headerSection').classList.add('hidden');
    document.getElementById('footerActions').classList.add('hidden');
    bindEvents();
}

// --- æ ¸å¿ƒï¼šç©ºæ ¼è¡¥å…¨é€»è¾‘ ---
function handleSpaceKey(e, el) {
    // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹ç©ºæ ¼é”® (Code 32)
    if (e.code === 'Space' || e.keyCode === 32) {
        e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„ç©ºæ ¼è¾“å…¥
        const targetAns = answers[el.dataset.id];
        const currentVal = el.value;
        
        // å¦‚æœè¿˜æ²¡å¡«å®Œï¼Œå°±è¡¥å…¨ä¸‹ä¸€ä¸ªå­—ç¬¦
        if (currentVal.length < targetAns.length) {
            el.value = targetAns.substring(0, currentVal.length + 1);
            validateInput(el); // è§¦å‘æ ¡éªŒé€»è¾‘
        }
    }
}

function validateInput(el) {
    const ans = answers[el.dataset.id];
    const val = el.value.trim();
    
    // èƒŒæ™¯è‰²é€»è¾‘ï¼šå®Œå…¨æ­£ç¡®å˜ç»¿ï¼Œæœ‰è¾“å…¥ä½†æœªå®Œæˆä¸”æ­£ç¡®ä¿æŒé»„è‰²ï¼Œé”™è¯¯å˜çº¢
    if (val.toLowerCase() === ans.toLowerCase()) {
        el.style.backgroundColor = "#c8f7c5"; // ç»¿è‰²
        el.style.color = "#000";
    } else if (val === "") {
        el.style.backgroundColor = "#fffde7"; // é»˜è®¤é»„
    } else {
        // é”™å­—çº¢å­—é€»è¾‘ï¼šå¦‚æœå½“å‰è¾“å…¥çš„å¼€å¤´ä¸ç¬¦åˆæ­£ç¡®ç­”æ¡ˆï¼Œæ–‡å­—å˜çº¢
        const isMatch = ans.toLowerCase().startsWith(val.toLowerCase());
        el.style.color = isMatch ? "#000" : "var(--danger)";
        el.style.backgroundColor = isMatch ? "#fffde7" : "#f7c5c5";
    }
}

function bindEvents() {
    clozeContent.querySelectorAll('.word-span').forEach(el => {
        el.onclick = () => {
            manualPositions.push(parseInt(el.dataset.index));
            savePositions();
            startManualCloze();
        };
    });

    clozeContent.querySelectorAll('input').forEach(el => {
        let timer;
        const start = () => timer = setTimeout(() => {
            if(confirm("æ¢å¤æ˜¾ç¤ºï¼Ÿ")) {
                manualPositions = manualPositions.filter(i => i !== parseInt(el.dataset.index));
                savePositions();
                startManualCloze();
            }
        }, 800);
        el.ontouchstart = start; el.ontouchend = () => clearTimeout(timer);
        el.onmousedown = (ev) => { if(ev.button === 0) start(); };
        el.onmouseup = () => clearTimeout(timer);
    });
}

function getHint(w) {
    if (w.length <= 2) return w[0] + "_";
    return w[0] + "_".repeat(w.length - 2) + w[w.length-1];
}

function saveContent() { localStorage.setItem('cloze_single_content', inputArea.value); }
function savePositions() { localStorage.setItem('cloze_single_positions', JSON.stringify(manualPositions)); }

function exitExercise() {
    displayArea.classList.remove('active');
    document.getElementById('headerSection').classList.remove('hidden');
    document.getElementById('footerActions').classList.remove('hidden');
}

inputArea.oninput = saveContent;
</script>
</body>
</html>
