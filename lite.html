<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Cloze Master Lite (Anki)</title>
<style>
:root { --primary: #43a047; --bg-light: #f8f9fa; --danger: #ff5252; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; width:100%; height:100dvh; font-family:-apple-system, system-ui, sans-serif; background:#fff; color:#333; overflow:hidden; }
.app-container { display:flex; flex-direction:column; height:100%; width:100%; }
.hidden { display:none !important; }

/* 顶部控制栏 */
.header-controls { 
    display:flex; align-items:center; justify-content:space-between; 
    padding:10px 15px; background:var(--bg-light); border-bottom:1px solid #ddd; 
    flex-shrink:0; 
}
.small-btn { border:1px solid #ccc; background:#fff; padding:4px 10px; border-radius:4px; cursor:pointer; }

/* 文本区 */
.input-wrapper { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
textarea { flex:1; width:100%; padding:15px; border:none; outline:none; font-size:18px; line-height:1.6; resize:none; background:#fff; }

.cloze-display { 
    position:absolute; top:0; left:0; right:0; bottom:0; padding:15px; 
    white-space:pre-wrap; display:none; line-height:1.8; word-break:break-word; 
    background:#fff; height:100%; overflow-y:auto; -webkit-overflow-scrolling:touch;
    padding-bottom: 50vh !important;
}
.cloze-display.active { display:block; }
.cloze-display input { 
    min-width:3.6ch; border:none; border-bottom:1.5px solid #666; 
    background:#fffde7; text-align:center; color:#000; font-size:inherit; margin:0 2px;
}

/* 底部按钮 */
.action-bar { display:flex; width:100%; border-top:1px solid #ddd; flex-shrink:0; background:#fff; padding-bottom: env(safe-area-inset-bottom); }
.action-bar button { flex:1; padding:15px; border:none; font-weight:bold; font-size:14px; cursor:pointer; }
#generate { background:var(--primary); color:white; }
#typeModeBtn { background:#42a5f5; color:white; }

/* 跟打模式 */
#hiddenInput { position: fixed; bottom: -50px; left: 0; width: 1px; height: 1px; opacity: 0; }
.typing-container { font-family: monospace; color: #ccc; font-size: 24px; line-height: 1.6; }
.char-correct { color: #43a047; }
.char-wrong { color: #ff5252; background: #ffebee; }
.char-current { color: #333; border-bottom: 3px solid var(--primary); background: #e8f5e9; }
</style>
</head>

<body>
<div class="app-container">
    <div class="header-controls">
        <span style="font-weight:bold; color:var(--primary);">Anki Cloze</span>
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="small-btn" onclick="changeFontSize(-2)">A-</button>
            <span id="sizeLabel">18</span>
            <button class="small-btn" onclick="changeFontSize(2)">A+</button>
        </div>
        <div style="font-size: 13px;">
            间隔 <input id="nthWord" type="number" value="4" style="width:35px; text-align:center;"> 词
        </div>
    </div>

    <div class="input-wrapper">
        <textarea id="inputText" placeholder="等待 Anki 文本..."></textarea>
        <div id="clozeDisplay" class="cloze-display">
            <button onclick="exitExercise()" style="margin-bottom:15px; padding:8px 15px;">← 返回</button>
            <input type="text" id="hiddenInput" autocomplete="off">
            <div id="clozeContent"></div>
            <div id="scoreResult" style="margin-top:20px; text-align:center; font-weight:bold; color:var(--primary);"></div>
            <button id="submitBtn" onclick="calculateScore()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:8px; margin-top:20px;">提交评分</button>
        </div>
    </div>

    <div class="action-bar" id="bottomAction">
        <button onclick="handleClear()" style="color:var(--danger)">清空</button>
        <button id="generate" onclick="handleGenerate()">自动挖空</button>
        <button onclick="enableCustomCloze()" style="background:#f0f0f0;">手动挖空</button>
        <button id="typeModeBtn" onclick="startTypingMode()">跟打</button>
    </div>
</div>

<script>
let currentFontSize = 18;
let answers = [];
let typingIndex = 0;
let rawTextArray = [];
const inputArea = document.getElementById("inputText");
const displayArea = document.getElementById("clozeDisplay");
const clozeContent = document.getElementById("clozeContent");

// ---------------- Anki 初始化 ----------------
function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const textFromAnki = urlParams.get('text');
    if (textFromAnki) {
        const decodedText = decodeURIComponent(textFromAnki.replace(/\+/g, ' '));
        inputArea.value = decodedText;
        setTimeout(() => enableCustomCloze(), 150);
    }
}

// ---------------- 基础功能 ----------------
function changeFontSize(d) {
    currentFontSize += d;
    if(currentFontSize < 12) currentFontSize = 12;
    inputArea.style.fontSize = displayArea.style.fontSize = currentFontSize + "px";
    document.getElementById("sizeLabel").innerText = currentFontSize;
}

function handleClear() { if(confirm("确定清空？")) inputArea.value = ""; }

function exitExercise() {
    document.querySelector(".header-controls").classList.remove("hidden");
    document.getElementById("bottomAction").classList.remove("hidden");
    displayArea.classList.remove("active");
}

function getSmartHint(word) {
    if (!word || word.length <= 1) return "_";
    return word.length <= 4 ? word[0] + "_".repeat(word.length - 1) : word[0] + "_".repeat(word.length - 2) + word[word.length - 1];
}

// ---------------- 自动生成练习 ----------------
function handleGenerate() {
    if(!inputArea.value.trim()) return;
    const n = parseInt(document.getElementById("nthWord").value) || 4;
    let index = 0; answers = [];
    const regex = /\([^)]*\)|[a-zA-Z]+|[\u4e00-\u9fa5]/g;
    
    clozeContent.innerHTML = inputArea.value.replace(regex, (match) => {
        if (match.startsWith('(')) return `<span style="color:#999;font-style:italic;">${match}</span>`;
        index++;
        if(index % n === 1) {
            const id = answers.length;
            answers.push(match);
            return `<input data-id="${id}" style="width:${match.length+1}ch" placeholder="${getSmartHint(match)}" oninput="checkInput(this)" onkeydown="handleHint(event, this)">`;
        }
        return match;
    });
    
    showExerciseUI();
}

// ---------------- 手动挖空逻辑 ----------------
function enableCustomCloze() {
    const text = inputArea.value;
    if (!text) return;
    const regex = /([a-zA-Z]+|[\u4e00-\u9fa5]|[^\s\w\u4e00-\u9fa5]+)/g;
    const segments = text.split(regex);
    answers = [];
    let unitCount = 0;

    clozeContent.innerHTML = segments.map(seg => {
        if (!seg || !seg.trim()) return seg;
        const currentIdx = unitCount++;
        return `<span class="word-span" onclick="toggleCloze(this, '${seg}')">${seg}</span>`;
    }).join("");

    showExerciseUI();
}

function toggleCloze(el, word) {
    const id = answers.length;
    answers.push(word);
    const input = document.createElement("input");
    input.style.width = (word.length + 1) + "ch";
    input.placeholder = getSmartHint(word);
    input.dataset.id = id;
    input.oninput = () => checkInput(input);
    input.onkeydown = (e) => handleHint(e, input);
    el.parentNode.replaceChild(input, el);
}

// ---------------- 练习通用逻辑 ----------------
function showExerciseUI() {
    document.querySelector(".header-controls").classList.add("hidden");
    document.getElementById("bottomAction").classList.add("hidden");
    displayArea.classList.add("active");
    document.getElementById("scoreResult").innerHTML = "";
}

function checkInput(input) {
    const ans = answers[input.dataset.id].toLowerCase();
    const val = input.value.trim().toLowerCase();
    input.style.backgroundColor = val === ans ? "#c8f7c5" : (val ? "#f7c5c5" : "#fffde7");
    input.style.color = (val && !ans.startsWith(val)) ? "var(--danger)" : "#000";
}

function handleHint(e, input) {
    if (e.code === 'Space') {
        e.preventDefault();
        const ans = answers[input.dataset.id];
        input.value = ans.substring(0, input.value.length + 1);
        checkInput(input);
    }
}

function calculateScore() {
    const inputs = clozeContent.querySelectorAll("input");
    let correct = 0;
    inputs.forEach(i => {
        if(i.value.trim().toLowerCase() === answers[i.dataset.id].toLowerCase()) correct++;
        else i.placeholder = "Ans: " + answers[i.dataset.id];
    });
    document.getElementById("scoreResult").innerHTML = `得分: ${Math.round(correct/inputs.length*100)}% (${correct}/${inputs.length})`;
}

// ---------------- 跟打练习 ----------------
window.startTypingMode = function() {
    const text = inputArea.value.trim();
    if (!text) return;
    rawTextArray = text.split("");
    typingIndex = 0;
    clozeContent.innerHTML = `<div class="typing-container" id="typeBox"></div>`;
    const typeBox = document.getElementById("typeBox");
    typeBox.innerHTML = rawTextArray.map((char, i) => `<span id="char-${i}">${char === '\n' ? '↵<br>' : (char === ' ' ? '&nbsp;' : char)}</span>`).join("");
    
    showExerciseUI();
    document.getElementById("submitBtn").classList.add("hidden");
    const hInput = document.getElementById("hiddenInput");
    hInput.focus();
    updateTypingDisplay();

    hInput.oninput = (e) => {
        const char = e.target.value.substring(e.target.value.length - 1);
        if (char.toLowerCase() === rawTextArray[typingIndex].toLowerCase() || (char==="" && rawTextArray[typingIndex]==="\n")) {
            document.getElementById(`char-${typingIndex}`).className = "char-correct";
            typingIndex++;
            updateTypingDisplay();
        } else {
            document.getElementById(`char-${typingIndex}`).className = "char-wrong";
        }
        e.target.value = "";
    };
};

function updateTypingDisplay() {
    if (typingIndex >= rawTextArray.length) { alert("完成！"); exitExercise(); return; }
    document.querySelectorAll('.char-current').forEach(el => el.classList.remove('char-current'));
    const cur = document.getElementById(`char-${typingIndex}`);
    cur.classList.add('char-current');
    cur.scrollIntoView({ block: 'center' });
}

window.onload = init;
</script>
</body>
</html>
