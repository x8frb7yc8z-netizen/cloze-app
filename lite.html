<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>极简完形填空 Pro 2.0</title>
    <style>
        :root { --accent-color: #34c759; --text-color: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 20px; line-height: 1.6; color: var(--text-color); }
        
        /* 视频容器 */
        #video-container { position: sticky; top: 0; background: white; z-index: 100; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        video { width: 100%; border-radius: 12px; background: #000; }

        /* 剧本展示区 */
        #script-display { margin-top: 20px; font-size: 19px; }
        .sentence-row { margin-bottom: 15px; display: flex; align-items: flex-start; }
        .time-anchor { font-size: 12px; color: #ccc; cursor: pointer; min-width: 45px; padding-top: 6px; }
        
        /* 单词交互 */
        .word-span { cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: background 0.2s; display: inline-block; }
        .word-span:active { background: #e0e0e0; }
        .cloze { color: var(--accent-color); font-weight: bold; border-bottom: 2px solid var(--accent-color); }
        
        .controls { margin: 10px 0; display: flex; gap: 10px; }
        button { padding: 8px 15px; border-radius: 8px; border: none; background: #f0f0f0; font-size: 14px; }
    </style>
</head>
<body>

<div id="video-container">
    <video id="mainVideo" controls playsinline></video>
    <div class="controls">
        <input type="file" id="videoInput" accept="video/*" style="display:none">
        <button onclick="document.getElementById('videoInput').click()">关联本地视频</button>
        <button id="syncStatus">进度未同步</button>
    </div>
</div>

<div id="script-display">
    </div>

<script>
    // --- 1. 配置与初始化 ---
    const video = document.getElementById('mainVideo');
    const display = document.getElementById('script-display');
    const nid = "{{nid}}"; // Anki Note ID
    
    // 假设这是从 Anki 字段 {{TimestampText}} 获取的原始数据
    const rawText = `[00:01.50]I [00:01.50]know [00:01.50]that [00:01.80]Walt [00:02.10]lost [00:02.30]his [00:02.50]mom.`; 

    // --- 2. 核心解析逻辑：隐藏时间戳，提取坐标 ---
    function renderScript(text) {
        // 按句子拆分（假设每句开头有时间戳）
        const lines = text.split(/(?=\[\d{2}:\d{2}\.\d{2}\])/g);
        
        display.innerHTML = lines.map(line => {
            const timeMatch = line.match(/\[(\d{2}):(\d{2})\.(\d{2})\]/);
            if (!timeMatch) return "";
            
            const seconds = parseInt(timeMatch[1]) * 60 + parseInt(timeMatch[2]) + parseInt(timeMatch[3]) / 100;
            const cleanLine = line.replace(/\[.*?\]/g, "").trim();
            const words = cleanLine.split(" ");

            return `
                <div class="sentence-row">
                    <span class="time-anchor" onclick="seek(${seconds})">${timeMatch[1]}:${timeMatch[2]}</span>
                    <div class="sentence-text">
                        ${words.map(w => `<span class="word-span" data-time="${seconds}">${w}</span>`).join(" ")}
                    </div>
                </div>
            `;
        }).join("");
    }

    // --- 3. 交互逻辑：单击复制单词/点读，双击复制全句/搜图 ---
    display.addEventListener('click', (e) => {
        const target = e.target;
        if (!target.classList.contains('word-span')) return;

        // 单击：复制单词 + 视频跳转
        const word = target.innerText.replace(/[^\w]/g, "");
        navigator.clipboard.writeText(word);
        seek(parseFloat(target.dataset.time));
    });

    display.addEventListener('dblclick', (e) => {
        const target = e.target;
        if (!target.classList.contains('word-span')) return;

        // 双击：复制整句 + 图片搜索
        const sentence = target.closest('.sentence-row').innerText.replace(/\d{2}:\d{2}/, "");
        navigator.clipboard.writeText(sentence);
        window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(target.innerText)}`, '_blank');
    });

    function seek(time) {
        video.currentTime = time;
        video.play();
    }

    // --- 4. 进度同步逻辑 (Firebase 简化版) ---
    // 保存进度
    video.onpause = () => {
        const progress = video.currentTime;
        console.log(`保存进度: ${progress}`);
        // firebase.database().ref('progress/' + nid).set(progress);
        document.getElementById('syncStatus').innerText = "进度已保存";
    };

    // 恢复进度
    document.getElementById('videoInput').onchange = (e) => {
        const file = e.target.files[0];
        video.src = URL.createObjectURL(file);
        // 执行逻辑：从 Firebase 获取 nid 对应的进度并跳转
        // const savedTime = ... (fetch from firebase)
        // video.currentTime = savedTime;
    };

    renderScript(rawText);
</script>
</body>
</html>
