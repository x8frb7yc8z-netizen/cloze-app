<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI æ„ç¾¤åŒæ­¥æ’­æ”¾å™¨ - White Edition Pro</title>
    <style>
        /* --- å…¨å±€é”å®šä¸ iOS ä¼˜åŒ– --- */
        html, body { 
            width: 100%; margin: 0; padding: 0; 
            overflow: hidden;
            background: #ffffff;
            -webkit-overflow-scrolling: touch; 
        }

        :root {
            --primary: #00a1d6;
            --primary-light: rgba(0, 161, 214, 0.08);
            --text-main: #1d1d1f;
            --text-dim: #86868b;
        }

        body {
            font-family: -apple-system, "SF Pro Display", sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .video-wrapper {
            flex: 0 0 auto;
            background: #000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 10;
        }
        video {
            max-height: 40vh;
            width: 100%;
            display: block;
        }

        .transcript-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px 0;
            background: #ffffff;
            scroll-behavior: smooth;
        }

        .line {
            padding: 18px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .line.active {
            color: var(--primary);
            transform: scale(1.04);
        }

        .content {
            line-height: 1.5;
            font-size: 24px;
            font-weight: 400;
            color: var(--text-main);
            max-width: 90%;
        }

        .line.active .content {
            font-weight: 600;
            color: #000;
        }

        #status-bar {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 10px;
            color: var(--text-dim);
            background: rgba(255,255,255,0.7);
            padding: 2px 6px;
            border-radius: 4px;
            pointer-events: none;
            z-index: 100;
        }

        .btn-upload {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 200;
            opacity: 0.3;
            font-size: 20px;
            cursor: pointer;
        }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div id="status-bar">å‡†å¤‡å°±ç»ª...</div>
<label class="btn-upload">ğŸ“<input type="file" id="videoInput" accept="video/*"></label>

<div class="video-wrapper">
    <video id="videoPlayer" controls playsinline webkit-playsinline></video>
</div>

<div class="transcript-container" id="transcript">
    <div style="text-align: center; color: #86868b; margin-top: 50px;">
        ç­‰å¾… Anki ä¼ è¾“æ•°æ®...
    </div>
</div>

<script type="module">
// --- 1. ä¿®æ­£åçš„ Firebase å¯¼å…¥ (è¡¥å…¨äº† initializeApp) ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, set, child, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
    authDomain: "cloze-master-pro.firebaseapp.com",
    databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "cloze-master-pro"
};

// æ­£ç¡®æ‰§è¡Œåˆå§‹åŒ–
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const video = document.getElementById('videoPlayer');
const transcript = document.getElementById('transcript');
const statusBar = document.getElementById('status-bar');

let currentNoteId = null;
let isAutoScrolling = false;
let lastSaveTime = 0;

// --- 2. å·¥å…·å‡½æ•° ---
function timeToSeconds(t) {
    if (!t) return 0;
    const p = t.replace(',', '.').trim().split(':');
    if (p.length === 3) return (+p[0]) * 3600 + (+p[1]) * 60 + (+p[2]);
    return (+p[0]) * 60 + (+p[1]);
}

function parseSubtitle(data) {
    if (!data) return [];
    const doc = new DOMParser().parseFromString(data, 'text/html');
    let cleanData = doc.documentElement.textContent;
    cleanData = cleanData.replace(/<br\s*\/?>/gi, "\n")
                         .replace(/<\/p>|<\/div>/gi, "\n")
                         .replace(/<\/?[^>]+(>|$)/g, "");

    const lines = cleanData.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
    const cues = [];

    for (let i = 0; i < lines.length; i++) {
        // å¢å¼ºæ­£åˆ™ï¼šå…¼å®¹å„ç§æ—¶é—´è½´æ ¼å¼
        const timeMatch = lines[i].match(/(\d{1,2}:\d{2}:\d{2}[.,]\d{3})\s*(?:-->|--&gt;)\s*(\d{1,2}:\d{2}:\d{2}[.,]\d{3})/);
        if (timeMatch) {
            const start = timeToSeconds(timeMatch[1]);
            let textParts = [];
            let j = i + 1;
            while (j < lines.length && !lines[j].match(/-->|--&gt;/)) {
                textParts.push(lines[j]);
                j++;
            }
            const text = textParts.join(' ');
            if (text) cues.push({ start, text });
            i = j - 1;
        }
    }
    return cues;
}

function renderSubtitles(cues) {
    transcript.innerHTML = '';
    if (cues.length === 0) {
        transcript.innerHTML = '<div style="text-align:center; padding:20px;">å­—å¹•è§£æå¤±è´¥æˆ–æ ¼å¼ä¸æ­£ç¡®</div>';
        return;
    }
    cues.forEach((cue, index) => {
        const div = document.createElement('div');
        div.className = 'line';
        div.dataset.time = cue.start;
        div.dataset.index = index;
        div.innerHTML = `<div class="content">${cue.text}</div>`;
        div.onclick = () => {
            video.currentTime = cue.start;
            video.play();
        };
        transcript.appendChild(div);
    });
}

// --- 3. ä¿®æ­£åçš„è¿›åº¦ä¿å­˜ä¸æ¢å¤ (å¯¹åº”ä½ æˆªå›¾ä¸­çš„è·¯å¾„) ---
async function fetchProgress(noteId) {
    if (!noteId) return;
    try {
        const dbRef = ref(db);
        // ä¿®æ”¹ä¸º player_progress
        const snapshot = await get(child(dbRef, `player_progress/${noteId}`));
        if (snapshot.exists()) {
            const data = snapshot.val();
            video.currentTime = data.lastTime || 0;
            
            setTimeout(() => {
                const target = document.querySelector(`.line[data-index="${data.lastIndex}"]`);
                if (target) {
                    isAutoScrolling = true;
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => isAutoScrolling = false, 1000);
                }
            }, 500);
        }
    } catch (e) { console.error("è¯»å–è¿›åº¦å¤±è´¥:", e); }
}

async function saveProgress(noteId, time, index) {
    if (!noteId) return;
    const now = Date.now();
    // 2.5ç§’èŠ‚æµï¼Œé¿å…é¢‘ç¹å†™å…¥
    if (now - lastSaveTime < 2500) return; 

    lastSaveTime = now;
    try {
        // ä¿®æ”¹ä¸º player_progress
        await set(ref(db, 'player_progress/' + noteId), {
            lastTime: time,
            lastIndex: index,
            updatedAt: serverTimestamp()
        });
        statusBar.innerText = "åŒæ­¥æˆåŠŸ: " + new Date().toLocaleTimeString();
        console.log("âœ… è¿›åº¦å·²åŒæ­¥åˆ° Firebase");
    } catch (e) { 
        console.error("å†™å…¥å¤±è´¥:", e);
        statusBar.innerText = "å†™å…¥å¤±è´¥: " + e.message;
    }
}

// --- 4. äº‹ä»¶ç›‘å¬ ---
document.getElementById('videoInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) video.src = URL.createObjectURL(file);
});

window.addEventListener('message', (event) => {
    if (event.data.type === 'LOAD_SUBTITLES') {
        currentNoteId = event.data.noteId;
        const cues = parseSubtitle(event.data.data);
        renderSubtitles(cues);
        fetchProgress(currentNoteId);
        statusBar.innerText = "å¡ç‰‡å·²åŠ è½½: " + currentNoteId;
    }
});

video.addEventListener('timeupdate', () => {
    const lines = document.querySelectorAll('.line');
    if (!lines.length) return;
    const currentTime = video.currentTime;

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const start = parseFloat(line.dataset.time);
        const next = lines[i+1] ? parseFloat(lines[i+1].dataset.time) : Infinity;

        if (currentTime >= start && currentTime < next) {
            if (!line.classList.contains('active')) {
                document.querySelector('.line.active')?.classList.remove('active');
                line.classList.add('active');

                if (currentNoteId) {
                    saveProgress(String(currentNoteId), currentTime, i);
                }

                if (!isAutoScrolling) {
                    isAutoScrolling = true;
                    line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => isAutoScrolling = false, 800);
                }
            }
            break; 
        }
    }
});

window.parent.postMessage({ type: 'PLAYER_READY' }, '*');
</script>
</body>
</html>
