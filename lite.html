<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI æ„ç¾¤åŒæ­¥æ’­æ”¾å™¨ - White Edition</title>
    <style>
/* --- 1. å½»åº•é”å®šå…¨å±€æ¨ªå‘æº¢å‡º --- */
html, body {
    width: 100%;
    margin: 0;
    padding: 0;
    overflow-x: hidden; /* ç¦æ­¢æ¨ªå‘æ»šåŠ¨ */
    position: relative;
    -webkit-overflow-scrolling: touch; /* ä¼˜åŒ– iOS æ»šåŠ¨æµç•…åº¦ */
}

/* éšè—é¡¶éƒ¨çŠ¶æ€æç¤ºå’ŒçŠ¶æ€ç‚¹ */
#status, .status-dot {
    display: none !important;
}

/* --- 1. ç§»é™¤å®¹å™¨å·¦å³ç•™ç™½ --- */
.transcript-container {
    flex: 1;
    overflow-y: auto;
    /* ä¿®æ”¹ï¼šä¸Šä¸‹ä¿ç•™é—´è·ï¼Œå·¦å³è®¾ä¸º 0 */
    padding: 40px 0px !important; 
    background: #ffffff; 
}
        :root {
            --primary: #00a1d6;
            --primary-light: rgba(0, 161, 214, 0.08);
            --bg: #ffffff;
            --header-bg: rgba(255, 255, 255, 0.9);
            --panel: #f5f5f7;
            --text-main: #1d1d1f;
            --text-dim: #86868b;
            --border: #d2d2d7;
            --line-hover: #f0f0f2;
        }

        body {
            font-family: -apple-system, "SF Pro Display", "PingFang SC", sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

/* å½»åº•åˆ é™¤ header é«˜åº¦å ä½ */
.header {
    height: 0;
    padding: 0;
    border: none;
}

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #d2d2d7;
            display: inline-block;
        }
        .status-dot.active { background: #34c759; box-shadow: 0 0 6px rgba(52, 199, 89, 0.5); }

        #status { font-size: 13px; color: var(--text-dim); flex-grow: 1; }

        /* æŒ‰é’®æ ·å¼ - æµ…è‰²ç²¾è‡´åŒ– */
.btn-upload {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 200;
    background: rgba(255, 255, 255, 0.2) !important; /* åŠé€æ˜ */
    color: white !important;
    border: none !important;
    backdrop-filter: blur(5px);
    opacity: 0.3;
    transition: opacity 0.3s;
}
.btn-upload:hover {
    opacity: 1;
    background: rgba(255, 255, 255, 0.4) !important;
}

        input[type="file"] { display: none; }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* è§†é¢‘å®¹å™¨ */
        .video-wrapper {
            flex: 0 0 auto;
            background: #000; /* è§†é¢‘åŒºåŸŸä¿æŒé»‘è‰²ä»¥é˜²æ¼å…‰å¹²æ‰° */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        video {
            max-height: 45vh;
            width: 100%;
            display: block;
        }

        /* å­—å¹•åˆ—è¡¨åŒº */
        .transcript-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg);
        }
        
/* --- å­—å¹•è¡Œæ ·å¼ï¼šå»æ‰å¡ç‰‡æ¡†ï¼Œæ”¹ä¸ºå±…ä¸­çº¯æ–‡æœ¬ --- */
.line {
    padding: 10px 0;
    cursor: pointer;
    margin-bottom: 15px; /* è¡Œä¸è¡Œä¹‹é—´ç•™ç™½ */
    border: none !important; /* å½»åº•å»æ‰è¾¹æ¡† */
    background: transparent !important; /* å»æ‰èƒŒæ™¯è‰² */
    transition: all 0.3s ease;
    text-align: center; /* æ ¸å¿ƒï¼šæ–‡å­—å±…ä¸­ */
    display: flex;
    flex-direction: column;
    align-items: center;
}

        .line:hover {
            background: var(--line-hover);
            border-color: var(--border);
        }

/* --- æ¿€æ´»æ€ï¼šä»…é€šè¿‡é¢œè‰²å’Œç²—ç»†å˜åŒ–ï¼Œä¸æ”¹å˜èƒŒæ™¯ --- */
.line.active {
    background: transparent !important; 
    color: var(--primary);
    box-shadow: none !important; /* å»æ‰é˜´å½± */
    transform: scale(1.05); /* è½»å¾®æ”¾å¤§çªå‡º */
}
/* --- æ—¶é—´æˆ³ï¼šå¦‚å›¾ 2 èˆ¬ç²¾ç®€ï¼Œæ”¾åœ¨æ–‡æœ¬ä¸Šæ–¹æˆ–éšè— --- */
.time-box {
    display: none !important; /* å¼ºåˆ¶ä¸æ˜¾ç¤º */
    font-family: "SF Mono", monospace;
    font-size: 10px;
    color: #ccc; /* é¢œè‰²æµ…æ·¡ */
    background: #f0f0f2;
    padding: 2px 6px;
    border-radius: 4px;
    margin-bottom: 8px;
    display: inline-block;
    opacity: 0.6;
}
        .line {
    width: 100%;
    padding: 10px 0;
            color: var(--primary);
            background: var(--primary-light);
        }

/* --- 2. ç§»é™¤å†…å®¹å®½åº¦é™åˆ¶ --- */
.content {
    line-height: 1.6;
    font-size: 26px;
    font-weight: 400;
    color: #1d1d1f;
    /* ä¿®æ”¹ï¼šè®¾ä¸º 100%ï¼Œç¡®ä¿æ–‡å­—å¯ä»¥è´´åˆ°å±å¹•è¾¹ç¼˜ */
    max-width: 100% !important; 
    /* å¦‚æœæœ‰ margin: 0 auto ä¹Ÿè¯·ç¡®ä¿å·¦å³ä¸º 0 */
    margin: 0 !important; 
}

.line.active .content {
    font-weight: 600; /* æ¿€æ´»æ—¶åŠ ç²— */
    color: #000;
}

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-dim);
            text-align: center;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="status-dot" id="dot"></div>
    <span id="status">ç­‰å¾…åŠ è½½...</span>
    <label class="btn-upload">ğŸ“<input type="file" id="videoInput" accept="video/*"></label>
</div>

<div class="main-content">
    <div class="video-wrapper">
    <video id="videoPlayer" controls playsinline webkit-playsinline></video>
</div>

    <div class="transcript-container" id="transcript">
        <div class="empty-state">
            <p>è¯·åœ¨ Anki ä¸­å¡«å†™â€œå­—å¹•å†…å®¹â€<br>æˆ–æ‰‹åŠ¨ä¸Šä¼ è§†é¢‘</p>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('videoPlayer');
    const transcript = document.getElementById('transcript');
    const status = document.getElementById('status');
    const dot = document.getElementById('dot');

    function updateStatus(msg, active = false) {
        status.innerText = msg;
        dot.className = active ? 'status-dot active' : 'status-dot';
    }

    document.getElementById('videoInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            video.src = URL.createObjectURL(file);
            updateStatus("è§†é¢‘å·²åŠ è½½", true);
        }
    });

    function processSubtitleContent(content) {
        const cues = parseSubtitle(content);
        renderSubtitles(cues);
        updateStatus("å­—å¹•å·²ä» Anki åŒæ­¥", true);
    }

    function parseSubtitle(data) {
    // 1. å½»åº•æ¸…é™¤ HTML æ ‡ç­¾å¹¶å°†å¸¸è§æ ‡ç­¾è½¬ä¸ºæ¢è¡Œï¼Œé˜²æ­¢ Anki çš„ <div> ç­‰å¹²æ‰°åˆ†å‰²
    let cleanData = data.replace(/<br\s*\/?>/gi, "\n")
                        .replace(/<\/p>|<\/div>/gi, "\n")
                        .replace(/<\/?[^>]+(>|$)/g, "");

    // 2. å¤„ç† HTML è½¬ä¹‰å­—ç¬¦ï¼ˆ&rarr; ç­‰ï¼‰
    const doc = new DOMParser().parseFromString(cleanData, 'text/html');
    cleanData = doc.documentElement.textContent;

    // 3. ä½¿ç”¨æ­£åˆ™å…¨å±€åŒ¹é…æ—¶é—´è½´ï¼šæ”¯æŒ 00:00:00,000 æˆ– 00:00.000
    // è¯¥æ­£åˆ™ä¼šåŒ¹é…ç±»ä¼¼ "00:00:12,500 --> 00:00:15,000" è¿™æ ·çš„è¡Œ
    const timeRegex = /(\d{1,2}:\d{2}:\d{2}[.,]\d{3})\s*-->\s*(\d{1,2}:\d{2}:\d{2}[.,]\d{3})/g;
    
    const cues = [];
    let match;

    // å°†å†…å®¹æŒ‰è¡Œæ‹†åˆ†ï¼Œæ›´ç²¾ç¡®åœ°å®šä½æ—¶é—´è½´åŠå…¶ä¸‹æ–¹çš„æ–‡æœ¬
    const lines = cleanData.split('\n').map(l => l.trim()).filter(l => l !== "");

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const timeMatch = line.match(/(\d{1,2}:\d{2}:\d{2}[.,]\d{3})\s*-->\s*(\d{1,2}:\d{2}:\d{2}[.,]\d{3})/);
        
        if (timeMatch) {
            const start = timeToSeconds(timeMatch[1]);
            // æ”¶é›†æ—¶é—´è½´ä¹‹åã€ä¸‹ä¸€ä¸ªæ—¶é—´è½´ä¹‹å‰çš„æ‰€æœ‰è¡Œä½œä¸ºæ–‡æœ¬
            let textParts = [];
            let j = i + 1;
            while (j < lines.length && !lines[j].match(/-->/)) {
                textParts.push(lines[j]);
                j++;
            }
            const text = textParts.join(' ');
            if (text) {
                cues.push({ start, text });
            }
            i = j - 1; // è·³è¿‡å·²å¤„ç†çš„è¡Œ
        }
    }

    console.log("è§£ææˆåŠŸï¼Œæ¡æ•°:", cues.length);
    return cues;
}
    function timeToSeconds(timeStr) {
        const parts = timeStr.trim().replace(',', '.').split(':');
        if (parts.length === 3) return (+parts[0]) * 3600 + (+parts[1]) * 60 + (+parts[2]);
        return (+parts[0]) * 60 + (+parts[1]);
    }

    function renderSubtitles(cues) {
        transcript.innerHTML = '';
        cues.forEach(cue => {
            const div = document.createElement('div');
            div.className = 'line';
            div.dataset.time = cue.start;
            div.innerHTML = `
                <span class="time-box">${formatTime(cue.start)}</span>
                <div class="content">${cue.text}</div>
            `;
            div.onclick = () => {
                video.currentTime = cue.start;
                video.play();
            };
            transcript.appendChild(div);
        });
    }

    function formatTime(s) {
        return new Date(s * 1000).toISOString().substr(14, 5);
    }

    video.addEventListener('timeupdate', () => {
        const currentTime = video.currentTime;
        const lines = document.querySelectorAll('.line');
        lines.forEach((line, i) => {
            const start = parseFloat(line.dataset.time);
            const next = lines[i+1] ? parseFloat(lines[i+1].dataset.time) : Infinity;
            if (currentTime >= start && currentTime < next) {
                if (!line.classList.contains('active')) {
                    document.querySelector('.line.active')?.classList.remove('active');
                    line.classList.add('active');
                    line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    });

    window.addEventListener('message', (event) => {
        if (event.data.type === 'LOAD_SUBTITLES') {
            processSubtitleContent(event.data.data);
        }
    });
    window.parent.postMessage({ type: 'PLAYER_READY' }, '*');
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// --- Firebase é…ç½® ---
const firebaseConfig = {
    apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
    authDomain: "cloze-master-pro.firebaseapp.com",
    projectId: "cloze-master-pro"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const video = document.getElementById('videoPlayer');
const transcript = document.getElementById('transcript');
const statusBar = document.getElementById('status'); // å¯ä»¥æ˜¾ç¤ºçŠ¶æ€
let currentNoteId = null;
let isAutoScrolling = false;
let lastSaveTime = 0;

// --- å­—å¹•è§£æ ---
function parseSubtitle(data) {
    let cleanData = data.replace(/<br\s*\/?>/gi, "\n")
                        .replace(/<\/p>|<\/div>/gi, "\n")
                        .replace(/<\/?[^>]+(>|$)/g, "");
    const lines = cleanData.split('\n').map(l => l.trim()).filter(l => l !== "");
    const cues = [];
    for (let i = 0; i < lines.length; i++) {
        const timeMatch = lines[i].match(/(\d{1,2}:\d{2}:\d{2}[.,]\d{3})\s*-->\s*(\d{1,2}:\d{2}:\d{2}[.,]\d{3})/);
        if (timeMatch) {
            let textParts = [];
            let j = i + 1;
            while (j < lines.length && !lines[j].match(/-->/)) {
                textParts.push(lines[j]);
                j++;
            }
            cues.push({ start: timeToSeconds(timeMatch[1]), text: textParts.join(' ') });
            i = j - 1;
        }
    }
    return cues;
}

function timeToSeconds(timeStr) {
    const parts = timeStr.replace(',', '.').split(':');
    return (+parts[0]) * 3600 + (+parts[1]) * 60 + (+parts[2]);
}

// --- æ¸²æŸ“å­—å¹• ---
function renderSubtitles(cues) {
    transcript.innerHTML = '';
    cues.forEach((cue, index) => {
        const div = document.createElement('div');
        div.className = 'line';
        div.dataset.time = cue.start;
        div.dataset.index = index;
        div.innerHTML = `<div class="content">${cue.text}</div>`;
        div.onclick = () => {
            video.currentTime = cue.start;
            video.play();
            saveProgressThrottled(video.currentTime, index);
        };
        transcript.appendChild(div);
    });
}

// --- ä¿å­˜ä¸è¯»å–è¿›åº¦ ---
async function fetchProgress(noteId) {
    const snap = await getDoc(doc(db, "progress", noteId));
    if (snap.exists()) {
        const data = snap.data();
        video.currentTime = data.lastTime || 0;
        const target = document.querySelector(`.line[data-index="${data.lastIndex}"]`);
        if (target) {
            isAutoScrolling = true;
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => isAutoScrolling = false, 1000);
        }
    }
}

async function saveProgress(noteId, time, index) {
    if (!noteId) return;
    try {
        await setDoc(doc(db, "progress", noteId), {
            lastTime: time,
            lastIndex: index,
            updatedAt: serverTimestamp()
        }, { merge: true });
        statusBar.innerText = "å·²åŒæ­¥ " + new Date().toLocaleTimeString();
    } catch (e) {
        console.error("ä¿å­˜è¿›åº¦å¤±è´¥", e);
    }
}

// èŠ‚æµï¼Œæœ€å°‘é—´éš” 2 ç§’
function saveProgressThrottled(time, index) {
    const now = Date.now();
    if (now - lastSaveTime < 2000) return;
    lastSaveTime = now;
    saveProgress(currentNoteId, time, index);
}

// --- ç›‘å¬ Anki ä¼ å…¥å­—å¹• ---
window.addEventListener('message', (event) => {
    if (event.data.type === 'LOAD_SUBTITLES') {
        currentNoteId = event.data.noteId;
        const cues = parseSubtitle(event.data.data);
        renderSubtitles(cues);
        fetchProgress(currentNoteId);
        statusBar.innerText = "å·²åŠ è½½å­—å¹•: " + currentNoteId;
    }
});

// --- æ’­æ”¾æ—¶è‡ªåŠ¨æ›´æ–°æ¿€æ´»çŠ¶æ€ ---
video.addEventListener('timeupdate', () => {
    const lines = document.querySelectorAll('.line');
    lines.forEach((line, i) => {
        const start = parseFloat(line.dataset.time);
        const next = lines[i+1] ? parseFloat(lines[i+1].dataset.time) : Infinity;
        if (video.currentTime >= start && video.currentTime < next) {
            if (!line.classList.contains('active')) {
                document.querySelector('.line.active')?.classList.remove('active');
                line.classList.add('active');
                if (!isAutoScrolling) {
                    isAutoScrolling = true;
                    line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    saveProgressThrottled(video.currentTime, i);
                    setTimeout(() => isAutoScrolling = false, 1000);
                }
            }
        }
    });
});

// --- é€šçŸ¥ Anki å‡†å¤‡å°±ç»ª ---
window.parent.postMessage({ type: 'PLAYER_READY' }, '*');
</script>
</body>
</html>
