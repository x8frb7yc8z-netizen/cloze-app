<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>极简完形填空 Pro Sync</title>
<style>
/* 按钮抖动动画 */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
}

.btn-error-shake {
    animation: shake 0.2s ease-in-out 0s 2;
    background-color: #ffcdd2 !important;
    transition: background-color 0.2s;
}

#image-preview-container {
    position: fixed;
    top: 100%;
    left: 0;
    width: 100%;
    height: 100%;
    background: #fff;
    box-shadow: none; 
    z-index: 2000;
    transition: top 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
}

#image-preview-container.active { top: 35px; }

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: #f1f3f4;
    border-bottom: 1px solid #ddd;
    flex-shrink: 0;
}

.preview-content { flex: 1; overflow: hidden; }
.preview-iframe { width: 100%; height: 100%; border: none; }
.word-bold { font-weight: 800; color: #000; }

:root { --primary: #43a047; --bg: #f8f9fa; --danger: #ff5252; --input-bg: #fffde7; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; width:100%; min-height:100%; font-family:-apple-system, sans-serif; background:#fff; }

.app-container { display: flex; flex-direction: column; padding-top: 35px; }
.main-area { flex: 1; position: relative; overflow-y: auto; -webkit-overflow-scrolling: touch; }

#inputText, #clozeContent {
    width: 100%; 
    min-height: calc(100vh - 35px);
    text-align: center;
    padding: 20px 0px;
    border: none; 
    outline: none;
    font-size: 20px !important; 
    line-height: 1.2; 
    font-family: inherit;
    white-space: pre-wrap; 
    word-break: break-word;
    position: relative;
    display: block;
}

@media screen and (max-width: 500px) {
    #inputText, #clozeContent { font-size: 26px !important; }
}

#inputText { resize: none; }
#clozeContent { display: none; -webkit-user-select: text; user-select: text; pointer-events: auto; }

.exercise-mode #inputText { display: none !important; }
.exercise-mode #clozeContent { display: block !important; }
.exercise-mode .edit-only { display: none; }
.exercise-mode .exercise-only { display: flex !important; flex: 1; }

.cloze-display-input {
    font-size: 0.9em; 
    min-width: 2.2ch; 
    height: 1.2em;
    margin: 0 2px;
    border: none; 
    border-bottom: 2px solid #666;
    background: var(--input-bg);
    text-align: center;
    border-radius: 0;
    -webkit-appearance: none;
    vertical-align: middle;
}

.footer-actions { 
    display: flex; 
    background: #fff; 
    position: fixed; 
    top: 0; left: 0; width: 100%; 
    z-index: 1000; 
    height: 30px; 
    border-bottom: 1px solid #ddd;
}

.footer-actions button { 
    flex: 1; padding: 0; border: none; font-weight: bold; cursor: pointer; font-size: 13px; 
    display: flex; align-items: center; justify-content: center;
}

.font-ctrl { display: flex; align-items: center; gap: 5px; padding: 0 10px; font-size: 14px; }
.btn-primary { background:var(--primary); color:white; }
.btn-danger { color:var(--danger); background:#fff8f8; }

.word-span { -webkit-user-select: text !important; user-select: text !important; padding: 0 !important; margin: 0 !important; display: inline; }
.exercise-only { display: none !important; }
</style>
</head>

<body>
<div class="app-container" id="app">
    <nav class="footer-actions">
        <button class="btn-danger edit-only" onclick="handleClear()">清空</button>
        <button class="exercise-only" onclick="copyFullText()" style="background:#f3e5f5;">复制</button>
        <button id="searchModeBtn" class="exercise-only" onclick="toggleSearchMode()" style="background:#e1f5fe;">图片</button>
        <button id="boldModeBtn" class="exercise-only" onclick="toggleBoldMode()" style="background:#e8f5e9;">粗体</button>
        <button id="delModeBtn" class="exercise-only" onclick="toggleDeleteMode()">重置: 关</button>
        <div class="font-ctrl edit-only">
             <button onclick="changeFontSize(-2)">A-</button>
             <span id="fontSizeLabel">26</span>
             <button onclick="changeFontSize(2)">A+</button>
        </div>
        <button class="btn-primary edit-only" onclick="toggleMode(true)">开始练习</button>
        <button class="btn-primary exercise-only" onclick="toggleMode(false)">← 返回</button>
    </nav>

    <main class="main-area">
        <textarea id="inputText" placeholder="在此粘贴文章内容..."></textarea>
        <div id="clozeContent"></div>
    </main>
</div>

<div id="image-preview-container">
    <div class="preview-header">
        <span id="preview-word-title" style="font-weight:bold; color:#0288d1; font-size:14px;">图片搜索</span>
        <button onclick="closeImagePreview()" style="border:none; background:#eee; border-radius:4px; padding:4px 12px; font-size:12px;">关闭预览</button>
    </div>
    <div class="preview-content">
        <iframe id="preview-iframe" class="preview-iframe" src=""></iframe>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
    authDomain: "cloze-master-pro.firebaseapp.com",
    databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "cloze-master-pro",
    storageBucket: "cloze-master-pro.firebasestorage.app",
    messagingSenderId: "697808901954",
    appId: "1:697808901954:web:32455d94bf67e522e01adb"
};

const fbApp = initializeApp(firebaseConfig);
const db = getDatabase(fbApp);

window.getDocId = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const customId = urlParams.get('customid');
    if (customId && customId.trim() !== "") return "cid_" + customId.trim(); 
    const text = document.getElementById('inputText').value.trim();
    if (!text) return null;
    try {
        return btoa(unescape(encodeURIComponent(text.substring(0, 25)))).replace(/[/+=]/g, "");
    } catch(e) { return "default_doc"; }
}

function getTopWordIndex() {
    const offset = 50; 
    const x = window.innerWidth / 2;
    const el = document.elementFromPoint(x, offset);
    if (el && el.dataset.index) return parseInt(el.dataset.index);
    return 0;
}

window.syncUpload = async function() {
    const id = window.getDocId();
    if (!id) return;
    const topIdx = getTopWordIndex();
    const inputArea = document.getElementById('inputText');

    set(ref(db, 'clozes/' + id), { 
        content: inputArea.value,
        positions: window.manualPositions || [], 
        boldPositions: window.boldPositions || [], 
        topIndex: topIdx,
        ts: Date.now() 
    });
};

window.syncDownload = async function() {
    const id = window.getDocId();
    const currentInput = document.getElementById('inputText');
    if (!id || !currentInput) return;

    const snapshot = await get(child(ref(db), 'clozes/' + id));
    if (snapshot.exists()) {
        const data = snapshot.val();
        if (!currentInput.value.trim() && data.content) {
            currentInput.value = data.content;
            window.renderCloze();
            document.getElementById('app').classList.add('exercise-mode');
        }
        window.manualPositions = data.positions || [];
        window.boldPositions = data.boldPositions || [];
        
        if (document.getElementById('app').classList.contains('exercise-mode')) {
            window.renderCloze(); 
            if (data.topIndex !== undefined) {
                setTimeout(() => {
                    const targetEl = document.querySelector(`[data-index="${data.topIndex}"]`);
                    if (targetEl) {
                        targetEl.scrollIntoView({ behavior: 'auto', block: 'start' });
                        window.scrollBy(0, -45);
                    }
                }, 400); 
            }
        }
    }
};

// 实时同步滚动进度：停止滚动1秒后上传
let scrollTimer;
window.addEventListener('scroll', () => {
    if (!document.getElementById('app').classList.contains('exercise-mode')) return;
    clearTimeout(scrollTimer);
    scrollTimer = setTimeout(() => {
        window.syncUpload();
    }, 1000); 
});

window.addEventListener('message', async (event) => {
    if (event.data.type === 'ANKI_SYNC_DATA') {
        const { text } = event.data;
        if (!text) return;
        const inputArea = document.getElementById('inputText');
        if (!inputArea.value.trim()) {
            inputArea.value = text;
            window.renderCloze();
            document.getElementById('app').classList.add('exercise-mode');
            window.syncUpload();
        }
    }
});
</script>

<script>
let currentFontSize = 26;
window.manualPositions = [];
window.boldPositions = [];
let isDeleteMode = false;
let answers = [];
let isCPressed = false;

const inputArea = document.getElementById('inputText');
const clozeContent = document.getElementById('clozeContent');

function renderCloze() {
    const segments = inputArea.value.split(/([a-zA-Z]+|[\u4e00-\u9fa5]|[^\s\w\u4e00-\u9fa5]+)/g);
    answers = [];
    let unitCount = 0;

    clozeContent.innerHTML = segments.map(seg => {
        if (!seg || !seg.trim()) return seg;
        const idx = unitCount++;
        const isChinese = /[\u4e00-\u9fa5]/.test(seg);

        if (window.manualPositions.includes(idx)) {
            answers.push(seg);
            const boxWidth = isChinese ? 2 : (seg.length + 0.1); 
            return `<input class="cloze-display-input" data-id="${answers.length - 1}" data-index="${idx}" 
                    style="width:${boxWidth}ch;" 
                    oninput="validateInput(this)" onkeydown="handleSpaceKey(event, this)"
                    placeholder="${isChinese ? '?' : getHint(seg)}">`;
        }
        
        const boldClass = window.boldPositions.includes(idx) ? 'word-bold' : '';
        return `<span class="word-span ${boldClass}" data-index="${idx}">${seg}</span>`;
    }).join("");
    bindEvents();
}

function validateInput(el) {
    const ans = answers[el.dataset.id];
    const val = el.value.trim();
    const isMatch = ans.toLowerCase().startsWith(val.toLowerCase());
    el.style.backgroundColor = (val.toLowerCase() === ans.toLowerCase()) ? "#c8f7c5" : (isMatch ? "var(--input-bg)" : "#f7c5c5");
    el.style.color = isMatch ? "#000" : "var(--danger)";
}

window.toggleDeleteMode = function() {
    isDeleteMode = !isDeleteMode;
    const btn = document.getElementById('delModeBtn');
    btn.innerText = isDeleteMode ? "重置: 开" : "重置: 关";
    btn.style.backgroundColor = isDeleteMode ? "#ffe0b2" : "#fff";
};

window.toggleBoldMode = function() {
    const target = getSelectedWordElement();
    if (!target) return triggerButtonError('boldModeBtn');
    const idx = parseInt(target.dataset.index);
    if (window.boldPositions.includes(idx)) {
        window.boldPositions = window.boldPositions.filter(i => i !== idx);
    } else {
        window.boldPositions.push(idx);
    }
    renderCloze();
    if(window.syncUpload) window.syncUpload();
};

function bindEvents() {
    clozeContent.onclick = (e) => {
        const target = e.target;
        if (!document.getElementById('app').classList.contains('exercise-mode')) return;

        if (target.tagName === 'INPUT' && (isCPressed || isDeleteMode)) {
            window.manualPositions = window.manualPositions.filter(i => i !== parseInt(target.dataset.index));
            renderCloze();
            if(window.syncUpload) window.syncUpload();
            return;
        }

        if (target.classList.contains('word-span')) {
            copyToClipboard(target.innerText.trim());
            const range = document.createRange();
            range.selectNodeContents(target);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
    };
}

async function copyToClipboard(text) {
    try { await navigator.clipboard.writeText(text); } catch (err) {
        const el = document.createElement('textarea'); el.value = text;
        document.body.appendChild(el); el.select(); document.execCommand('copy');
        document.body.removeChild(el);
    }
}

function getSelectedWordElement() {
    const sel = window.getSelection();
    if (!sel.rangeCount) return null;
    let node = sel.anchorNode;
    if (node.nodeType === 3) node = node.parentNode;
    return node.classList.contains('word-span') ? node : null;
}

function triggerButtonError(id) {
    const b = document.getElementById(id);
    b.classList.add('btn-error-shake');
    setTimeout(() => b.classList.remove('btn-error-shake'), 400);
}

window.toggleMode = function(isEx) {
    if (isEx) {
        if (!inputArea.value.trim()) return alert("内容为空");
        renderCloze();
        document.getElementById('app').classList.add('exercise-mode');
    } else {
        document.getElementById('app').classList.remove('exercise-mode');
    }
};

window.toggleSearchMode = function() {
    const target = getSelectedWordElement();
    if (!target) return triggerButtonError('searchModeBtn');
    const word = target.innerText.trim().replace(/[^\w]/g, "");
    if (word) {
        document.getElementById('preview-word-title').innerText = "Bing图片: " + word;
        document.getElementById('preview-iframe').src = `https://www.bing.com/images/search?q=${word}&form=HDRSC2&adlt=strict`;
        document.getElementById('image-preview-container').classList.add('active');
    }
};

window.closeImagePreview = () => {
    document.getElementById('image-preview-container').classList.remove('active');
    document.getElementById('preview-iframe').src = "";
};

function handleSpaceKey(e, el) {
    if (e.code === 'Space' || e.keyCode === 32) {
        e.preventDefault();
        const ans = answers[el.dataset.id];
        if (el.value.length < ans.length) {
            el.value = ans.substring(0, el.value.length + 1);
            validateInput(el);
        }
    }
}

function changeFontSize(d) {
    currentFontSize += d;
    inputArea.style.fontSize = clozeContent.style.fontSize = currentFontSize + "px";
    document.getElementById('fontSizeLabel').innerText = currentFontSize;
    localStorage.setItem('cloze_user_font_size', currentFontSize);
}

function getHint(w) { return w.length <= 2 ? w[0] + "_" : w[0] + "_".repeat(w.length - 2) + w[w.length-1]; }

window.copyFullText = function() {
    const txt = inputArea.value.trim();
    if (!txt) return;
    copyToClipboard(txt);
    const btn = event.currentTarget;
    const old = btn.innerText;
    btn.innerText = "已复制 √";
    setTimeout(() => btn.innerText = old, 1000);
};

function handleClear() {
    if(confirm("确定清空吗？")) {
        inputArea.value = ""; window.manualPositions = [];
        if(window.syncUpload) window.syncUpload();
        renderCloze();
    }
}

window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'c') isCPressed = true; });
window.addEventListener('keyup', (e) => { if (e.key.toLowerCase() === 'c') isCPressed = false; });

window.onload = () => {
    const savedSize = localStorage.getItem('cloze_user_font_size');
    if (savedSize) changeFontSize(parseInt(savedSize) - currentFontSize);
    if (inputArea.value.trim()) {
        renderCloze();
        document.getElementById('app').classList.add('exercise-mode');
    }
    setTimeout(() => { if(window.syncDownload) window.syncDownload(); }, 800);
};
</script>
</body>
</html>
