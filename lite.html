<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>极简完形填空 Pro Sync</title>
<style>
:root { --primary: #43a047; --bg: #f8f9fa; --danger: #ff5252; --input-bg: #fffde7; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body {
    height: auto !important; /* 允许根据内容高度自动增长 */
    overflow-y: auto !important; /* 开启系统级纵向滚动 */
    -webkit-overflow-scrolling: touch; /* 保证 iOS 滚动顺滑 */
}

/* 2. 容器高度改为 min-height，增加底部间距 */
.app-container {
    height: auto !important;
    min-height: 100vh;
    padding-top: 50px; /* 避开固定导航栏 */
}
.btn-group { display:flex; align-items:center; gap:8px; }

.main-area { 
    flex: 1; 
    position: relative; 
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch;
}
/* 2. 核心修正：取消绝对定位，改用相对定位 */
#inputText, #clozeContent {
    line-height: 1.8 !important; /* 倍增行高，修复点击热区冲突 */
    padding-bottom: 100px; /* 核心：防止底部内容被系统条截断 */
    -webkit-user-select: auto !important; /* 恢复原生选词行为 */
    user-select: auto !important;
    position: static; /* 确保不参与复杂的层级计算 */
}
/* 2. 只有当屏幕真的很窄（手机竖屏）时才切换 */
@media screen and (max-width: 500px) {
    #inputText, #clozeContent {
        font-size: 26px !important;
    }
}
#inputText { resize: none; }
#clozeContent { display: none; } /* 默认隐藏 */

.exercise-mode #inputText { display: none !important; }
.exercise-mode #clozeContent { display: block !important; }
.exercise-mode .edit-only { display: none; }
.exercise-mode .exercise-only { display: flex !important; flex: 1; }

/* 4. 输入框精简 */
.cloze-display-input {
    touch-action: auto !important; /* 移除 manipulation，恢复原生触控 */
    -webkit-appearance: none;
    vertical-align: baseline; /* 保持与文字基线对齐 */
}

/* 1. 导航条改为顶部固定 */
.footer-actions { 
    display: flex; 
    background: #fff; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    z-index: 1000; /* 确保在最顶层 */
    height: 30px; 
    border-bottom: 1px solid #ddd;
}
/* 2. 按钮文字和间距调整 */
.footer-actions button { 
    flex: 1; 
    padding: 0; /* 移除内边距，让文字垂直居中 */
    border: none; 
    font-weight: bold; 
    cursor: pointer; 
    /* 核心修改：字号稍微缩小一点以配合矮窄的导航条 */
    font-size: 14px; 
    display: flex;
    align-items: center;
    justify-content: center;
}
/* 3. 字体调节区域的高度同步 */
.font-ctrl {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 0 10px;
    font-size: 14px;
}
.btn-primary { background:var(--primary); color:white; }
.btn-danger { color:var(--danger); background:#fff8f8; }

#clozeContent {
    /* 允许容器内的文本正常响应系统手势 */
    -webkit-user-select: text;
    user-select: text;
    
    /* 解决部分浏览器在滚动中长按失效的问题 */
    pointer-events: auto; 
    
    /* 增加行高，减少手指点击时的误差 */
    line-height: 1.6;
}

.word-span {
    -webkit-user-select: text !important;
    user-select: text !important;
    -webkit-touch-callout: default !important;
    
    /* 关键：去掉 padding 防止坐标偏移 */
    padding: 0 !important;
    margin: 0 !important;
    display: inline; /* 确保它像普通文字一样排列 */
}

.cloze-display-input {
    /* 输入框通常长按会弹出全选/粘贴，保持默认即可 */
    -webkit-user-select: auto;
}
.exercise-only { display: none !important; }
</style>
</head>

<body>
<div class="app-container" id="app">
    <nav class="footer-actions">
        <button class="btn-danger edit-only" onclick="handleClear()">清空</button>
        <button id="delModeBtn" class="exercise-only" onclick="toggleDeleteMode()">重置: 关</button>
        <div class="font-ctrl edit-only">
             <button class="font-btn" onclick="changeFontSize(-2)">A-</button>
             <span id="fontSizeLabel">26</span>
             <button class="font-btn" onclick="changeFontSize(2)">A+</button>
        </div>
        <button class="btn-primary edit-only" onclick="toggleMode(true)">开始练习</button>
        <button class="btn-primary exercise-only" onclick="toggleMode(false)">← 返回修改</button>
    </nav>

    <main class="main-area">
        <textarea id="inputText" placeholder="在此粘贴文章内容..."></textarea>
        <div id="clozeContent"></div>
    </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
    authDomain: "cloze-master-pro.firebaseapp.com",
    databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "cloze-master-pro",
    storageBucket: "cloze-master-pro.firebasestorage.app",
    messagingSenderId: "697808901954",
    appId: "1:697808901954:web:32455d94bf67e522e01adb"
  };

  const fbApp = initializeApp(firebaseConfig);
  const db = getDatabase(fbApp);

  function getDocId() {
    const text = inputArea.value.trim();
    if (!text) return null;
    // 使用文本前25位生成Base64 ID
    try {
        return btoa(unescape(encodeURIComponent(text.substring(0, 25)))).replace(/[/+=]/g, "");
    } catch(e) { return "default_doc"; }
  }

  window.syncUpload = async function() {
    const id = getDocId();
    if (!id) return;
    set(ref(db, 'clozes/' + id), { positions: manualPositions, ts: Date.now() });
  };

  window.syncDownload = async function() {
    const id = getDocId();
    if (!id) return;
    const snapshot = await get(child(ref(db), 'clozes/' + id));
    if (snapshot.exists()) {
      const data = snapshot.val();
      if (data.positions) {
        manualPositions = data.positions;
        localStorage.setItem('cloze_single_positions', JSON.stringify(manualPositions));
        if (app.classList.contains('exercise-mode')) renderCloze();
      }
    }
  };
</script>

<script>
// 常规业务逻辑
let currentFontSize = 26;
let manualPositions = JSON.parse(localStorage.getItem('cloze_single_positions')) || [];
let answers = [];

const app = document.getElementById('app');
const inputArea = document.getElementById('inputText');
const clozeContent = document.getElementById('clozeContent');

window.onload = async () => { // 加上 async
    const urlParams = new URLSearchParams(window.location.search);
    const textFromAnki = urlParams.get('text');
    
    if (textFromAnki) {
        inputArea.value = decodeURIComponent(textFromAnki);
    } else {
        const savedText = localStorage.getItem('cloze_single_content');
        if (savedText) inputArea.value = savedText;
    }

    // --- 字号逻辑 ---
    const savedSize = localStorage.getItem('cloze_user_font_size');
    if (savedSize) {
        currentFontSize = parseInt(savedSize);
    } else {
        const isMobileUA = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isNarrowScreen = window.innerWidth < 500;
        currentFontSize = (isMobileUA && isNarrowScreen) ? 26 : 20;
    }
    applyFontSize(currentFontSize);

    // --- 核心修正：立即判断并渲染，不等待异步 ---
    if (inputArea.value.trim()) {
        // 先手动执行渲染，不依赖带延迟的 toggleMode
        renderCloze(); 
        app.classList.add('exercise-mode');
    }

    // 此时逻辑已跑完，显示界面
    document.body.classList.add('app-ready');
    
    // 异步同步放在最后，不阻塞渲染
    setTimeout(() => { 
        if(window.syncDownload) window.syncDownload(); 
    }, 1000);
};

// 确保有这个统一应用函数
function applyFontSize(size) {
    inputArea.style.fontSize = clozeContent.style.fontSize = size + "px";
    const label = document.getElementById('fontSizeLabel');
    if(label) label.innerText = size;
}

async function toggleMode(isExercise) {
    const app = document.getElementById('app');
    if (isExercise) {
        if (!inputArea.value.trim()) return alert("请先输入内容");
        renderCloze();
        app.classList.add('exercise-mode');
        // 修复截图中的截断感：强制视口回到顶部
        window.scrollTo({ top: 0, behavior: 'instant' }); 
    } else {
        app.classList.remove('exercise-mode');
    }
}

function renderCloze() {
    // ... 前面逻辑保持不变 ...
    if (manualPositions.includes(idx)) {
        answers.push(seg);
        const boxWidth = isChinese ? 2 : (seg.length + 0.1); 
        // 关键点：移除可能干扰焦点的额外属性，确保顺序
        return `<input type="text" 
                inputmode="text" 
                autocomplete="off" 
                class="cloze-display-input" 
                data-id="${answers.length - 1}" 
                data-index="${idx}" 
                style="width:${boxWidth}ch;" 
                oninput="validateInput(this)" 
                onkeydown="handleSpaceKey(event, this)">`;
    }
    // ... 后面逻辑保持不变 ...
}

function validateInput(el) {
    const ans = answers[el.dataset.id];
    const val = el.value.trim();
    const isMatch = ans.toLowerCase().startsWith(val.toLowerCase());
    el.style.backgroundColor = (val.toLowerCase() === ans.toLowerCase()) ? "#c8f7c5" : (isMatch ? "var(--input-bg)" : "#f7c5c5");
    el.style.color = isMatch ? "#000" : "var(--danger)";
}

// 1. 状态变量
let isCPressed = false;
let isDeleteMode = false; // 手机端删除模式开关

// 2. 键盘监听 (保留 PC 端的极速体验)
window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'c') isCPressed = true; });
window.addEventListener('keyup', (e) => { if (e.key.toLowerCase() === 'c') isCPressed = false; });

// 3. 模式切换函数
window.toggleDeleteMode = function() {
    isDeleteMode = !isDeleteMode;
    const btn = document.getElementById('delModeBtn');
    if (isDeleteMode) {
        btn.innerText = "重置: 开";
        btn.style.backgroundColor = "#ffe0b2";
    } else {
        btn.innerText = "重置: 关";
        btn.style.backgroundColor = "#fff3e0";
    }
};

// 4. 核心事件绑定修改
function bindEvents() {
    // 1. 处理普通文字
    clozeContent.querySelectorAll('.word-span').forEach(el => {
        // 保留双击挖空
        el.ondblclick = () => {
            const idx = parseInt(el.dataset.index);
            if (!manualPositions.includes(idx)) {
                manualPositions.push(idx);
                savePositions();
                renderCloze();
            }
        };
        // 不要在这里写任何 ontouchstart，让浏览器处理长按
    });

    // 2. 处理已挖空的输入框
    clozeContent.querySelectorAll('input').forEach(el => {
        el.onclick = () => {
            // 只保留 C 键或删除模式的逻辑
            if (isCPressed || isDeleteMode) {
                recover(el, false);
            }
        };
        // 确保没有 e.preventDefault()，否则菜单弹不出来
    });
}

// 5. 恢复函数
function recover(el, showConfirm = true) {
    const doRecover = () => {
        manualPositions = manualPositions.filter(i => i !== parseInt(el.dataset.index));
        savePositions();
        renderCloze();
    };
    if (showConfirm) {
        if (confirm("恢复显示？")) doRecover();
    } else {
        doRecover();
    }
}

function handleSpaceKey(e, el) {
    if (e.code === 'Space' || e.keyCode === 32) {
        e.preventDefault();
        const targetAns = answers[el.dataset.id];
        if (el.value.length < targetAns.length) {
            el.value = targetAns.substring(0, el.value.length + 1);
            validateInput(el);
        }
    }
}

function changeFontSize(delta) {
    currentFontSize += delta;
    // 更新输入框和显示框的字体
    inputArea.style.fontSize = clozeContent.style.fontSize = currentFontSize + "px";
    // 更新底部新位置的字号数字
    const label = document.getElementById('fontSizeLabel');
    if(label) label.innerText = currentFontSize;
}


function getHint(w) { return w.length <= 2 ? w[0] + "_" : w[0] + "_".repeat(w.length - 2) + w[w.length-1]; }
function savePositions() { 
    localStorage.setItem('cloze_single_positions', JSON.stringify(manualPositions)); 
    localStorage.setItem('cloze_single_content', inputArea.value);
    if (window.syncUpload) window.syncUpload();
}
inputArea.oninput = savePositions;
</script>
</body>
</html>
