<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>极简完形填空 Pro Sync</title>
    <style>
        /* 保持你原有的 CSS 不变 */
        .word-bold { font-weight: 800; color: #000; }
        :root { --primary: #43a047; --bg: #f8f9fa; --danger: #ff5252; --input-bg: #fffde7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { margin:0; padding:0; width:100%; min-height:100%; font-family:-apple-system, sans-serif; background:#fff; }
        .app-container { display: flex; flex-direction: column; padding-top: 35px; }
        .main-area { flex: 1; position: relative; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        #inputText, #clozeContent {
            width: 100%; min-height: calc(100vh - 35px); text-align: center;
            padding: 20px 0px; border: none; outline: none; font-size: 26px !important; 
            line-height: 1.2; font-family: inherit; white-space: pre-wrap; 
            word-break: break-word; position: relative; display: block;
        }
        #clozeContent { display: none; -webkit-user-select: text; user-select: text; }
        .exercise-mode #inputText { display: none !important; }
        .exercise-mode #clozeContent { display: block !important; }
        .exercise-mode .edit-only { display: none; }
        .exercise-mode .exercise-only { display: flex !important; }
        .footer-actions { 
            display: flex; background: #fff; position: fixed; top: 0; left: 0; 
            width: 100%; z-index: 1000; height: 35px; border-bottom: 1px solid #ddd;
        }
        .footer-actions button { 
            flex: 1; border: none; font-weight: bold; font-size: 14px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-primary { background:var(--primary); color:white; }
        .btn-danger { color:var(--danger); background:#fff8f8; }
        .cloze-display-input {
            font-size: 0.9em; min-width: 2.2ch; height: 1.2em; margin: 0 2px;
            border: none; border-bottom: 2px solid #666; background: var(--input-bg);
            text-align: center; vertical-align: middle;
        }
        .word-span { display: inline; padding: 0; margin: 0; }
    </style>
</head>

<body>
<div class="app-container" id="app">
    <nav class="footer-actions">
        <button class="btn-danger edit-only" onclick="handleClear()">清空</button>
        <button class="exercise-only" onclick="copyFullText()" style="background:#f3e5f5;">复制</button>
        <button id="boldModeBtn" class="exercise-only" onclick="toggleBoldMode()">加粗: 关</button>
        <button id="delModeBtn" class="exercise-only" onclick="toggleDeleteMode()">重置: 关</button>
        <button class="btn-primary edit-only" onclick="toggleMode(true)">开始练习</button>
        <button class="btn-primary exercise-only" onclick="toggleMode(false)">← 返回</button>
    </nav>

    <main class="main-area">
        <textarea id="inputText" placeholder="在此粘贴文章内容..."></textarea>
        <div id="clozeContent"></div>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
        authDomain: "cloze-master-pro.firebaseapp.com",
        databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "cloze-master-pro",
        storageBucket: "cloze-master-pro.firebasestorage.app",
        messagingSenderId: "697808901954",
        appId: "1:697808901954:web:32455d94bf67e522e01adb"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getDatabase(fbApp);

    // --- 全局状态 ---
    window.currentFontSize = 26;
    window.manualPositions = [];
    window.boldPositions = [];
    window.isBoldMode = false;
    window.isDeleteMode = false;
    window.isCPressed = false;
    let answers = [];
    const app = document.getElementById('app');
    const inputArea = document.getElementById('inputText');
    const clozeContent = document.getElementById('clozeContent');

    // --- 核心同步函数 ---
    window.getDocId = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const customId = urlParams.get('customid');
        if (customId && customId.trim() !== "") return "cid_" + customId.trim();
        const text = inputArea.value.trim();
        if (!text) return null;
        return btoa(unescape(encodeURIComponent(text.substring(0, 25)))).replace(/[/+=]/g, "");
    };

    function getTopWordIndex() {
        const offset = 45; 
        const x = window.innerWidth / 2;
        const el = document.elementFromPoint(x, offset);
        return (el && el.dataset.index) ? parseInt(el.dataset.index) : 0;
    }

    window.savePositions = function() {
        const id = window.getDocId();
        if (!id) return;
        const topIdx = getTopWordIndex();
        set(ref(db, 'clozes/' + id), {
            positions: window.manualPositions,
            boldPositions: window.boldPositions,
            topIndex: topIdx,
            ts: Date.now()
        });
    };

    window.syncDownload = async function() {
        const id = window.getDocId();
        if (!id) return;
        let snapshot = await get(child(ref(db), 'clozes/' + id));
        
        // 兼容旧版 ID
        if (!snapshot.exists()) {
            const oldId = btoa(unescape(encodeURIComponent(inputArea.value.substring(0, 25)))).replace(/[/+=]/g, "");
            snapshot = await get(child(ref(db), 'clozes/' + oldId));
        }

        if (snapshot.exists()) {
            const data = snapshot.val();
            window.manualPositions = data.positions || [];
            window.boldPositions = data.boldPositions || [];
            if (app.classList.contains('exercise-mode')) {
                renderCloze();
                if (data.topIndex !== undefined) {
                    setTimeout(() => {
                        const targetEl = document.querySelector(`[data-index="${data.topIndex}"]`);
                        if (targetEl) {
                            targetEl.scrollIntoView({ behavior: 'auto', block: 'start' });
                            window.scrollBy(0, -45);
                        }
                    }, 400);
                }
            }
        }
    };

    // --- 业务逻辑 ---
    window.toggleMode = function(isExercise) {
        if (isExercise) {
            if (!inputArea.value.trim()) return alert("内容为空");
            renderCloze();
            app.classList.add('exercise-mode');
        } else {
            app.classList.remove('exercise-mode');
        }
    };

    window.renderCloze = function() {
        const segments = inputArea.value.split(/([a-zA-Z]+|[\u4e00-\u9fa5]|[^\s\w\u4e00-\u9fa5]+)/g);
        answers = [];
        let unitCount = 0;
        clozeContent.innerHTML = segments.map(seg => {
            if (!seg || !seg.trim()) return seg;
            const idx = unitCount++;
            if (window.manualPositions.includes(idx)) {
                answers.push(seg);
                const isChinese = /[\u4e00-\u9fa5]/.test(seg);
                const boxWidth = isChinese ? 2 : (seg.length + 0.1);
                return `<input class="cloze-display-input" data-id="${answers.length - 1}" data-index="${idx}" 
                        style="width:${boxWidth}ch;" oninput="window.validateInput(this)" placeholder="${isChinese ? '?' : window.getHint(seg)}">`;
            }
            const boldClass = window.boldPositions.includes(idx) ? 'word-bold' : '';
            return `<span class="word-span ${boldClass}" data-index="${idx}">${seg}</span>`;
        }).join("");
        bindEvents();
    };

    window.validateInput = function(el) {
        const ans = answers[el.dataset.id];
        const val = el.value.trim();
        const isMatch = ans.toLowerCase().startsWith(val.toLowerCase());
        el.style.backgroundColor = (val.toLowerCase() === ans.toLowerCase()) ? "#c8f7c5" : (isMatch ? "#fffde7" : "#f7c5c5");
    };

    window.getHint = (w) => w.length <= 2 ? w[0] + "_" : w[0] + "_".repeat(w.length - 2) + w[w.length-1];

    function bindEvents() {
        clozeContent.onclick = (e) => {
            const target = e.target;
            const idx = parseInt(target.dataset.index);
            if (!app.classList.contains('exercise-mode')) return;

            if (window.isBoldMode && target.classList.contains('word-span')) {
                window.boldPositions = window.boldPositions.includes(idx) ? window.boldPositions.filter(i => i !== idx) : [...window.boldPositions, idx];
                window.isBoldMode = false;
                updateModeButtons();
                renderCloze();
                window.savePositions();
            } else if (target.tagName === 'INPUT' && (window.isCPressed || window.isDeleteMode)) {
                window.manualPositions = window.manualPositions.filter(i => i !== idx);
                renderCloze();
                window.savePositions();
            } else if (target.classList.contains('word-span') && !window.isDeleteMode && !window.isBoldMode) {
                // 单击复制单词
                navigator.clipboard.writeText(target.innerText.trim());
            }
        };
    }

    window.toggleBoldMode = () => { window.isBoldMode = !window.isBoldMode; window.isDeleteMode = false; updateModeButtons(); };
    window.toggleDeleteMode = () => { window.isDeleteMode = !window.isDeleteMode; window.isBoldMode = false; updateModeButtons(); };

    function updateModeButtons() {
        document.getElementById('boldModeBtn').innerText = window.isBoldMode ? "加粗: 开" : "加粗: 关";
        document.getElementById('delModeBtn').innerText = window.isDeleteMode ? "重置: 开" : "重置: 关";
    }

    window.handleClear = () => { if(confirm("清空？")) { inputArea.value = ""; window.manualPositions = []; window.boldPositions = []; renderCloze(); } };

    // --- 初始化入口 ---
    window.onload = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const hash = window.location.hash;
        const customId = urlParams.get('customid');
        let textToLoad = "";

        if (hash && hash.startsWith('#text=')) {
            textToLoad = decodeURIComponent(hash.substring(6));
        } else if (urlParams.get('text')) {
            textToLoad = decodeURIComponent(urlParams.get('text'));
        }

        if (textToLoad) {
            inputArea.value = textToLoad;
            window.toggleMode(true);
            if (customId) set(ref(db, 'texts/cid_' + customId.trim()), textToLoad);
        } else if (customId) {
            const snap = await get(child(ref(db), 'texts/cid_' + customId.trim()));
            if (snap.exists()) {
                inputArea.value = snap.val();
                window.toggleMode(true);
            }
        }
        
        document.body.classList.add('app-ready');
        setTimeout(() => { window.syncDownload(); }, 600);
    };

    // 滚动自动同步
    let scrollTimer;
    window.addEventListener('scroll', () => {
        if (!app.classList.contains('exercise-mode')) return;
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(() => { window.savePositions(); }, 1000);
    });

    window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'c') window.isCPressed = true; });
    window.addEventListener('keyup', (e) => { if (e.key.toLowerCase() === 'c') window.isCPressed = false; });
</script>
</body>
</html>
