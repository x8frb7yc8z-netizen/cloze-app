<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>极简完形填空 Pro Sync</title>
<style>

/* 加粗单词的样式 */
.word-bold {
    font-weight: 800;
    color: #000;
    /* 可以加个底色或者下划线增加辨识度 */

}
:root { --primary: #43a047; --bg: #f8f9fa; --danger: #ff5252; --input-bg: #fffde7; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; width:100%; min-height:100%; font-family:-apple-system, sans-serif; background:#fff; }

/* 1. 修正容器和导航条 */
.app-container { 
    display: flex; 
    flex-direction: column; 

    padding-top: 35px; /* 略大于导航条高度 */
}
.btn-group { display:flex; align-items:center; gap:8px; }

.main-area { 
    flex: 1; 
    position: relative; 
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch;
}
/* 2. 核心修正：取消绝对定位，改用相对定位 */
#inputText, #clozeContent {
    width: 100%; 
    min-height: calc(100vh - 35px);
    text-align: center;
    padding: 20px 0px; /* 增加顶部间距防止被挡 */
    border: none; 
    outline: none;
    font-size: 20px !important; 
    line-height: 1; 
    font-family: inherit;
    white-space: pre-wrap; 
    word-break: break-word;
    position: relative; /* 改为 relative */
    display: block;
}
/* 2. 只有当屏幕真的很窄（手机竖屏）时才切换 */
@media screen and (max-width: 500px) {
    #inputText, #clozeContent {
        font-size: 26px !important;
    }
}
#inputText { resize: none; }
#clozeContent { display: none; } /* 默认隐藏 */

.exercise-mode #inputText { display: none !important; }
.exercise-mode #clozeContent { display: block !important; }
.exercise-mode .edit-only { display: none; }
.exercise-mode .exercise-only { display: flex !important; flex: 1; }

/* 核心：输入框样式 */
.cloze-display-input {
    font-size: 0.9em; 
    min-width: 2.2ch; 
    height: 1.2em;
    margin: 0 2px;
    border: none; 
    border-bottom: 2px solid #666;
    background: var(--input-bg);
    text-align: center;
    border-radius: 0;
    -webkit-appearance: none; /* 移除 iOS 默认阴影 */
    vertical-align: middle;
}

/* 1. 导航条改为顶部固定 */
.footer-actions { 
    display: flex; 
    background: #fff; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    z-index: 1000; /* 确保在最顶层 */
    height: 30px; 
    border-bottom: 1px solid #ddd;
}
/* 2. 按钮文字和间距调整 */
.footer-actions button { 
    flex: 1; 
    padding: 0; /* 移除内边距，让文字垂直居中 */
    border: none; 
    font-weight: bold; 
    cursor: pointer; 
    /* 核心修改：字号稍微缩小一点以配合矮窄的导航条 */
    font-size: 14px; 
    display: flex;
    align-items: center;
    justify-content: center;
}
/* 3. 字体调节区域的高度同步 */
.font-ctrl {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 0 10px;
    font-size: 14px;
}
.btn-primary { background:var(--primary); color:white; }
.btn-danger { color:var(--danger); background:#fff8f8; }

#clozeContent {
    /* 允许容器内的文本正常响应系统手势 */
    -webkit-user-select: text;
    user-select: text;
    
    /* 解决部分浏览器在滚动中长按失效的问题 */
    pointer-events: auto; 
    
    /* 增加行高，减少手指点击时的误差 */
    line-height: 1.2;
}

.word-span {
    -webkit-user-select: text !important;
    user-select: text !important;
    -webkit-touch-callout: default !important;
    
    /* 关键：去掉 padding 防止坐标偏移 */
    padding: 0 !important;
    margin: 0 !important;
    display: inline; /* 确保它像普通文字一样排列 */
}

.cloze-display-input {
    /* 输入框通常长按会弹出全选/粘贴，保持默认即可 */
    -webkit-user-select: auto;
}
.exercise-only { display: none !important; }
</style>
</head>

<body>
<div class="app-container" id="app">
    <nav class="footer-actions">
        <button class="btn-danger edit-only" onclick="handleClear()">清空</button>
	<button class="exercise-only" onclick="copyFullText()" style="background:#f3e5f5;">复制</button>
	<button id="boldModeBtn" class="exercise-only" onclick="toggleBoldMode()" style="background:#e8f5e9;">加粗: 关</button>
        <button id="delModeBtn" class="exercise-only" onclick="toggleDeleteMode()">挖空: 关</button>
        <div class="font-ctrl edit-only">
             <button class="font-btn" onclick="changeFontSize(-2)">A-</button>
             <span id="fontSizeLabel">26</span>
             <button class="font-btn" onclick="changeFontSize(2)">A+</button>
        </div>
        <button class="btn-primary edit-only" onclick="toggleMode(true)">开始练习</button>
        <button class="btn-primary exercise-only" onclick="toggleMode(false)">← 返回修改</button>
    </nav>

    <main class="main-area">
        <textarea id="inputText" placeholder="在此粘贴文章内容..."></textarea>
        <div id="clozeContent"></div>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // 1. Firebase 配置
    const firebaseConfig = {
        apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
        authDomain: "cloze-master-pro.firebaseapp.com",
        databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "cloze-master-pro",
        storageBucket: "cloze-master-pro.firebasestorage.app",
        messagingSenderId: "697808901954",
        appId: "1:697808901954:web:32455d94bf67e522e01adb"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getDatabase(fbApp);

    // 2. 全局变量定义
    let currentFontSize = 26;
    let manualPositions = [];
    let boldPositions = [];
    let isBoldMode = false;
    let isDeleteMode = false;
    let isCPressed = false;
    let answers = [];
    let scrollTimer;

    const app = document.getElementById('app');
    const inputArea = document.getElementById('inputText');
    const clozeContent = document.getElementById('clozeContent');

    // --- 核心同步逻辑 ---

    window.getDocId = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const customId = urlParams.get('customid');
        if (customId && customId.trim() !== "") return "cid_" + customId.trim();
        const text = inputArea.value.trim();
        if (!text) return null;
        try {
            return btoa(unescape(encodeURIComponent(text.substring(0, 25)))).replace(/[/+=]/g, "");
        } catch(e) { return "default_doc"; }
    };

    function getTopWordIndex() {
        const offset = 45; 
        const x = window.innerWidth / 2;
        const el = document.elementFromPoint(x, offset);
        return (el && el.dataset.index) ? parseInt(el.dataset.index) : 0;
    }

    window.syncUpload = async function() {
        const id = window.getDocId();
        if (!id) return;
        const topIdx = getTopWordIndex();
        try {
            await set(ref(db, 'clozes/' + id), { 
                content: inputArea.value,
                positions: manualPositions,
                boldPositions: boldPositions,
                topIndex: topIdx,
                ts: Date.now() 
            });
            console.log("Firebase: Sync Upload Success");
        } catch (e) {
            console.error("Firebase: Sync Upload Failed", e);
        }
    };

    window.syncDownload = async function() {
        const id = window.getDocId();
        if (!id) return;
        let snapshot = await get(child(ref(db), 'clozes/' + id));
        
        // 兼容旧 ID 逻辑
        if (!snapshot.exists() && inputArea.value.trim()) {
            const oldId = btoa(unescape(encodeURIComponent(inputArea.value.substring(0, 25)))).replace(/[/+=]/g, "");
            snapshot = await get(child(ref(db), 'clozes/' + oldId));
        }

        if (snapshot.exists()) {
            const data = snapshot.val();
            if (!inputArea.value.trim() && data.content) {
                inputArea.value = data.content;
            }
            if (inputArea.value.trim()) {
                manualPositions = data.positions || [];
                boldPositions = data.boldPositions || [];
                app.classList.add('exercise-mode');
                renderCloze(); 
                if (data.topIndex !== undefined) {
                    setTimeout(() => {
                        const targetEl = document.querySelector(`[data-index="${data.topIndex}"]`);
                        if (targetEl) {
                            targetEl.scrollIntoView({ behavior: 'auto', block: 'start' });
                            window.scrollBy(0, -45);
                        }
                    }, 600);
                }
            }
        }
    };

    // --- 业务逻辑 ---

    function renderCloze() {
        const segments = inputArea.value.split(/([a-zA-Z]+|[\u4e00-\u9fa5]|[^\s\w\u4e00-\u9fa5]+)/g);
        answers = [];
        let unitCount = 0;

        clozeContent.innerHTML = segments.map(seg => {
            if (!seg || !seg.trim()) return seg;
            const idx = unitCount++;
            const isChinese = /[\u4e00-\u9fa5]/.test(seg);
            if (manualPositions.includes(idx)) {
                answers.push(seg);
                const boxWidth = isChinese ? 2 : (seg.length + 0.1); 
                return `<input class="cloze-display-input" data-id="${answers.length - 1}" data-index="${idx}" 
                        style="width:${boxWidth}ch;" placeholder="${isChinese ? '?' : getHint(seg)}">`;
            }
            const boldClass = boldPositions.includes(idx) ? 'word-bold' : '';
            return `<span class="word-span ${boldClass}" data-index="${idx}">${seg}</span>`;
        }).join("");
        bindEvents();
    }

    function bindEvents() {
        // 使用委托和统一监听
        const inputs = clozeContent.querySelectorAll('input');
        inputs.forEach(input => {
            input.oninput = () => validateInput(input);
            input.onkeydown = (e) => handleSpaceKey(e, input);
        });
    }

    // 辅助：验证输入
    function validateInput(el) {
        const ans = answers[el.dataset.id];
        const val = el.value.trim();
        const isMatch = ans.toLowerCase().startsWith(val.toLowerCase());
        el.style.backgroundColor = (val.toLowerCase() === ans.toLowerCase()) ? "#c8f7c5" : (isMatch ? "var(--input-bg)" : "#f7c5c5");
        el.style.color = isMatch ? "#000" : "var(--danger)";
    }

    // 辅助：获取提示
    function getHint(w) { 
        return w.length <= 2 ? w[0] + "_" : w[0] + "_".repeat(w.length - 2) + w[w.length-1]; 
    }

    // 保存位置并触发上传
    function savePositions() {
        if (typeof window.syncUpload === 'function') {
            window.syncUpload();
        }
    }

    // --- UI 交互函数 (挂载到 window 供 HTML 按钮调用) ---

    window.toggleMode = (isExercise) => {
        if (isExercise) {
            if (!inputArea.value.trim()) return alert("请先输入内容");
            renderCloze();
            app.classList.add('exercise-mode');
            window.scrollTo(0, 0);
        } else {
            app.classList.remove('exercise-mode');
        }
    };

    window.toggleBoldMode = () => {
        isBoldMode = !isBoldMode;
        if (isBoldMode) isDeleteMode = false;
        updateModeButtons();
    };

    window.toggleDeleteMode = () => {
        isDeleteMode = !isDeleteMode;
        if (isDeleteMode) isBoldMode = false;
        updateModeButtons();
    };

    function updateModeButtons() {
        const bBtn = document.getElementById('boldModeBtn');
        const dBtn = document.getElementById('delModeBtn');
        if(bBtn) {
            bBtn.innerText = isBoldMode ? "加粗: 开" : "加粗: 关";
            bBtn.style.backgroundColor = isBoldMode ? "#a5d6a7" : "#fff";
        }
        if(dBtn) {
            dBtn.innerText = isDeleteMode ? "重置: 开" : "重置: 关";
            dBtn.style.backgroundColor = isDeleteMode ? "#ffe0b2" : "#fff";
        }
    }

    window.handleClear = () => {
        if(confirm("确定清空吗？")) {
            inputArea.value = "";
            manualPositions = [];
            boldPositions = [];
            savePositions();
            renderCloze();
        }
    };

    window.changeFontSize = (delta) => {
        currentFontSize += delta;
        applyFontSize(currentFontSize);
        localStorage.setItem('cloze_user_font_size', currentFontSize);
    };

    function applyFontSize(size) {
        inputArea.style.fontSize = clozeContent.style.fontSize = size + "px";
        const label = document.getElementById('fontSizeLabel');
        if(label) label.innerText = size;
    }

    // --- 初始化入口 ---

    window.onload = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const textFromHash = hashParams.get('text');
        const customId = urlParams.get('customid');

        // 字号初始化
        const savedSize = localStorage.getItem('cloze_user_font_size');
        currentFontSize = savedSize ? parseInt(savedSize) : (window.innerWidth < 500 ? 26 : 20);
        applyFontSize(currentFontSize);

        if (textFromHash) {
            inputArea.value = decodeURIComponent(textFromHash);
            renderCloze();
            app.classList.add('exercise-mode');
            setTimeout(window.syncUpload, 1500);
        } else if (customId) {
            await window.syncDownload();
        }
    };

    // 事件监听
    inputArea.oninput = savePositions;
    window.addEventListener('scroll', () => {
        if (!app.classList.contains('exercise-mode')) return;
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(savePositions, 1000);
    });

    // 处理加粗和挖空点击
    clozeContent.onclick = (e) => {
        const target = e.target;
        const idx = parseInt(target.dataset.index);
        if (!app.classList.contains('exercise-mode')) return;

        if (isBoldMode && target.classList.contains('word-span')) {
            if (boldPositions.includes(idx)) {
                boldPositions = boldPositions.filter(i => i !== idx);
            } else {
                boldPositions.push(idx);
            }
            isBoldMode = false;
            updateModeButtons();
            savePositions();
            renderCloze();
        } else if (isDeleteMode && target.tagName === 'INPUT') {
            manualPositions = manualPositions.filter(i => i !== idx);
            savePositions();
            renderCloze();
        } else if (target.classList.contains('word-span')) {
            // 普通点击复制等逻辑在此处扩展...
        }
    };

    // 键盘监听
    window.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'c') isCPressed = true; });
    window.addEventListener('keyup', (e) => { if (e.key.toLowerCase() === 'c') isCPressed = false; });
    
    // 暴露给按钮的辅助函数需挂载
    window.copyFullText = () => {
        const fullText = inputArea.value.trim();
        if (!fullText) return;
        navigator.clipboard.writeText(fullText).then(() => alert("复制成功"));
    };
    
</script>
</body>
</html>
