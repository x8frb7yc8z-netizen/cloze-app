<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>极简完形填空 Pro Sync</title>
<style>
:root { --primary: #43a047; --bg: #f8f9fa; --danger: #ff5252; --input-bg: #fffde7; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; width:100%; height:100dvh; font-family:-apple-system, sans-serif; background:#fff; overflow:hidden; }

.app-container { display: flex; flex-direction: column; height: 100dvh; padding-top: 35px; }

/* 1. 顶部导航条：高度固定，防止遮挡 */
.footer-actions { 
    display: flex; background: #fff; position: fixed; top: 0; left: 0; 
    width: 100%; z-index: 2000; height: 35px; border-bottom: 1px solid #ddd;
}
.footer-actions button { flex: 1; border: none; font-weight: bold; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; }
.btn-primary { background: var(--primary); color: white; }
.btn-danger { color: var(--danger); background: #fff8f8; }
.btn-warn { background: #ff9800; color: white; }

/* 2. 主区域：物理隔离 */
.main-area { flex: 1; position: relative; overflow: hidden; }
.view-panel { width: 100%; height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; display: none; padding: 20px 15px 150px; }

/* 编辑模式下的文本框 */
#inputText { width: 100%; height: 100%; border: none; outline: none; resize: none; font-family: inherit; line-height: 1.5; text-align: center; font-size: 20px; }

/* 展示区域：挖空与练习共用，但逻辑由 class 控制 */
#clozeContent { text-align: center; line-height: 1.8; word-break: break-word; font-size: 20px; }
.word-span { 
    -webkit-user-select: text !important; user-select: text !important; 
    -webkit-touch-callout: default !important; position: relative; z-index: 10;
}

/* 挖空模式下的高亮样式 */
.mode-select .word-span.selected { background: #c8e6c9; border-bottom: 2px solid green; border-radius: 4px; }

/* 练习模式下的输入框 */
.cloze-display-input { 
    font-size: inherit; border: none; border-bottom: 1.5px solid #666;
    background: var(--input-bg); outline: none; text-align: center;
    border-radius: 0; -webkit-appearance: none; margin: 0 1px;
}

/* 3. 模式控制逻辑 (CSS 控制显示) */
.mode-edit #panel-edit { display: block; }
.mode-select #panel-cloze, .mode-exercise #panel-cloze { display: block; }

/* 按钮显示显隐 */
.edit-only, .select-only, .exercise-only { display: none !important; }
.mode-edit .edit-only { display: flex !important; }
.mode-select .select-only { display: flex !important; }
.mode-exercise .exercise-only { display: flex !important; }

@media screen and (max-width: 500px) { #inputText, #clozeContent { font-size: 26px; } }
</style>
</head>

<body class="mode-edit">
<div class="app-container" id="app">
    <nav class="footer-actions">
        <button class="btn-danger edit-only" onclick="handleClear()">清空</button>
        <button class="btn-primary edit-only" onclick="smartStart()">开始练习</button>
        
        <button class="select-only" onclick="enterMode('edit')">← 返回编辑</button>
        <div class="select-only" style="flex:1.5; font-size:12px; display:flex; align-items:center; justify-content:center; color:orange;">点击单词挖空</div>
        <button class="btn-primary select-only" onclick="enterMode('exercise')">开始填空 →</button>

        <button class="exercise-only" onclick="enterMode('edit')">← 修改原文</button>
        <button class="btn-warn exercise-only" onclick="enterMode('select')">调整挖空</button>
        <div class="exercise-only" style="flex:1; font-size:12px; display:flex; align-items:center; justify-content:center; color:green;">练习中</div>
    </nav>

    <main class="main-area">
        <div id="panel-edit" class="view-panel">
            <textarea id="inputText" placeholder="在此粘贴文章内容..."></textarea>
        </div>
        <div id="panel-cloze" class="view-panel">
            <div id="clozeContent"></div>
        </div>
    </main>
</div>

<script>
let currentMode = 'edit';
let manualPositions = JSON.parse(localStorage.getItem('cloze_single_positions')) || [];
let answers = [];
let eventsBound = false;

const inputArea = document.getElementById('inputText');
const clozeContent = document.getElementById('clozeContent');

// 1. 智能启动
function smartStart() {
    if (!inputArea.value.trim()) return alert("请先输入内容");
    // 判断是否有空位
    if (manualPositions.length > 0) {
        enterMode('exercise');
    } else {
        enterMode('select');
    }
}

// 2. 模式切换
function enterMode(mode) {
    currentMode = mode;
    document.body.className = 'mode-' + mode;
    if (mode !== 'edit') renderContent();
}

// 3. 渲染逻辑
function renderContent() {
    const text = inputArea.value.trim();
    const segments = text.split(/([a-zA-Z]+|[\u4e00-\u9fa5]|[^\s\w\u4e00-\u9fa5]+)/g);
    answers = [];
    let unitCount = 0;

    clozeContent.innerHTML = segments.map(seg => {
        if (!seg || !seg.trim()) return seg;
        const idx = unitCount++;
        const isSelected = manualPositions.includes(idx);

        // 填空模式：只有选中的变 Input
        if (currentMode === 'exercise' && isSelected) {
            answers.push(seg);
            const isChinese = /[\u4e00-\u9fa5]/.test(seg);
            const boxWidth = isChinese ? 2 : (seg.length + 0.1);
            return `<input class="cloze-display-input" data-id="${answers.length-1}" 
                    style="width:${boxWidth}ch;" oninput="validateInput(this)" 
                    placeholder="${isChinese ? '?' : getHint(seg)}">`;
        }
        
        // 挖空模式：渲染为普通 Span，如果是选中的则带高亮 Class
        const selectedClass = (currentMode === 'select' && isSelected) ? 'selected' : '';
        return `<span class="word-span ${selectedClass}" data-index="${idx}">${seg}</span>`;
    }).join("");

    bindEvents();
}

// 4. 事件绑定：利用事件委托 + Passive Listener 优化 iOS
function bindEvents() {
    if (eventsBound) return;
    eventsBound = true;

    let lastTap = 0;
    clozeContent.addEventListener('click', (e) => {
        const el = e.target;

        // 只有挖空模式处理点击
        if (currentMode === 'select' && el.classList.contains('word-span')) {
            const now = Date.now();
            const idx = parseInt(el.dataset.index);

            // 双击判定
            if (now - lastTap < 300) {
                if (manualPositions.includes(idx)) {
                    manualPositions = manualPositions.filter(i => i !== idx);
                } else {
                    manualPositions.push(idx);
                }
                saveData();
                renderContent();
                lastTap = 0;
                return;
            }
            lastTap = now;
        }
    }, { passive: true });
}

function validateInput(el) {
    const ans = answers[el.dataset.id];
    const val = el.value.trim().toLowerCase();
    const isMatch = ans.toLowerCase().startsWith(val);
    el.style.backgroundColor = (val === ans.toLowerCase()) ? "#c8f7c5" : (isMatch ? "var(--input-bg)" : "#f7c5c5");
}

function getHint(w) { return w.length <= 2 ? w[0] + "_" : w[0] + "_".repeat(w.length - 2) + w[w.length-1]; }
function handleClear() { if(confirm("清空？")) { inputArea.value = ""; manualPositions = []; saveData(); location.reload(); } }
function saveData() {
    localStorage.setItem('cloze_single_positions', JSON.stringify(manualPositions));
    localStorage.setItem('cloze_single_content', inputArea.value);
}

window.onload = () => {
    const saved = localStorage.getItem('cloze_single_content');
    if (saved) inputArea.value = saved;
};
</script>
</body>
</html>
