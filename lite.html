<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>极简完形填空 Pro Sync</title>
<style>
:root { --primary: #43a047; --bg: #f8f9fa; --danger: #ff5252; --input-bg: #fffde7; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

/* 核心滚动修正：严禁在 body 设 overflow:hidden，除非你用 JS 接管滚动 */
html, body { margin:0; padding:0; width:100%; min-height:100dvh; font-family:-apple-system, sans-serif; background:#fff; }

.app-container { 
    display: flex; 
    flex-direction: column; 
    padding-top: 40px; 
}

.footer-actions { 
    display: flex; 
    background: #fff; 
    position: fixed; 
    top: 0; left: 0; width: 100%; 
    z-index: 2000; 
    height: 35px; 
    border-bottom: 1px solid #ddd;
}
.footer-actions button { 
    flex: 1; border: none; font-weight: bold; font-size: 14px; 
    display: flex; align-items: center; justify-content: center;
    background: transparent;
}

.main-area { flex: 1; width: 100%; padding: 10px; }

#inputText, #clozeContent {
    width: 100%; 
    min-height: 300px;
    text-align: center;
    border: none; 
    outline: none;
    font-size: 26px !important; 
    line-height: 1.8; 
    white-space: pre-wrap; 
    word-break: break-word;
}
#inputText { resize: none; }

.cloze-display-input {
    font-size: 0.9em; 
    min-width: 2.2ch; 
    height: 1.2em;
    margin: 0 2px;
    border: none; 
    border-bottom: 2px solid #666;
    background: var(--input-bg);
    text-align: center;
    border-radius: 0;
    -webkit-appearance: none;
    vertical-align: middle;
}

.exercise-mode #inputText { display: none !important; }
.exercise-mode #clozeContent { display: block !important; }
.exercise-mode .edit-only { display: none !important; }
.exercise-mode .exercise-only { display: flex !important; }

.btn-primary { background:var(--primary) !important; color:white; }
.btn-danger { color:var(--danger) !important; }
.exercise-only { display: none !important; }
</style>
</head>

<body>
<div class="app-container" id="app">
    <nav class="footer-actions">
        <button class="btn-danger edit-only" onclick="handleClear()">清空</button>
        <button id="delModeBtn" class="exercise-only" onclick="toggleDeleteMode()">重置: 关</button>
        <button class="btn-primary edit-only" onclick="toggleMode(true)">开始练习</button>
        <button class="btn-primary exercise-only" onclick="toggleMode(false)">返回修改</button>
    </nav>

    <main class="main-area">
        <textarea id="inputText" placeholder="在此粘贴文章内容..."></textarea>
        <div id="clozeContent"></div>
    </main>
</div>

<script type="module">
  // Firebase 逻辑保持不变...
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
    authDomain: "cloze-master-pro.firebaseapp.com",
    databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "cloze-master-pro",
    storageBucket: "cloze-master-pro.firebasestorage.app",
    messagingSenderId: "697808901954",
    appId: "1:697808901954:web:32455d94bf67e522e01adb"
  };

  const fbApp = initializeApp(firebaseConfig);
  const db = getDatabase(fbApp);

  window.getDocId = function() {
    const text = document.getElementById('inputText').value.trim();
    if (!text) return null;
    try { return btoa(unescape(encodeURIComponent(text.substring(0, 25)))).replace(/[/+=]/g, ""); } 
    catch(e) { return "default_doc"; }
  };

  window.syncUpload = async function() {
    const id = getDocId();
    if (!id) return;
    set(ref(db, 'clozes/' + id), { positions: manualPositions, ts: Date.now() });
  };

  window.syncDownload = async function() {
    const id = getDocId();
    if (!id) return;
    const snapshot = await get(child(ref(db), 'clozes/' + id));
    if (snapshot.exists()) {
      const data = snapshot.val();
      if (data.positions) {
        manualPositions = data.positions;
        localStorage.setItem('cloze_single_positions', JSON.stringify(manualPositions));
        if (document.getElementById('app').classList.contains('exercise-mode')) renderCloze();
      }
    }
  };
</script>

<script>
let manualPositions = JSON.parse(localStorage.getItem('cloze_single_positions')) || [];
let answers = [];
let isDeleteMode = false;

const inputArea = document.getElementById('inputText');
const clozeContent = document.getElementById('clozeContent');

window.onload = () => {
    const savedText = localStorage.getItem('cloze_single_content');
    if (savedText) inputArea.value = savedText;
    if (inputArea.value.trim()) toggleMode(true);
};

async function toggleMode(isExercise) {
    const app = document.getElementById('app');
    if (isExercise) {
        if (!inputArea.value.trim()) return;
        renderCloze();
        app.classList.add('exercise-mode');
        window.scrollTo(0, 0);
        if (window.syncDownload) await window.syncDownload();
    } else {
        app.classList.remove('exercise-mode');
    }
}

function renderCloze() {
    const text = inputArea.value;
    const segments = text.split(/([a-zA-Z]+|[\u4e00-\u9fa5]|[^\s\w\u4e00-\u9fa5]+)/g);
    answers = [];
    let unitCount = 0;

    clozeContent.innerHTML = segments.map(seg => {
        if (!seg || !seg.trim()) return seg;
        const idx = unitCount++;
        const isChinese = /[\u4e00-\u9fa5]/.test(seg);

        if (manualPositions.includes(idx)) {
            answers.push(seg);
            const boxWidth = isChinese ? 2 : (seg.length + 0.5); 
            return `<input type="text" inputmode="text" class="cloze-display-input" 
                    data-id="${answers.length - 1}" data-index="${idx}" 
                    style="width:${boxWidth}ch;" 
                    oninput="validateInput(this)" onkeydown="handleKey(event, this)">`;
        }
        return `<span class="word-span" data-index="${idx}">${seg}</span>`;
    }).join("");
    bindEvents();
}

function bindEvents() {
    const inputs = clozeContent.querySelectorAll('input');
    inputs.forEach(el => {
        el.onclick = (e) => {
            if (isDeleteMode) { e.preventDefault(); recover(el, false); }
        };
        el.onfocus = () => setTimeout(() => el.setSelectionRange(0, 9999), 50);
    });

    clozeContent.querySelectorAll('.word-span').forEach(el => {
        el.ondblclick = () => {
            const idx = parseInt(el.dataset.index);
            if (!manualPositions.includes(idx)) {
                manualPositions.push(idx);
                savePositions();
                renderCloze();
            }
        };
    });
}

function validateInput(el) {
    const ans = answers[el.dataset.id];
    const val = el.value.trim();
    const isMatch = ans.toLowerCase().startsWith(val.toLowerCase());
    el.style.backgroundColor = (val.toLowerCase() === ans.toLowerCase()) ? "#c8f7c5" : (isMatch ? "var(--input-bg)" : "#f7c5c5");
}

function handleKey(e, el) {
    if (e.key === ' ') {
        e.preventDefault();
        const target = answers[el.dataset.id];
        if (el.value.length < target.length) {
            el.value = target.substring(0, el.value.length + 1);
            validateInput(el);
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        const next = clozeContent.querySelectorAll('input')[parseInt(el.dataset.id) + 1];
        if (next) next.focus(); else el.blur();
    }
}

function toggleDeleteMode() {
    isDeleteMode = !isDeleteMode;
    const btn = document.getElementById('delModeBtn');
    btn.innerText = isDeleteMode ? "重置: 开" : "重置: 关";
    btn.style.background = isDeleteMode ? "#ffe0b2" : "transparent";
}

function recover(el, confirmReq = true) {
    if (confirmReq && !confirm("恢复显示？")) return;
    manualPositions = manualPositions.filter(i => i !== parseInt(el.dataset.index));
    savePositions();
    renderCloze();
}

function savePositions() { 
    localStorage.setItem('cloze_single_positions', JSON.stringify(manualPositions)); 
    localStorage.setItem('cloze_single_content', inputArea.value);
    if (window.syncUpload) window.syncUpload();
}

function handleClear() {
    if(confirm("确定清空吗？")) {
        inputArea.value = ""; manualPositions = [];
        savePositions(); renderCloze();
    }
}
inputArea.oninput = savePositions;
</script>
</body>
</html>
