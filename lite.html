<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>AI æ„ç¾¤åŒæ­¥æ’­æ”¾å™¨ Pro - Sync Edition</title>
    <style>
        /* ä¿æŒä½ çš„åŸç‰ˆ White Edition é£æ ¼ */
        html, body { width: 100%; margin: 0; padding: 0; overflow: hidden; background: #ffffff; }
        :root { --primary: #00a1d6; --text-main: #1d1d1f; --text-dim: #86868b; }
        body { font-family: -apple-system, "SF Pro Display", sans-serif; display: flex; flex-direction: column; height: 100vh; }
        .video-wrapper { flex: 0 0 auto; background: #000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; }
        video { max-height: 40vh; width: 100%; display: block; }
        .transcript-container { flex: 1; overflow-y: auto; padding: 40px 0; background: #ffffff; scroll-behavior: smooth; }
        .line { padding: 18px 20px; cursor: pointer; transition: all 0.3s ease; text-align: center; }
        .line.active { color: var(--primary); transform: scale(1.04); font-weight: 600; }
        .content { line-height: 1.5; font-size: 22px; color: var(--text-main); }
        #status-bar { position: fixed; bottom: 10px; left: 10px; font-size: 11px; color: var(--text-dim); background: rgba(255,255,255,0.8); padding: 4px 8px; border-radius: 4px; z-index: 100; pointer-events: none; }
        .btn-upload { position: absolute; top: 10px; right: 10px; z-index: 200; opacity: 0.5; font-size: 20px; cursor: pointer; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div id="status-bar">ç­‰å¾…åŒæ­¥...</div>
<label class="btn-upload">ğŸ“<input type="file" id="videoInput" accept="video/*"></label>

<div class="video-wrapper">
    <video id="videoPlayer" controls playsinline webkit-playsinline></video>
</div>

<div class="transcript-container" id="transcript">
    <div style="text-align: center; color: #86868b; margin-top: 50px;">ç­‰å¾… Anki ä¼ è¾“æ•°æ®...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, set, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

// ä½¿ç”¨ä½ éªŒè¯é€šè¿‡çš„é…ç½®
const firebaseConfig = {
    apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
    authDomain: "cloze-master-pro.firebaseapp.com",
    databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "cloze-master-pro"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const video = document.getElementById('videoPlayer');
const transcript = document.getElementById('transcript');
const statusBar = document.getElementById('status-bar');

let currentNoteId = null;
let isAutoScrolling = false;
let isRemoteUpdating = false; // é”ï¼šé˜²æ­¢å¾ªç¯åŒæ­¥
let lastSaveTime = 0;

// --- 1. å®æ—¶ç›‘å¬å‡½æ•° (æ ¸å¿ƒæ•´åˆ) ---
function startRealtimeSync(noteId) {
    if (!noteId) return;
    const dbRef = ref(db, 'player_progress/' + noteId);
    
    onValue(dbRef, (snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            // åªæœ‰å½“åå·®å¤§äº 2 ç§’ä¸”ä¸æ˜¯ç”±äºæœ¬åœ°æ­£åœ¨ä¸Šä¼ å¼•èµ·çš„å˜æ›´æ—¶ï¼Œæ‰æ‰§è¡Œè·³è½¬
            const timeDiff = Math.abs(video.currentTime - data.lastTime);
            if (timeDiff > 2 && !isRemoteUpdating) {
                console.log("â˜ï¸ æ£€æµ‹åˆ°äº‘ç«¯è¿›åº¦å˜åŒ–ï¼Œæ­£åœ¨åŒæ­¥...");
                isRemoteUpdating = true; 
                video.currentTime = data.lastTime;
                statusBar.innerText = "äº‘ç«¯åŒæ­¥æˆåŠŸ: " + new Date().toLocaleTimeString();
                
                // è·³è½¬åè§£é”
                setTimeout(() => { isRemoteUpdating = false; }, 1000);
            }
        }
    });
}

// --- 2. è¿›åº¦ä¸Šä¼  (å¸¦èŠ‚æµ) ---
async function saveProgress(noteId, time, index) {
    if (!noteId || isRemoteUpdating) return; 
    const now = Date.now();
    if (now - lastSaveTime < 2500) return; // 2.5ç§’èŠ‚æµ

    lastSaveTime = now;
    try {
        await set(ref(db, 'player_progress/' + noteId), {
            lastTime: time,
            lastIndex: index,
            updatedAt: serverTimestamp()
        });
        statusBar.innerText = "å·²ä¿å­˜è‡³äº‘ç«¯: " + new Date().toLocaleTimeString();
    } catch (e) {
        console.error("åŒæ­¥å¤±è´¥:", e);
    }
}

// --- 3. å­—å¹•è§£æä¸æ¸²æŸ“ (ä¿æŒåŸæ ·) ---
function timeToSeconds(t) {
    const p = t.replace(',', '.').trim().split(':');
    return (+p[0]) * 3600 + (+p[1]) * 60 + (+p[2]);
}

function parseSubtitle(data) {
    const lines = data.replace(/<br\s*\/?>/gi, "\n").split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
    const cues = [];
    for (let i = 0; i < lines.length; i++) {
        const timeMatch = lines[i].match(/(\d{1,2}:\d{2}:\d{2}[.,]\d{3})\s*(?:-->)\s*(\d{1,2}:\d{2}:\d{2}[.,]\d{3})/);
        if (timeMatch) {
            let j = i + 1;
            let textParts = [];
            while (j < lines.length && !lines[j].match(/-->/)) {
                textParts.push(lines[j]);
                j++;
            }
            cues.push({ start: timeToSeconds(timeMatch[1]), text: textParts.join(' ') });
            i = j - 1;
        }
    }
    return cues;
}

function renderSubtitles(cues) {
    transcript.innerHTML = '';
    cues.forEach((cue, index) => {
        const div = document.createElement('div');
        div.className = 'line';
        div.dataset.time = cue.start;
        div.dataset.index = index;
        div.innerHTML = `<div class="content">${cue.text}</div>`;
        div.onclick = () => { video.currentTime = cue.start; video.play(); };
        transcript.appendChild(div);
    });
}

// --- 4. äº‹ä»¶ç›‘å¬ ---
document.getElementById('videoInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) video.src = URL.createObjectURL(file);
});

window.addEventListener('message', (event) => {
    // è°ƒè¯•ç”¨ï¼Œç¡®è®¤æ•°æ®å†…å®¹
    console.log("æ”¶åˆ°æ•°æ®:", event.data);

    if (event.data.type === 'LOAD_SUBTITLES') {
        // 1. å¼ºåˆ¶è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶ç§»é™¤ Firebase ä¸å…è®¸çš„å­—ç¬¦
        const rawId = String(event.data.noteId || "default_note");
        currentNoteId = rawId.replace(/[.#$[\]]/g, '_'); 
        
        // 2. è§£æå¹¶æ¸²æŸ“
        const cues = parseSubtitle(event.data.data);
        renderSubtitles(cues);
        
        // 3. å¯åŠ¨åŒæ­¥
        startRealtimeSync(currentNoteId);
        
        statusBar.innerText = "å¡ç‰‡å·²æ¿€æ´»: " + currentNoteId;
        console.log("âœ… å®æ—¶åŒæ­¥å·²å°±ç»ªï¼ŒID:", currentNoteId);
    }
});

video.addEventListener('timeupdate', () => {
    if (isRemoteUpdating) return; // äº‘ç«¯æ›´æ–°æ—¶ç¦æ­¢è§¦å‘æœ¬åœ°ä¸Šä¼ 
    const lines = document.querySelectorAll('.line');
    const currentTime = video.currentTime;

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const start = parseFloat(line.dataset.time);
        const next = lines[i+1] ? parseFloat(lines[i+1].dataset.time) : Infinity;

        if (currentTime >= start && currentTime < next) {
            if (!line.classList.contains('active')) {
                document.querySelector('.line.active')?.classList.remove('active');
                line.classList.add('active');
                saveProgress(currentNoteId, currentTime, i);
                
                if (!isAutoScrolling) {
                    isAutoScrolling = true;
                    line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => isAutoScrolling = false, 800);
                }
            }
            break;
        }
    }
});

window.parent.postMessage({ type: 'PLAYER_READY' }, '*');
</script>
</body>
</html>
