<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>æç®€å®Œå½¢å¡«ç©º Pro Sync</title>
<style>
:root { --primary: #43a047; --bg: #f8f9fa; --danger: #ff5252; --input-bg: #fffde7; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; width:100%; height:100dvh; font-family:-apple-system, sans-serif; background:#fff; overflow:hidden; }

.app-container { display:flex; flex-direction:column; height:100%; }
.header { display:flex; align-items:center; justify-content:space-between; padding:10px 15px; background:var(--bg); border-bottom:1px solid #ddd; }
.btn-group { display:flex; align-items:center; gap:8px; }
.small-btn { border:1px solid #ccc; background:#fff; padding:5px 10px; border-radius:6px; cursor:pointer; font-weight:bold; }

.main-area { flex:1; position:relative; overflow-y:auto; }
#inputText, #clozeContent {
    width:100%; height:100%; padding:20px; border:none; outline:none;
    font-size:20px; line-height:1.6; font-family: inherit;
    white-space: pre-wrap; word-break: break-word;
    position: absolute; top:0; left:0;
}
#inputText { resize:none; z-index: 1; }
/* 3. è°ƒæ•´æ•´ä½“è¡Œé—´è·ï¼ˆåœ¨ #clozeContent ä¸­è®¾ç½®ï¼‰ */
#clozeContent {
    z-index: 0; 
    display: none; 
    background: #fff;
    /* --- æ ¸å¿ƒè°ƒæ•´åŒº --- */
    line-height: 2.0;      /* å¢åŠ è¡Œé«˜ï¼Œå»ºè®® 1.8 åˆ° 2.2 ä¹‹é—´ */
}

.exercise-mode #inputText { display: none; }
.exercise-mode #clozeContent { display: block; z-index: 2; }
.exercise-mode .edit-only { display: none; }
.exercise-mode .exercise-only { display: flex !important; }

/* 2. è°ƒæ•´ç‚¹å‡»åç”Ÿæˆçš„è¾“å…¥æ¡†é—´è· */
.cloze-display-input { 
    font-size: inherit; 
    font-family: inherit; 
    color: inherit;
    min-width: 1ch; 
    height: 1.2em;        /* ç¨å¾®åŠ é«˜ä¸€ç‚¹ï¼Œé¿å…å‹çº¿ */
    line-height: normal;
    
    /* --- æ ¸å¿ƒè°ƒæ•´åŒº --- */
    padding: 0 2px;        /* è¾“å…¥æ¡†å†…éƒ¨æ–‡å­—è·ç¦»è¾¹æ¡†çš„è·ç¦» */
    margin: 0 4px;         /* è¾“å…¥æ¡†ä¸å‰åå•è¯çš„è·ç¦» */
    border-bottom: 2px solid #666; /* åŠ ç²—åº•çº¿ï¼Œæ›´æ¸…æ™° */
    /* ---------------- */
    
    background: var(--input-bg); 
    border-radius: 0; 
    outline: none;
    display: inline-block; 
    vertical-align: baseline; 
    text-align: center;
    -webkit-appearance: none;
}


.footer-actions { display:flex; border-top:1px solid #ddd; background:#fff; }
.footer-actions button { flex:1; padding:15px; border:none; font-weight:bold; cursor:pointer; font-size:15px; }
.btn-primary { background:var(--primary); color:white; }
.btn-danger { color:var(--danger); background:#fff8f8; }

/* 1. è°ƒæ•´æ™®é€šå•è¯ï¼ˆå¾…ç‚¹é€‰å•è¯ï¼‰çš„é—´è· */
.word-span {
    cursor: pointer;
    border-radius: 3px;
    /* --- æ ¸å¿ƒè°ƒæ•´åŒº --- */
    padding: 2px 4px;      /* å¢åŠ ä¸Šä¸‹ 2pxï¼Œå·¦å³ 4px çš„ç‚¹å‡»çƒ­åŒº */
    margin: 0 2px;         /* å•è¯ä¹‹é—´çš„å·¦å³è·ç¦» */
    letter-spacing: 0.5px; /* å­—æ¯ä¹‹é—´çš„å¾®å°é—´è· */
    /* ---------------- */
}
.word-span:hover { background:#e8f5e9; }
.exercise-only { display: none; }
</style>
</head>

<body>
<div class="app-container" id="app">
    <header class="header">
        <span style="font-weight:bold; color:var(--primary);">Cloze Master Lite</span>
        <div class="btn-group">
            <button class="small-btn" onclick="changeFontSize(-2)">A-</button>
            <span id="fontSizeLabel">20</span>
            <button class="small-btn" onclick="changeFontSize(2)">A+</button>
        </div>
    </header>

    <main class="main-area">
        <textarea id="inputText" placeholder="åœ¨æ­¤ç²˜è´´æ–‡ç« å†…å®¹..."></textarea>
        <div id="clozeContent"></div>
    </main>

    <nav class="footer-actions">
        <button class="btn-danger edit-only" onclick="handleClear()">æ¸…ç©º</button>
        <button class="edit-only" onclick="handlePaste()" style="background:#f0f0f0;">ğŸ“‹ ç²˜è´´</button>
        <button class="btn-primary edit-only" onclick="toggleMode(true)">å¼€å§‹ç»ƒä¹ </button>
        <button class="btn-primary exercise-only" onclick="toggleMode(false)" style="width: 100%;">â† è¿”å›ä¿®æ”¹</button>
    </nav>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
    authDomain: "cloze-master-pro.firebaseapp.com",
    databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "cloze-master-pro",
    storageBucket: "cloze-master-pro.firebasestorage.app",
    messagingSenderId: "697808901954",
    appId: "1:697808901954:web:32455d94bf67e522e01adb"
  };

  const fbApp = initializeApp(firebaseConfig);
  const db = getDatabase(fbApp);

  function getDocId() {
    const text = inputArea.value.trim();
    if (!text) return null;
    // ä½¿ç”¨æ–‡æœ¬å‰25ä½ç”ŸæˆBase64 ID
    try {
        return btoa(unescape(encodeURIComponent(text.substring(0, 25)))).replace(/[/+=]/g, "");
    } catch(e) { return "default_doc"; }
  }

  window.syncUpload = async function() {
    const id = getDocId();
    if (!id) return;
    set(ref(db, 'clozes/' + id), { positions: manualPositions, ts: Date.now() });
  };

  window.syncDownload = async function() {
    const id = getDocId();
    if (!id) return;
    const snapshot = await get(child(ref(db), 'clozes/' + id));
    if (snapshot.exists()) {
      const data = snapshot.val();
      if (data.positions) {
        manualPositions = data.positions;
        localStorage.setItem('cloze_single_positions', JSON.stringify(manualPositions));
        if (app.classList.contains('exercise-mode')) renderCloze();
      }
    }
  };
</script>

<script>
// å¸¸è§„ä¸šåŠ¡é€»è¾‘
let currentFontSize = 20;
let manualPositions = JSON.parse(localStorage.getItem('cloze_single_positions')) || [];
let answers = [];

const app = document.getElementById('app');
const inputArea = document.getElementById('inputText');
const clozeContent = document.getElementById('clozeContent');

window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const textFromAnki = urlParams.get('text');
    if (textFromAnki) inputArea.value = decodeURIComponent(textFromAnki);
    else {
        const savedText = localStorage.getItem('cloze_single_content');
        if (savedText) inputArea.value = savedText;
    }
    inputArea.style.fontSize = clozeContent.style.fontSize = currentFontSize + "px";
    setTimeout(() => { if(window.syncDownload) window.syncDownload(); }, 1500);
};

async function toggleMode(isExercise) {
    if (isExercise) {
        if (!inputArea.value.trim()) return alert("è¯·å…ˆè¾“å…¥å†…å®¹");
        if (window.syncDownload) await window.syncDownload();
        renderCloze();
        app.classList.add('exercise-mode');
    } else {
        app.classList.remove('exercise-mode');
    }
}

function renderCloze() {
    const segments = inputArea.value.split(/([a-zA-Z]+|[\u4e00-\u9fa5]|[^\s\w\u4e00-\u9fa5]+)/g);
    answers = [];
    let unitCount = 0;

    clozeContent.innerHTML = segments.map(seg => {
        if (!seg || !seg.trim()) return seg;
        const idx = unitCount++;
        const isChinese = /[\u4e00-\u9fa5]/.test(seg);

        if (manualPositions.includes(idx)) {
            answers.push(seg);
            const boxWidth = isChinese ? 2 : (seg.length + 0.1); 
            return `<input class="cloze-display-input" data-id="${answers.length - 1}" data-index="${idx}" 
                    style="width:${boxWidth}ch;" 
                    oninput="validateInput(this)" onkeydown="handleSpaceKey(event, this)"
                    placeholder="${isChinese ? '?' : getHint(seg)}">`;
        }
        return `<span class="word-span" data-index="${idx}">${seg}</span>`;
    }).join("");
    bindEvents();
}

function validateInput(el) {
    const ans = answers[el.dataset.id];
    const val = el.value.trim();
    const isMatch = ans.toLowerCase().startsWith(val.toLowerCase());
    el.style.backgroundColor = (val.toLowerCase() === ans.toLowerCase()) ? "#c8f7c5" : (isMatch ? "var(--input-bg)" : "#f7c5c5");
    el.style.color = isMatch ? "#000" : "var(--danger)";
}

function bindEvents() {
    clozeContent.querySelectorAll('.word-span').forEach(el => {
        el.onclick = () => {
            manualPositions.push(parseInt(el.dataset.index));
            savePositions();
            renderCloze();
        };
    });
    clozeContent.querySelectorAll('input').forEach(el => {
        let timer;
        el.ontouchstart = () => timer = setTimeout(() => recover(el), 800);
        el.ontouchend = () => clearTimeout(timer);
        el.onmousedown = (e) => { if(e.button===0) timer = setTimeout(() => recover(el), 800); };
        el.onmouseup = () => clearTimeout(timer);
    });
}

function recover(el) {
    if(confirm("æ¢å¤æ˜¾ç¤ºï¼Ÿ")) {
        manualPositions = manualPositions.filter(i => i !== parseInt(el.dataset.index));
        savePositions();
        renderCloze();
    }
}

function handleSpaceKey(e, el) {
    if (e.code === 'Space' || e.keyCode === 32) {
        e.preventDefault();
        const targetAns = answers[el.dataset.id];
        if (el.value.length < targetAns.length) {
            el.value = targetAns.substring(0, el.value.length + 1);
            validateInput(el);
        }
    }
}

function changeFontSize(delta) {
    currentFontSize += delta;
    // åŒæ—¶è°ƒæ•´å­—ä½“å¤§å°
    inputArea.style.fontSize = clozeContent.style.fontSize = currentFontSize + "px";
    
    // åŠ¨æ€è°ƒæ•´è¡Œé«˜ï¼ˆå¯é€‰ï¼šè®©è¡Œé«˜éšå­—ä½“å¢å¤§è€Œç•¥å¾®å˜åŒ–ï¼‰
    clozeContent.style.lineHeight = "2.0"; 
    
    document.getElementById('fontSizeLabel').innerText = currentFontSize;
}

function handleClear() { if (confirm("ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ")) { inputArea.value = ""; manualPositions = []; savePositions(); } }
async function handlePaste() { 
    try { const text = await navigator.clipboard.readText(); if (text) { inputArea.value = text; savePositions(); } } 
    catch (e) {} 
}

function getHint(w) { return w.length <= 2 ? w[0] + "_" : w[0] + "_".repeat(w.length - 2) + w[w.length-1]; }
function savePositions() { 
    localStorage.setItem('cloze_single_positions', JSON.stringify(manualPositions)); 
    localStorage.setItem('cloze_single_content', inputArea.value);
    if (window.syncUpload) window.syncUpload();
}
inputArea.oninput = savePositions;
</script>
</body>
</html>
