<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Cloze Master Pro</title>
  <style>
    :root { --primary: #43a047; --bg-light: #f8f9fa; --danger: #ff5252; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    /* æ ¸å¿ƒæ”¹åŠ¨ï¼šä¸å†é”å®š body é«˜åº¦ï¼Œå…è®¸è‡ªç„¶æ»šåŠ¨ */
    html, body { 
      margin: 0; padding: 0; width: 100%; 
      background-color: #fff; color: #333;
      font-family: -apple-system, system-ui, sans-serif;
    }

    .app-container { display: flex; flex-direction: column; min-height: 100vh; }
    .hidden { display: none !important; }

    /* UI ç»„ä»¶ä¿æŒåŸæ · */
    .file-tabs-container {
      background: #fff; padding: 8px 6px; display: flex; align-items: center;
      gap: 6px; border-bottom: 1px solid #eee; overflow-x: auto; white-space: nowrap;
    }
    .file-tab {
      padding: 6px 14px; background: var(--bg-light); border: 1px solid #ddd;
      border-radius: 20px; font-size: 14px; display: inline-flex; align-items: center;
    }
    .file-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
    .add-file-btn { background: var(--primary); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

    .header-controls {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px; background: var(--bg-light); border-bottom: 1px solid #ddd; font-size: 14px;
    }

    /* ç¼–è¾‘åŒºåŸŸ */
    #editArea { flex: 1; display: flex; flex-direction: column; }
    textarea { 
      flex: 1; width: 100%; min-height: 300px; padding: 15px 10px; border: none; outline: none; 
      font-size: 18px; line-height: 1.6; resize: none;
    }

    /* å®Œç¾çš„ç»ƒä¹ åŒºåŸŸé€»è¾‘ï¼šå…¨é¡µé¢æ»šåŠ¨ */
    #clozeDisplay { 
      padding: 15px 10px 80vh 10px; /* åº•éƒ¨é¢„ç•™å·¨å¤§ç©ºé—´ä¾›å±…ä¸­æ»šåŠ¨ */
      white-space: pre-wrap;
      line-height: 1.8;
      word-break: break-word;
      display: none;
    }
    .cloze-display input { 
      outline: none; width: auto; 
      border: none; border-bottom: 1.5px solid #666; 
      background: #fffde7; text-align: center; color: #000; 
      font-size: inherit; margin: 0 1px; border-radius: 0;
      display: inline-block;
    }

    /* æµ®åŠ¨ä¸åŠ¨ä½œæ¡ */
    .paste-fab {
      position: fixed; right: 20px; bottom: 85px;
      background: var(--primary); color: white; border: none;
      padding: 12px 22px; border-radius: 30px; font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100;
    }
    .action-bar { display: flex; width: 100%; border-top: 1px solid #ddd; position: sticky; bottom: 0; background: #fff; }
    .action-bar button { flex: 1; padding: 18px; border: none; font-weight: bold; font-size: 16px; }
    #generate { background: var(--primary); color: white; flex: 1.5; }

    .footer-bar { background: #1a1a1a; color: #999; padding: 15px; font-size: 12px; text-align: center; }
  </style>
</head>
<body>

<div class="app-container">
  <div id="mainView">
    <div class="file-tabs-container" id="fileTabs"></div>
    <div class="header-controls">
      <span style="font-weight:bold; color:var(--primary);">Cloze Master</span>
      <div style="display:flex; gap:5px;">
        <button class="small-btn" onclick="changeFontSize(-2)">A-</button>
        <span id="sizeLabel">18</span>
        <button class="small-btn" onclick="changeFontSize(2)">A+</button>
      </div>
      <div>é—´éš” <input id="nthWord" type="number" value="4" style="width:35px; text-align:center"></div>
    </div>
    <div id="editArea">
      <textarea id="inputText" placeholder="ç²˜è´´æ–‡æœ¬..."></textarea>
      <button class="paste-fab" onclick="handlePaste()">ğŸ“‹ Paste</button>
      <div class="action-bar">
        <button onclick="handleClear()">æ¸…ç©º</button>
        <button id="generate" onclick="handleGenerate()">ç”Ÿæˆç»ƒä¹ </button>
      </div>
    </div>
  </div>

  <div id="clozeDisplay">
    <button onclick="exitExercise()" style="width:100%; padding:10px; background:#f0f0f0; border:1px solid #ccc; border-radius:8px; margin-bottom:20px;">â† è¿”å›ä¿®æ”¹æ–‡å­—</button>
    <div id="clozeContent"></div>
  </div>

  <div class="footer-bar" id="footer">
    Ricky @ 2026
  </div>
</div>

<script>
  let files = JSON.parse(localStorage.getItem('cloze_files_v5')) || [{ id: Date.now(), title: 'File 1', content: '' }];
  let activeFileId = files[0].id;
  let currentFontSize = 18;
  let answers = [];

  const inputArea = document.getElementById("inputText");
  const displayArea = document.getElementById("clozeDisplay");
  const mainView = document.getElementById("mainView");

  function init() { renderTabs(); loadActiveFile(); }

  // å®Œç¾ç§»åŠ¨ç«¯é€»è¾‘ï¼šSize é€‚é… + å•è¯æµ
  function generateCloze(text, n) {
    let index = 0; answers = [];
    const regex = /\([^)]*\)|[\u4e00-\u9fa5]|[a-zA-Z]+(?:[''-][a-zA-Z]+)*/g;
    return text.replace(regex, (match) => {
      if (match.startsWith('(')) return `<span style="color:#999; font-style:italic;">${match}</span>`;
      index++;
      if (index % n === 1) {
        const id = answers.length; answers.push(match);
        const isChinese = /[\u4e00-\u9fa5]/.test(match);
        return `<input data-id="${id}" size="${isChinese ? 2 : match.length}" autocomplete="off" autocapitalize="none" spellcheck="false">`;
      }
      return match;
    });
  }

  function handleGenerate() {
    const val = inputArea.value.trim();
    if (!val) return;
    const n = parseInt(document.getElementById("nthWord").value) || 4;
    document.getElementById("clozeContent").innerHTML = generateCloze(val, n);
    
    // å…³é”®æ”¹å˜ï¼šéšè—ä¸»è§†å›¾ï¼Œè®© body åªæœ‰ç»ƒä¹ åŒº
    mainView.style.display = "none";
    document.getElementById("footer").style.display = "none";
    displayArea.style.display = "block";
    
    // æ»šåŠ¨å›é¡¶éƒ¨
    window.scrollTo(0, 0);

    const allInputs = displayArea.querySelectorAll("input");
    allInputs.forEach(input => {
      input.oninput = () => {
        const ans = answers[input.dataset.id];
        const isCorrect = input.value.trim().toLowerCase() === ans.toLowerCase();
        input.style.backgroundColor = isCorrect ? "#c8f7c5" : (input.value ? "#f7c5c5" : "#fffde7");
      };

      input.onkeydown = (e) => {
        if (e.keyCode === 32) { // ç©ºæ ¼æç¤º
          e.preventDefault();
          const ans = answers[input.dataset.id];
          input.value = ans.substring(0, input.value.length + 1);
          input.oninput();
        }
      };

      // å®Œç¾æ»šåŠ¨æ ¸å¿ƒï¼šåˆ©ç”¨å…¨é¡µé¢çš„ scrollIntoView
      input.onfocus = () => {
        setTimeout(() => {
          // è¿™é‡Œä¸å†å— div å®¹å™¨é™åˆ¶ï¼Œæ˜¯æ•´ä¸ªé¡µé¢çš„å±…ä¸­
          input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 280); 
      };
    });
  }

  function exitExercise() {
    mainView.style.display = "block";
    document.getElementById("footer").style.display = "block";
    displayArea.style.display = "none";
    window.scrollTo(0, 0);
  }

  // --- åŸºç¡€åŠŸèƒ½é€»è¾‘ ---
  async function handlePaste() {
    const text = await navigator.clipboard.readText();
    if (text) { inputArea.value = text; updateFile(text); }
  }
  function renderTabs() {
    const tabs = document.getElementById('fileTabs');
    tabs.innerHTML = '';
    files.forEach(f => {
      const div = document.createElement('div');
      div.className = `file-tab ${f.id === activeFileId ? 'active' : ''}`;
      div.onclick = () => { activeFileId = f.id; renderTabs(); loadActiveFile(); };
      div.innerHTML = `<span>${f.title}</span>`;
      tabs.appendChild(div);
    });
    const btn = document.createElement('button');
    btn.className = "add-file-btn"; btn.innerHTML = '+';
    btn.onclick = () => {
      const id = Date.now();
      files.push({ id, title: 'File ' + (files.length + 1), content: '' });
      activeFileId = id; save(); renderTabs(); loadActiveFile();
    };
    tabs.appendChild(btn);
  }
  function updateFile(t) { const f = files.find(x => x.id === activeFileId); if(f){f.content=t; save();} }
  function save() { localStorage.setItem('cloze_files_v5', JSON.stringify(files)); }
  function loadActiveFile() { const f = files.find(x => x.id === activeFileId); if(f) inputArea.value = f.content; }
  function handleClear() { inputArea.value = ""; updateFile(""); }
  function changeFontSize(d) {
    currentFontSize += d; if (currentFontSize < 12) currentFontSize = 12;
    inputArea.style.fontSize = displayArea.style.fontSize = currentFontSize + "px";
    document.getElementById("sizeLabel").innerText = currentFontSize;
  }
  inputArea.oninput = () => updateFile(inputArea.value);
  init();
</script>
</body>
</html>
