<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cloze Practice</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { margin: 1em; max-width: 60em; font-family: sans-serif; line-height: 1.6; }
    textarea, button { width: 100%; font-size: 1em; margin-top: 0.5em; padding: 0.4em; box-sizing: border-box; }
    
    .cloze { margin-top: 1em; white-space: pre-wrap; }
    .cloze input { font-size: 1em; margin: 0 0.2em; padding: 0 0.2em; border: 1px solid #ccc; border-radius: 4px; }
    
    .correct { background: #c8f7c5; }
    .wrong { background: #f7c5c5; }
    
    .n-input { width: 60px; display: inline-block; margin-left: 10px; }
    /* 让括号内容颜色稍淡，方便区分 */
    .brackets { color: #888; }
  </style>
</head>
<body>

<h1>Cloze Practice</h1>

<p>Step 1: Paste your text (Text in brackets will be ignored)</p>
<textarea id="inputText" rows="8" placeholder="Paste your text here..."></textarea>

<p>Step 2: Set N (every Nth word will be blank) 
  <input id="nthWord" class="n-input" type="number" value="4" min="1">
</p>

<button id="generate">Generate Cloze</button>

<hr>
<div id="clozeDisplay" class="cloze"></div>

<script>
  let answers = [];

  function generateCloze(text, n) {
    let index = 0;
    answers = [];
    
    /**
     * 核心逻辑修改：
     * 使用 | (或) 运算符。
     * 第一部分 \([^)]*\) 匹配括号内容。
     * 第二部分 \b([a-zA-Z]+)\b 匹配单词。
     */
    const regex = /\([^)]*\)|\b([a-zA-Z]+)\b/g;

    return text.replace(regex, function (match, word) {
      // 如果匹配到的是以 '(' 开头的内容，说明是括号提示，直接返回不计入 index
      if (match.startsWith('(')) {
        return `<span class="brackets">${match}</span>`;
      }

      // 如果匹配到的是普通单词
      if (word) {
        index++;
        // 这里的逻辑是：每隔 n 个单词挖一个空
        if (index % n === 1) {
          const id = answers.length;
          answers.push(word);
          return `<input data-id="${id}" autocomplete="off" size="${word.length}">`;
        }
        return word;
      }
      return match;
    });
  }

  function checkInput(input) {
    const id = input.dataset.id;
    const answer = answers[id];
    if (!input.value) { input.className = ""; return; }
    input.className = input.value.trim().toLowerCase() === answer.toLowerCase() ? "correct" : "wrong";
  }

  document.getElementById("generate").onclick = function () {
    const text = document.getElementById("inputText").value;
    let n = parseInt(document.getElementById("nthWord").value) || 4;
    
    document.getElementById("clozeDisplay").innerHTML = generateCloze(text, n);

    document.querySelectorAll("#clozeDisplay input").forEach(input => {
      input.addEventListener("blur", () => checkInput(input));
    });
  };

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  }
</script>

</body>
</html>
