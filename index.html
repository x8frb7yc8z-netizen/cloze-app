<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Cloze Master Pro</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" sizes="512x512" href="icon-512.png">
<meta property="og:title" content="Cloze Master Pro">
<meta property="og:image" content="https://x8frb7yc8z-netizen.github.io/cloze-app/icon-512.png">
<meta property="og:description" content="ä¸€ä¸ªå¥½ç”¨çš„æ–‡æœ¬æŒ–ç©ºç»ƒä¹ å·¥å…·ï¼ŒåŠ©ä½ é«˜æ•ˆèƒŒè¯µå•è¯å’Œè¯¾æ–‡ã€‚">

<style>
:root { --primary: #43a047; --bg-light: #f8f9fa; --danger: #ff5252; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; width:100%; height:100dvh; font-family:-apple-system, system-ui, "Microsoft YaHei", sans-serif; background:#fff; color:#333; overflow:hidden; }
.app-container { display:flex; flex-direction:column; height:100%; width:100%; }
.hidden { display:none !important; }

/* é¡¶éƒ¨æ ‡ç­¾ */
.file-tabs-container {
  background:#fff; padding:8px 6px; display:flex; align-items:center; gap:6px; border-bottom:1px solid #eee; overflow-x:auto; white-space:nowrap; flex-shrink:0;
}
.file-tab { padding:6px 14px; background:var(--bg-light); border:1px solid #ddd; border-radius:20px; font-size:14px; cursor:pointer; display:inline-flex; align-items:center; }
.file-tab.active { background:var(--primary); color:white; border-color:var(--primary); }
.add-file-btn { background:var(--primary); color:white; border:none; width:28px; height:28px; border-radius:50%; font-size:20px; display:flex; align-items:center; justify-content:center; flex-shrink:0; cursor:pointer; }

/* æ§åˆ¶æ  */
.header-controls { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; background:var(--bg-light); border-bottom:1px solid #ddd; font-size:14px; flex-shrink:0; }
.small-btn { border:1px solid #ccc; background:#fff; padding:2px 8px; border-radius:4px; cursor:pointer; }

/* ä¸­é—´æ–‡æœ¬åŒº */
.input-wrapper { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
textarea { flex:1; width:100%; padding:15px 10px; border:none; outline:none; font-size:18px; line-height:1.6; resize:none; background:#fff; }

.paste-fab { position:absolute; right:20px; bottom:25px; background:var(--primary); color:white; border:none; padding:12px 22px; border-radius:30px; font-size:14px; font-weight:bold; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:100; transition:all 0.2s; cursor:pointer;}
.paste-fab:active { transform:scale(0.9); opacity:0.8; }

.cloze-display { 
  position:absolute; top:0; left:0; right:0; bottom:0; padding:15px 10px; white-space:pre-wrap; display:none; line-height:1.8; word-break:break-word; background:#fff; height:100%; overflow-y:auto; -webkit-overflow-scrolling:touch; padding-bottom:60vh !important;
}
.cloze-display.active { display:block; }
.cloze-display input { min-width:3.6ch; padding:0 0.2ch; line-height:1.4; border:none; border-bottom:1.5px solid #666; background:#fffde7; text-align:center; color:#000; font-size:inherit; margin:0 2px; border-radius:0; }

/* åº•éƒ¨æ“ä½œåŒº */
.action-bar { display:flex; width:100%; border-top:1px solid #ddd; flex-shrink:0; background:#fff; }
.action-bar button { flex:1; padding:12px 12px; border:none; font-weight:bold; font-size:14px; cursor:pointer; min-width:80px;}
#clearBtn { background:#fff8f8; color:#d32f2f; }
#generate { background:var(--primary); color:white; flex:1; }

.footer-bar { 
    background: #1a1a1a; 
    color: #bbb;         /* è°ƒäº®æ–‡å­—é¢œè‰²ï¼Œå¢å¼ºå¯è¯»æ€§ */
    padding: 12px 15px;  /* å¢åŠ è¾¹è· */
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    flex-shrink: 0; 
    font-size: 13px;     /* è°ƒæ•´æ•´ä½“å­—ä½“å¤§å° */
}

/* é’ˆå¯¹ç‰¹å®šçš„é“¾æ¥æ–‡å­—ï¼ˆå¦‚ Guide æ‰‹å†Œï¼‰ */
.footer-link {
    font-size: 12px;     /* è®©æ‰‹å†Œå’ŒåŒæ­¥çŠ¶æ€æ›´æ¸…æ™° */
    font-weight: 600;
}

/* å¼¹çª— */
.modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; }
.modal-content { background:white; padding:22px; border-radius:14px; width:85%; max-width:320px; position:relative; }
.close-x { position:absolute; right:12px; top:8px; font-size:24px; color:#bbb; cursor:pointer; }
.mini-coffee-btn { border-radius:6px; transition:background 0.2s; cursor:pointer; }
</style>
</head>

<body>
<div class="app-container">
  <div id="topSection">
    <div class="file-tabs-container" id="fileTabs"></div>
    <div class="header-controls">
      <span style="font-weight:bold; color:var(--primary); font-size:16px;">Cloze Master</span>
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="small-btn" onclick="changeFontSize(-2)">A-</button>
        <span id="sizeLabel" style="min-width:20px; text-align:center;">18</span>
        <button class="small-btn" onclick="changeFontSize(2)">A+</button>
      </div>
      <div>é—´éš” <input id="nthWord" type="number" value="4" style="width:35px; border:1px solid #ddd; text-align:center"> è¯</div>
    </div>
  </div>

  <div class="input-wrapper">
    <textarea id="inputText" placeholder="åœ¨æ­¤ç²˜è´´è‹±æ–‡æˆ–ä¸­æ–‡æ–‡æœ¬..."></textarea>
    <button id="pasteBtn" class="paste-fab" onclick="handlePaste()">ğŸ“‹ Paste ç²˜è´´</button>
    <div id="clozeDisplay" class="cloze-display">
      <button onclick="exitExercise()" style="background:#eee; border:1px solid #ccc; padding:8px 15px; border-radius:6px; margin-bottom:15px;">â† Back / è¿”å›ä¿®æ”¹</button>
      <div id="clozeContent"></div>
    </div>
  </div>

  <div class="action-bar" id="bottomAction">
    <button id="clearBtn" onclick="handleClear()">æ¸…ç©º</button>
    <button id="generate" onclick="handleGenerate()">ç”Ÿæˆç»ƒä¹ </button>
    <button id="customClozeBtn" onclick="enableCustomCloze()">æ‰‹åŠ¨æŒ–ç©º</button>
  </div>

<div class="footer-bar" id="footerSection">
  <div class="footer-left">
    <span class="footer-link" onclick="openGuide()" style="cursor:pointer; font-weight:bold; color:#81c784;">ğŸ“– Guide æ‰‹å†Œ</span>
  </div>
  <div class="footer-right">
    <span id="loginBtnLabel" class="footer-link" onclick="openLoginModal()" style="cursor:pointer; font-weight:bold; color:#42a5f5;">ğŸ‘¤ ç™»å½•/åŒæ­¥</span>
  </div>
</div>

<div id="loginModal" class="modal" onclick="closeLoginModal()">
  <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
    <span class="close-x" onclick="closeLoginModal()">Ã—</span>
    <h4 style="color:#42a5f5; margin-top:0;">ğŸ‘¤ è´¦å·ç™»å½•</h4>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <input type="email" id="authEmail" placeholder="é‚®ç®±" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
      <input type="password" id="authPassword" placeholder="å¯†ç  (ä¸å°‘äº6ä½)" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
      <button onclick="handleEmailAuth('login')" style="padding:12px; background:#42a5f5; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ç™» å½•</button>
      <button onclick="handleEmailAuth('signup')" style="padding:10px; background:#fff; color:#42a5f5; border:1px solid #42a5f5; border-radius:8px; cursor:pointer;">æ–°ç”¨æˆ·æ³¨å†Œ</button>
      <button id="logoutBtn" class="hidden" onclick="handleLogout()" style="padding:10px; color:#ff5252; border:none; background:none; font-size:12px; cursor:pointer;">é€€å‡ºç™»å½•</button>
    </div>
  </div>
</div>

<div id="guideModal" class="modal" onclick="closeGuide()">
  <div class="modal-content" onclick="event.stopPropagation()" style="max-width:320px; width:85%; text-align:left; font-size:13px; line-height:1.6; color:#444;">
    <span class="close-x" onclick="closeGuide()">Ã—</span>
    <h4 style="color:var(--primary); text-align:center; margin-top:0;">ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
    <div style="margin-top:10px;">
      <p>1. <b>æŒ–ç©ºé—´éš”</b>ï¼šåœ¨ Every...th æ¡†ä¸­è®¾ç½®ï¼ˆå¦‚å¡« 4 è¡¨ç¤ºæ¯ 4 ä¸ªè¯æŒ–ä¸€ä¸ªç©ºï¼‰ã€‚</p>
      <p>1. <b>æ‰‹åŠ¨æŒ–ç©º</b>ï¼šç‚¹å‡»å•è¯æŒ–ç©ºï¼ŒåŒå‡»æ’¤é”€ã€‚</p>
      <p>2. <b>å•è¯æç¤º</b>ï¼šæŒ‰é”®ç›˜<b>ç©ºæ ¼é”®</b>å¯æç¤ºä¸‹ä¸€ä¸ªæ­£ç¡®å­—æ¯ã€‚</p>
      <p>3. <b>ä¿å­˜æ–‡æœ¬</b>ï¼šç‚¹å‡»é¡¶éƒ¨çš„ <b>+</b> æ–°å»ºï¼›<b>åŒå‡»</b>æ ‡ç­¾é‡å‘½åã€‚</p>
      <p>4. <b>ä½œä¸ºappä½¿ç”¨</b>ï¼šåœ¨æµè§ˆå™¨èœå•ä¸­é€‰æ‹©â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ã€‚</p>
    </div>
    
    <div style="text-align:center; margin: 20px 0; font-family: sans-serif;">
      <div style="margin-bottom: 12px; font-size: 13px; color: #888;">
        If this tool helped you, please let me know
      </div>

      <hr style="margin:12px 0; border:none; border-top:1px dashed #ddd;">

      <div style="display: flex; justify-content: center; align-items: center; gap: 40px; margin: 10px 0; font-size: 16px;">
        <div style="display: flex; align-items: center; gap: 6px;">
          <span title="Visits">ğŸ“ˆ</span> 
          <b id="visitCount" style="color: #666;">0</b>
        </div>
        <div style="display: flex; align-items: center; gap: 6px; cursor: pointer;" onclick="likeApp()">
          <span>â¤ï¸</span>
          <b id="likeCount" style="color: #666;">0</b>
        </div>
      </div>

      <div style="margin-top: 15px;">
        <a href="mailto:fnhame@gmail.com" style="text-decoration:none; color:#43a047; font-size: 12px; font-weight: bold;">
          ğŸ“© å¦‚æœä½ æœ‰ä»»ä½•æ„è§è”ç³»æˆ‘
        </a>
      </div>
    </div>

    <button onclick="closeGuide()" style="width:100%; padding:12px; margin-top:10px; background:var(--primary); color:white; border:none; border-radius:6px; font-weight:bold;">çŸ¥é“äº†</button>
  </div>
</div>
<script>
const DEFAULT_TEXT = `è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ–‡æœ¬ã€‚

Hello?

- Sara, it's Lara.

- Oh, hi Lara, what's up?

Just wanted to check and make sure you're still coming into work tonight.

Sure, I could really use the money.

Mom, finally cut off my finances.

Oh, okay.

Well, we've got something really important to talk about when you get here.

Sure, well, I'll be there in a little bit.

Yeah, don't rush though, it's so dead in here.

Oh, that's too bad.

Well, I'll see ya.

Okay, bye.`;

window.files = JSON.parse(localStorage.getItem('cloze_files_v5')) || [{
  id: Date.now(),
  title: 'File 1',
  content: DEFAULT_TEXT,
  clozePositions: []
}];

let activeFileId = Number(localStorage.getItem('cloze_last_active_id')) || (files[0] ? files[0].id : null);
let currentFontSize = 18;
let answers = [];

const inputArea = document.getElementById("inputText");
const displayArea = document.getElementById("clozeDisplay");
const clozeContent = document.getElementById("clozeContent");

// ---------------- åˆå§‹åŒ– ----------------
function init() { 
    renderTabs(); 
    loadActiveFile();  
}

// ---------------- ç²˜è´´ ----------------
async function handlePaste() {
  if (!navigator.clipboard) return;
  try {
    const text = await navigator.clipboard.readText();
    if (text) { inputArea.value=text; saveActiveFile(); 
      const btn=document.getElementById("pasteBtn"); 
      btn.style.background="#888"; 
      setTimeout(()=>{btn.style.background="var(--primary)";},800); 
    }
  } catch { console.log("Paste failed"); }
}

// ---------------- æ–‡ä»¶æ ‡ç­¾ ----------------
function renderTabs() {
  const tabs = document.getElementById('fileTabs'); tabs.innerHTML='';
  files.forEach(f=>{
    const div=document.createElement('div'); 
    div.className=`file-tab ${f.id===activeFileId?'active':''}`;
    div.ondblclick=()=>{ 
      const n=prompt("é‡å‘½åæ–‡ä»¶:", f.title); 
      if(n){f.title=n; save(); renderTabs();}
    };
    div.innerHTML=`<span onclick="switchFile(${f.id})">${f.title}</span>
      <span style="color:var(--danger);margin-left:10px;font-weight:bold;font-size:16px;" onclick="deleteFile(${f.id}, event)">Ã—</span>`;
    tabs.appendChild(div);
  });
  const btn=document.createElement('button'); 
  btn.className="add-file-btn"; btn.innerHTML='ï¼‹'; btn.onclick=addNewFile;
  tabs.appendChild(btn);
}

// ---------------- ä¿å­˜ / åŠ è½½ ----------------
function save() {
    // 1. å…ˆä¿å­˜åˆ°æœ¬åœ° (LocalStorage)ï¼Œç¡®ä¿å³ä½¿æ²¡ç½‘ä¹Ÿä¸ä¼šä¸¢
    localStorage.setItem('cloze_files_v5', JSON.stringify(files));
    
    // 2. è§¦å‘äº‘ç«¯åŒæ­¥ (å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ­¤å‡½æ•°ä¼šåœ¨ Firebase æ¨¡å—ä¸­è¢«å®šä¹‰)
    if (window.syncToCloud) {
        window.syncToCloud(files);
    }
}

function saveActiveFile(val) {
    const f = files.find(x => x.id === activeFileId);
    if (f) {
        // å¦‚æœ val æœ‰ä¼ å€¼ï¼ˆæ¯”å¦‚æ¸…ç©ºæ“ä½œï¼‰ï¼Œåˆ™ä½¿ç”¨ valï¼›å¦åˆ™è¯»å–è¾“å…¥æ¡†çš„å†…å®¹
        f.content = (val !== undefined) ? val : inputArea.value;
        save(); // è¿™é‡Œä¼šåŒæ—¶è§¦å‘æœ¬åœ°ä¿å­˜å’Œäº‘ç«¯åŒæ­¥
    }
}
function loadActiveFile(){ 
  const f=files.find(x=>x.id===activeFileId); 
  if(!f) return;
  inputArea.value=f.content || ""; 
  answers = [];
}

// ---------------- æ–‡ä»¶æ“ä½œ ----------------
function addNewFile() { 
    const id = Date.now(); 
    files.push({id, title: 'File ' + (files.length + 1), content: '', clozePositions: []}); 
    activeFileId = id; 
    localStorage.setItem('cloze_last_active_id', id); // è®°å½•æ–°æ–‡ä»¶ID
    save(); 
    renderTabs(); 
    loadActiveFile(); 
    const tabs = document.getElementById('fileTabs'); 
    tabs.scrollLeft = tabs.scrollWidth; 
}
function switchFile(id) { 
    activeFileId = id; 
    localStorage.setItem('cloze_last_active_id', id); // è®°å½•å½“å‰æ‰“å¼€çš„æ–‡ä»¶ID
    renderTabs(); 
    loadActiveFile(); 
}
function deleteFile(id,e){ 
  e.stopPropagation(); 
  if(files.length<=1||!confirm("åˆ é™¤æ­¤æ–‡ä»¶ï¼Ÿ")) return; 
  files=files.filter(x=>x.id!==id); 
  if(activeFileId===id) activeFileId=files[0].id; 
  save(); renderTabs(); loadActiveFile(); 
}

// ---------------- å­—ä½“ ----------------
function changeFontSize(d){ 
  currentFontSize+=d; 
  if(currentFontSize<12) currentFontSize=12; 
  inputArea.style.fontSize=displayArea.style.fontSize=currentFontSize+"px"; 
  document.getElementById("sizeLabel").innerText=currentFontSize; 
}

// ---------------- æ¸…ç©º ----------------
function handleClear(){ 
  if(!confirm("ç¡®å®šæ¸…ç©ºå½“å‰æ–‡æœ¬å—ï¼Ÿ")) return; 
  inputArea.value=""; 
  const f = files.find(x=>x.id===activeFileId); 
  if(f) f.clozePositions = [];
  saveActiveFile(""); 
}

// ---------------- æ¯ N ä¸ªè¯æŒ–ç©º ----------------
function generateCloze(text,n){
  let index=0; answers=[];
  const regex = /\([^)]*\)|[a-zA-Z]+|[\u4e00-\u9fa5]/g;
  return text.replace(regex,(match)=>{
    if (match.startsWith('(')) return `<span style="color:#999;font-style:italic;">${match}</span>`;
    index++;
    if(index%n===1){
      const id = answers.length;
      answers.push(match);
      const isChinese = /[\u4e00-\u9fa5]/.test(match);
      const boxWidth = isChinese ? 2 : match.length + 1;
     // æ‰¾åˆ°è¿™ä¸€è¡Œå¹¶ä¿®æ”¹
  return `<input data-id="${id}" autocomplete="off" style="width:${boxWidth}ch;font-family:inherit;" onfocus="this.select(); this.scrollIntoView({behavior:'smooth',block:'center'});">`;
 
    }
    return match;
  });
}

// ------------------ ä¿®æ”¹åçš„è‡ªåŠ¨ç”Ÿæˆç»ƒä¹ å‡½æ•° (å¢åŠ çº¢å­—é€»è¾‘) ------------------
function handleGenerate(){
  if(!inputArea.value.trim()) return;
  const n=parseInt(document.getElementById("nthWord").value)||4;
  clozeContent.innerHTML=generateCloze(inputArea.value,n);
  ["topSection","bottomAction","footerSection","pasteBtn","inputText"].forEach(id=>document.getElementById(id).classList.add("hidden"));
  displayArea.classList.add("active");
  clozeContent.querySelectorAll("input").forEach(input=>{
    input.oninput=()=>{
      const ans=answers[input.dataset.id];
      const val=input.value.trim();
      
      // èƒŒæ™¯è‰²é€»è¾‘
      input.style.backgroundColor=val.toLowerCase()===ans.toLowerCase()?"#c8f7c5":(val?"#f7c5c5":"#fffde7");
      
      // é”™å­—çº¢å­—é€»è¾‘
      if (val && !ans.toLowerCase().startsWith(val.toLowerCase())) {
        input.style.color = "var(--danger)"; 
      } else {
        input.style.color = "#000";
      }
    };
    input.onkeydown=(e)=>{
      if(e.code==='Space'||e.keyCode===32){ e.preventDefault(); const ans=answers[input.dataset.id]; input.value=ans.substring(0,input.value.length+1); input.oninput(); }
    };
  });
}

// ---------------- é€€å‡º ----------------
function exitExercise(){ 
  ["topSection","bottomAction","footerSection","pasteBtn","inputText"].forEach(id=>document.getElementById(id).classList.remove("hidden")); 
  displayArea.classList.remove("active"); 
}

// ---------------- ç‚¹å‡»æŒ–ç©º + ä¿å­˜ ----------------
function enableCustomCloze() {
  const text = inputArea.value;
  if (!text) return;

  // æ­£åˆ™è¯´æ˜ï¼šåŒ¹é…è‹±æ–‡å•è¯ã€å•ä¸ªä¸­æ–‡å­—ç¬¦ã€æˆ–è€…éç©ºç™½æ ‡ç‚¹
  const regex = /([a-zA-Z]+|[\u4e00-\u9fa5]|[^\s\w\u4e00-\u9fa5]+)/g;
  const segments = text.split(regex);
  
  const f = files.find(x => x.id === activeFileId);
  if (!f.clozePositions) f.clozePositions = [];

  answers = [];
  let unitCount = 0; 

  clozeContent.innerHTML = segments.map((seg) => {
    if (!seg || !seg.trim()) return seg; 
    if (seg.startsWith('(')) return `<span style="color:#999;font-style:italic;">${seg}</span>`;

    const currentIdx = unitCount++;
    const isChinese = /[\u4e00-\u9fa5]/.test(seg);
    const boxWidth = isChinese ? 2 : seg.length + 1;

    if (f.clozePositions.includes(currentIdx)) {
      answers.push(seg);
      return `<input data-id="${answers.length - 1}" data-index="${currentIdx}" autocomplete="off" style="width:${boxWidth}ch;font-family:inherit;" onfocus="this.select(); this.scrollIntoView({behavior:'smooth',block:'center'});">`;
    }

    return `<span class="word-span" data-index="${currentIdx}">${seg}</span>`;
  }).join("");

  displayArea.classList.add("active");
  ["topSection", "bottomAction", "footerSection", "pasteBtn", "inputText"].forEach(id => document.getElementById(id).classList.add("hidden"));

  bindCustomEvents(f);
}

// ------------------ ä¿®æ”¹åçš„äº‹ä»¶ç»‘å®šå‡½æ•° (å¤„ç†é•¿æŒ‰æ’¤é”€) ------------------
function bindCustomEvents(f) {
  clozeContent.querySelectorAll(".word-span, input").forEach((el) => {
    // é’ˆå¯¹ span çš„ç‚¹å‡»å˜è¾“å…¥æ¡†é€»è¾‘
    if (el.tagName === "SPAN" && el.classList.contains('word-span')) {
      el.style.cursor = "pointer";
      el.onclick = () => {
        const wordIndex = parseInt(el.dataset.index);
        f.clozePositions.push(wordIndex);
        save();
        enableCustomCloze(); 
      };
    }

    // é’ˆå¯¹ input çš„é€»è¾‘ï¼šå¢åŠ é”™å­—çº¢å­—æ˜¾ç¤ºï¼Œä»¥åŠé•¿æŒ‰æ’¤é”€
    if (el.tagName === "INPUT") {
      // 1. è¾“å…¥æ ¡éªŒï¼šé”™å­—çº¢å­—é€»è¾‘
      el.oninput = () => {
        const ans = answers[el.dataset.id];
        const val = el.value.trim();
        
        // åŸºç¡€é¢œè‰²åˆ¤å®šï¼ˆèƒŒæ™¯è‰²ï¼‰
        el.style.backgroundColor = val.toLowerCase() === ans.toLowerCase() ? "#c8f7c5" : (val ? "#f7c5c5" : "#fffde7");
        
        // é”™è¯¯å­—æ¯å˜çº¢é€»è¾‘ï¼šåªè¦å½“å‰è¾“å…¥çš„å†…å®¹ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆçš„å‰ç¼€ï¼Œæ–‡å­—å°±å˜çº¢
        if (val && !ans.toLowerCase().startsWith(val.toLowerCase())) {
          el.style.color = "var(--danger)"; // è®¾ç½®ä¸ºçº¢è‰²
        } else {
          el.style.color = "#000"; // æ­£ç¡®æˆ–è¾“å…¥ä¸­ä¿æŒé»‘è‰²
        }
      };

      el.onkeydown = (e) => {
        if (e.code === 'Space' || e.keyCode === 32) {
          e.preventDefault();
          const ans = answers[el.dataset.id];
          el.value = ans.substring(0, el.value.length + 1);
          el.oninput();
        }
      };

      // 2. é•¿æŒ‰æ’¤é”€é€»è¾‘ (å…¼å®¹æ‰‹æœºç«¯)
      let longPressTimer;
      el.ontouchstart = () => {
        longPressTimer = setTimeout(() => {
          if(confirm("ç¡®å®šæ’¤é”€è¿™ä¸ªæŒ–ç©ºå—ï¼Ÿ")) {
            const wordIndex = parseInt(el.dataset.index);
            f.clozePositions = f.clozePositions.filter(i => i !== wordIndex);
            save();
            enableCustomCloze();
          }
        }, 800); // é•¿æŒ‰ 800 æ¯«ç§’è§¦å‘
      };
      el.ontouchend = () => clearTimeout(longPressTimer);
      el.onmousedown = () => { // å…¼å®¹ PC ç«¯é•¿æŒ‰
        longPressTimer = setTimeout(() => {
          const wordIndex = parseInt(el.dataset.index);
          f.clozePositions = f.clozePositions.filter(i => i !== wordIndex);
          save();
          enableCustomCloze();
        }, 800);
      };
      el.onmouseup = () => clearTimeout(longPressTimer);
    }
  });
}

// ---------------- è¾“å…¥åŒºå˜åŒ–ä¹Ÿè¦æ›´æ–°ä¿å­˜ ----------------
inputArea.oninput=()=>saveActiveFile();



// ---------------- å¼¹çª—æ§åˆ¶ ----------------
function openGuide() {
  document.getElementById("guideModal").style.display = "flex";
}

function closeGuide() {
  document.getElementById("guideModal").style.display = "none";
}
// ---------------- åˆå§‹åŒ– ----------------
init();
</script>

<script type="module">
  // 1. å¯¼å…¥éƒ¨åˆ†ï¼šæ³¨æ„å¢åŠ äº† onValue
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getDatabase, ref, get, set, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
    authDomain: "cloze-master-pro.firebaseapp.com",
    projectId: "cloze-master-pro",
    databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
    storageBucket: "cloze-master-pro.firebasestorage.app",
    messagingSenderId: "697808901954",
    appId: "1:697808901954:web:32455d94bf67e522e01adb"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  let currentUser = null;
  

  // --- ç™»å½•/æ³¨å†Œé€»è¾‘ ---
  window.handleEmailAuth = async (type) => {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    if (!email || !password) return alert("è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ");
    try {
      if (type === 'signup') {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("æ³¨å†ŒæˆåŠŸï¼æ•°æ®å°†åŒæ­¥è‡³æ­¤è´¦å·ã€‚");
      } else {
        await signInWithEmailAndPassword(auth, email, password);
        alert("ç™»å½•æˆåŠŸï¼");
      }
      window.closeLoginModal();
    } catch (e) { alert("æ“ä½œå¤±è´¥: " + e.message); }
  };

  window.handleLogout = () => { if(confirm("ç¡®å®šé€€å‡ºç™»å½•å—ï¼Ÿ")) signOut(auth); };

// ------------------ ç™»å½•çŠ¶æ€ç›‘å¬ ------------------
onAuthStateChanged(auth, (user) => {
    const btnLabel = document.getElementById('loginBtnLabel');
    const logoutBtn = document.getElementById('logoutBtn');

    if (user) {
        currentUser = user;
        btnLabel.innerText = "âœ… å·²åŒæ­¥";
        btnLabel.style.color = "#81c784";
        logoutBtn.classList.remove('hidden');

        // ç™»å½•åç«‹å³æ‹‰å–äº‘ç«¯æ•°æ®å¹¶åˆ·æ–° UI
        get(ref(db, `users/${user.uid}/files`))
            .then(snapshot => {
                if (snapshot.exists()) applyData(snapshot.val());
            });

        // å¼€å¯å®æ—¶ç›‘å¬äº‘ç«¯å˜åŒ–
        startRealtimeSync(user.uid);

    } else {
        currentUser = null;
        btnLabel.innerText = "ğŸ‘¤ ç™»å½•/åŒæ­¥";
        btnLabel.style.color = "#42a5f5";
        logoutBtn.classList.add('hidden');
    }
});

// ------------------ å®æ—¶åŒæ­¥å‡½æ•°ï¼ˆå®Œæ•´å¯ç”¨ç‰ˆï¼‰ ------------------
function startRealtimeSync(uid) {
    if (!uid) return;

    const path = `users/${uid}/files`;
    const fileRef = ref(db, path);

    console.log("ğŸ“¡ å¼€å§‹ç›‘å¬äº‘ç«¯è·¯å¾„:", path);

    // ç»‘å®šå®æ—¶ç›‘å¬
    onValue(fileRef, (snapshot) => {
        if (!snapshot.exists()) {
            console.log("âš ï¸ äº‘ç«¯æš‚æ— æ•°æ®");
            return;
        }

        const cloudData = snapshot.val();
        console.log("ğŸ”¥ äº‘ç«¯æ•°æ®å˜æ›´ï¼Œè‡ªåŠ¨åŒæ­¥åˆ°æœ¬åœ°", cloudData);

        applyData(cloudData);
    });
}

// ------------------ åº”ç”¨äº‘ç«¯æ•°æ®åˆ°æœ¬åœ° ------------------
function applyData(data) {
    if (!Array.isArray(data)) {
        console.warn("âŒ äº‘ç«¯æ•°æ®ä¸æ˜¯æ•°ç»„ï¼Œå·²å¿½ç•¥", data);
        return;
    }

    // 1. è¦†ç›–å†…å­˜æ•°æ®
    window.files = data;

    // 2. å†™å…¥ LocalStorageï¼ˆåˆ·æ–°åä¹Ÿä¸€è‡´ï¼‰
    localStorage.setItem('cloze_files_v5', JSON.stringify(data));

    // 3. å¦‚æœå½“å‰æ–‡ä»¶å·²è¢«äº‘ç«¯åˆ é™¤ï¼Œè‡ªåŠ¨åˆ‡æ¢
    if (!files.find(f => f.id === activeFileId)) {
        activeFileId = files[0]?.id;
    }

    // 4. ç»Ÿä¸€åˆ·æ–° UI
    renderTabs();
    loadActiveFile();
}

// ------------------ è‡ªåŠ¨ä¸Šä¼  ------------------
window.syncToCloud = async function (data) {
    if (!currentUser) return;
    try {
        await set(ref(db, `users/${currentUser.uid}/files`), data);
    } catch (e) {
        console.error("åŒæ­¥å¤±è´¥", e);
    }
};

  // --- ç»Ÿè®¡é€»è¾‘ ---
  window.loadStats = async () => {
    const snap = await get(ref(db, "stats"));
    if (snap.exists()) {
      const { visits = 0, likes = 0 } = snap.val();
      document.getElementById("visitCount").innerText = visits;
      document.getElementById("likeCount").innerText = likes;
    }
  };

  window.likeApp = async () => {
    const uid = currentUser ? currentUser.uid : localStorage.getItem("cloze_uid");
    const userLikeRef = ref(db, `likedUsers/${uid}`);
    const snap = await get(userLikeRef);
    if (snap.exists()) return alert("ä½ å·²ç»ç‚¹è¿‡èµå•¦ â¤ï¸");
    await set(userLikeRef, true);
    await runTransaction(ref(db, "stats/likes"), v => (v || 0) + 1);
    window.loadStats();
  };

  window.openLoginModal = () => document.getElementById("loginModal").style.display = "flex";
  window.closeLoginModal = () => document.getElementById("loginModal").style.display = "none";

  runTransaction(ref(db, "stats/visits"), v => (v || 0) + 1);
  window.loadStats();
</script>
</body>
</html>
