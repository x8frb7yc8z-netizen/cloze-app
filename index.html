<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Cloze Master Pro (ä¸­è‹±åŒè¯­ç‰ˆ)</title>
  <style>
    :root { --primary: #43a047; --bg-light: #f8f9fa; --danger: #ff5252; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    html, body { 
      margin: 0; padding: 0; width: 100%; 
      height: 100dvh; 
      font-family: -apple-system, system-ui, "Microsoft YaHei", sans-serif; 
      background-color: #fff; color: #333; overflow: hidden;
    }

    .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
    .hidden { display: none !important; }

    /* é¡¶éƒ¨æ ‡ç­¾ */
    .file-tabs-container {
      background: #fff; padding: 8px 6px; display: flex; align-items: center;
      gap: 6px; border-bottom: 1px solid #eee; overflow-x: auto; white-space: nowrap;
      flex-shrink: 0;
    }
    .file-tab {
      padding: 6px 14px; background: var(--bg-light); border: 1px solid #ddd;
      border-radius: 20px; font-size: 14px; cursor: pointer; display: inline-flex; align-items: center;
    }
    .file-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
    .add-file-btn {
      background: var(--primary); color: white; border: none; width: 28px; height: 28px;
      border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; cursor: pointer;
    }

    /* æ§åˆ¶æ  */
    .header-controls {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px; background: var(--bg-light); border-bottom: 1px solid #ddd; font-size: 14px;
      flex-shrink: 0;
    }
    .small-btn { border: 1px solid #ccc; background: #fff; padding: 2px 8px; border-radius: 4px; }

    /* ä¸­é—´æ–‡æœ¬åŒº */
    .input-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    textarea { 
      flex: 1; width: 100%; padding: 15px 10px; border: none; outline: none; 
      font-size: 18px; line-height: 1.6; resize: none; background: #fff;
    }

    .paste-fab {
      position: absolute; right: 20px; bottom: 25px;
      background: var(--primary); color: white; border: none;
      padding: 12px 22px; border-radius: 30px; font-size: 14px; font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100;
      transition: all 0.2s;
    }
    .paste-fab:active { transform: scale(0.9); opacity: 0.8; }

    .cloze-display { 
      position: absolute; top:0; left:0; right:0; bottom:0;
      padding: 15px 10px 120px 10px; white-space: pre-wrap; display: none; 
      line-height: 1.8; word-break: break-word; overflow-y: auto; background: #fff;
    }
    .cloze-display.active { display: block; }

    /* åº•éƒ¨æ“ä½œåŒº */
    .action-bar { display: flex; width: 100%; border-top: 1px solid #ddd; flex-shrink: 0; background: #fff; }
    .action-bar button { flex: 1; padding: 18px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; }
    #clearBtn { background: #fff8f8; color: #d32f2f; }
    #generate { background: var(--primary); color: white; flex: 1.5; }

    .footer-bar { 
      background: #1a1a1a; color: #999; padding: 10px 12px; font-size: 12px;
      display: flex; justify-content: space-between; align-items: center;
      flex-shrink: 0;
      padding-bottom: calc(env(safe-area-inset-bottom) + 8px);
    }

    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 22px; border-radius: 14px; width: 85%; max-width: 320px; position: relative; }
    .close-x { position: absolute; right: 12px; top: 8px; font-size: 24px; color: #bbb; cursor: pointer; }
    
    .cloze-display input { 
      border: none; border-bottom: 1.5px solid #666; 
      background: #fffde7; text-align: center; color: #000; 
      font-size: inherit; margin: 0 2px; border-radius: 0;
    }
  </style>
</head>
<body>

<div class="app-container">
  <div id="topSection">
    <div class="file-tabs-container" id="fileTabs"></div>
    <div class="header-controls">
      <span style="font-weight:bold; color:var(--primary); font-size: 16px;">Cloze Master</span>
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="small-btn" onclick="changeFontSize(-2)">A-</button>
        <span id="sizeLabel" style="min-width: 20px; text-align: center;">18</span>
        <button class="small-btn" onclick="changeFontSize(2)">A+</button>
      </div>
      <div>é—´éš” <input id="nthWord" type="number" value="4" style="width:35px; border:1px solid #ddd; text-align:center"> å­—/è¯</div>
    </div>
  </div>

  <div class="input-wrapper">
    <textarea id="inputText" placeholder="åœ¨æ­¤ç²˜è´´è‹±æ–‡æ–‡ç« æˆ–ä¸­æ–‡æ®µè½..."></textarea>
    <button id="pasteBtn" class="paste-fab" onclick="handlePaste()">ğŸ“‹ Paste ç²˜è´´</button>
    <div id="clozeDisplay" class="cloze-display">
      <button onclick="exitExercise()" style="background:#eee; border:1px solid #ccc; padding:8px 15px; border-radius:6px; margin-bottom:15px;">â† Back / è¿”å›ä¿®æ”¹</button>
      <div id="clozeContent"></div>
    </div>
  </div>

  <div class="action-bar" id="bottomAction">
    <button id="clearBtn" onclick="handleClear()">æ¸…ç©º</button>
    <button id="generate" onclick="handleGenerate()">ç”Ÿæˆç»ƒä¹ </button>
  </div>

  <div class="footer-bar" id="footerSection">
    <div style="display:flex; gap:18px;">
      <span style="color:#81c784; cursor:pointer; font-weight:bold;" onclick="openGuide()">ğŸ“– Guide æ‰‹å†Œ</span>
      <a href="mailto:fnhame@gmail.com" style="color:#666; text-decoration:none;">Feedback</a>
    </div>
    <div style="color:#555;">Ricky @ 2026</div>
  </div>
</div>

<div id="guideModal" class="modal" onclick="closeGuide()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close-x" onclick="closeGuide()">Ã—</span>
    <h4 style="color:var(--primary); text-align:center; margin-top:0;">ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
    <div style="font-size: 13px; line-height: 1.6; color: #444;">
      <p>1. <b>ä¸­è‹±æ”¯æŒ</b>ï¼šè‡ªåŠ¨è¯†åˆ«ä¸­æ–‡å­—ç¬¦å’Œè‹±æ–‡å•è¯ã€‚ä¸­æ–‡æŒ‰å­—æŒ–ç©ºï¼Œè‹±æ–‡æŒ‰è¯æŒ–ç©ºã€‚</p>
      <p>2. <b>æŒ–ç©ºé—´éš”</b>ï¼šè®¾ç½® Every Nthã€‚å¦‚å¡« 3ï¼Œåˆ™æ¯ 3 ä¸ªå…ƒç´ æŒ–ä¸€ä¸ªç©ºã€‚</p>
      <p>3. <b>å¿«æ·æç¤º</b>ï¼šåœ¨è¾“å…¥æ¡†å†…æŒ‰<b>ç©ºæ ¼é”®</b>å¯è‡ªåŠ¨å¡«å…¥ä¸‹ä¸€ä¸ªæ­£ç¡®å­—ç¬¦ã€‚</p>
      <p>4. <b>å¤šæ–‡ä»¶</b>ï¼šé¡¶éƒ¨å¯æ–°å»ºå¤šä¸ªæ–‡æ¡£ï¼ŒåŒå‡»æ ‡ç­¾é‡å‘½åã€‚</p>
    </div>
    <button onclick="closeGuide()" style="width:100%; padding:12px; margin-top:10px; background:var(--primary); color:white; border:none; border-radius:6px; font-weight:bold;">çŸ¥é“äº†</button>
  </div>
</div>

<script>
  let files = JSON.parse(localStorage.getItem('cloze_files_v5')) || [{ id: Date.now(), title: 'File 1', content: '' }];
  let activeFileId = files[0].id;
  let currentFontSize = 18;
  let answers = [];

  const inputArea = document.getElementById("inputText");
  const displayArea = document.getElementById("clozeDisplay");
  const clozeContent = document.getElementById("clozeContent");

  function init() { renderTabs(); loadActiveFile(); }

  async function handlePaste() {
    if (!navigator.clipboard) return;
    try {
      const text = await navigator.clipboard.readText();
      if (text) {
        inputArea.value = text;
        const f = files.find(x => x.id === activeFileId);
        if (f) { f.content = text; save(); }
        const btn = document.getElementById("pasteBtn");
        btn.style.background = "#888";
        setTimeout(() => { btn.style.background = "var(--primary)"; }, 800);
      }
    } catch (err) { console.log("Paste failed"); }
  }

  function renderTabs() {
    const tabs = document.getElementById('fileTabs');
    tabs.innerHTML = '';
    files.forEach(f => {
      const div = document.createElement('div');
      div.className = `file-tab ${f.id === activeFileId ? 'active' : ''}`;
      div.ondblclick = () => { 
        const n = prompt("é‡å‘½åæ–‡ä»¶:", f.title); 
        if(n){ f.title = n; save(); renderTabs(); }
      };
      div.innerHTML = `
        <span onclick="switchFile(${f.id})">${f.title}</span>
        <span style="color:var(--danger);margin-left:10px;font-weight:bold;font-size:16px;" onclick="deleteFile(${f.id}, event)">Ã—</span>
      `;
      tabs.appendChild(div);
    });
    const btn = document.createElement('button');
    btn.className = "add-file-btn"; btn.innerHTML = 'ï¼‹';
    btn.onclick = addNewFile;
    tabs.appendChild(btn);
  }

  function generateCloze(text, n) {
    let index = 0; 
    answers = [];
    // åŒ¹é…æ‹¬å·å†…å®¹ã€ä¸­æ–‡å­—ç¬¦ã€æˆ–è‹±æ–‡å•è¯
    const regex = /\([^)]*\)|[\u4e00-\u9fa5]|[a-zA-Z]+/g;
    
    return text.replace(regex, (match) => {
      if (match.startsWith('(')) {
        return `<span style="color:#999; font-style:italic;">${match}</span>`;
      }
      
      index++;
      if (index % n === 1) {
        const id = answers.length; 
        answers.push(match);
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºä¸­æ–‡ï¼ŒåŠ¨æ€è®¡ç®—è¾“å…¥æ¡†å®½åº¦
        const isChinese = /[\u4e00-\u9fa5]/.test(match);
        const boxWidth = isChinese ? 2.2 : match.length + 1.2;
        
        return `<input data-id="${id}" 
                       autocomplete="off" 
                       style="width: ${boxWidth}ch; font-family: inherit;" 
                       onfocus="this.select()">`;
      }
      return match;
    });
  }

  function handleGenerate() {
    if (!inputArea.value.trim()) return;
    const n = parseInt(document.getElementById("nthWord").value) || 4;
    clozeContent.innerHTML = generateCloze(inputArea.value, n);
    
    // éšè—ç¼–è¾‘ç•Œé¢
    ["topSection", "bottomAction", "footerSection", "pasteBtn", "inputText"].forEach(id => {
      document.getElementById(id).classList.add("hidden");
    });
    displayArea.classList.add("active");
    
    // ç»‘å®šæ£€æŸ¥é€»è¾‘
    displayArea.querySelectorAll("input").forEach(input => {
      input.oninput = () => {
        const ans = answers[input.dataset.id];
        const isCorrect = input.value.trim().toLowerCase() === ans.toLowerCase();
        input.style.backgroundColor = isCorrect ? "#c8f7c5" : (input.value ? "#f7c5c5" : "#fffde7");
      };
      // ç©ºæ ¼é”®æç¤ºé€»è¾‘
      input.onkeydown = (e) => {
        if (e.code === 'Space' || e.keyCode === 32) {
          e.preventDefault();
          const ans = answers[input.dataset.id];
          // å¡«å…¥ä¸‹ä¸€ä¸ªå­—ç¬¦
          input.value = ans.substring(0, input.value.length + 1);
          input.oninput();
        }
      };
    });
  }

  function exitExercise() {
    ["topSection", "bottomAction", "footerSection", "pasteBtn", "inputText"].forEach(id => {
      document.getElementById(id).classList.remove("hidden");
    });
    displayArea.classList.remove("active");
  }

  function handleClear() {
    if(!confirm("ç¡®å®šæ¸…ç©ºå½“å‰æ–‡æœ¬å—ï¼Ÿ")) return;
    inputArea.value = "";
    const f = files.find(x => x.id === activeFileId);
    if(f) { f.content = ""; save(); }
  }

  function addNewFile() {
    const id = Date.now();
    files.push({ id, title: 'File ' + (files.length + 1), content: '' });
    activeFileId = id; save(); renderTabs(); loadActiveFile();
  }

  function switchFile(id) { activeFileId = id; renderTabs(); loadActiveFile(); }

  function deleteFile(id, e) {
    e.stopPropagation();
    if (files.length <= 1 || !confirm("åˆ é™¤æ­¤æ–‡ä»¶ï¼Ÿ")) return;
    files = files.filter(x => x.id !== id);
    if (activeFileId === id) activeFileId = files[0].id;
    save(); renderTabs(); loadActiveFile();
  }

  function save() { localStorage.setItem('cloze_files_v5', JSON.stringify(files)); }
  
  function loadActiveFile() {
    const f = files.find(x => x.id === activeFileId);
    if (f) inputArea.value = f.content;
  }

  inputArea.oninput = () => {
    const f = files.find(x => x.id === activeFileId);
    if (f) { f.content = inputArea.value; save(); }
  };

  function changeFontSize(d) {
    currentFontSize += d; if (currentFontSize < 12) currentFontSize = 12;
    inputArea.style.fontSize = displayArea.style.fontSize = currentFontSize + "px";
    document.getElementById("sizeLabel").innerText = currentFontSize;
  }

  function openGuide() { document.getElementById('guideModal').style.display = 'flex'; }
  function closeGuide() { document.getElementById('guideModal').style.display = 'none'; }

  init();
</script>
</body>
</html>
