<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cloze Practice</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { margin: 1em; max-width: 60em; font-family: sans-serif; line-height: 1.6; }
    textarea, button { width: 100%; font-size: 1em; margin-top: 0.5em; padding: 0.4em; box-sizing: border-box; }
    
    .cloze { margin-top: 1em; white-space: pre-wrap; }
    .cloze input { font-size: 1em; margin: 0 0.2em; padding: 0 0.2em; border: 1px solid #ccc; border-radius: 4px; }
    
    .correct { background: #c8f7c5; }
    .wrong { background: #f7c5c5; }
    
    .n-input { width: 60px; display: inline-block; margin-left: 10px; }
    .brackets { color: #888; }
    .button-row { display: flex; gap: 1em; margin-top: 0.5em; }
  </style>
</head>
<body>

<h1>Cloze Practice</h1>

<p>Step 1: Paste your text (Text in brackets will be ignored)</p>
<textarea id="inputText" rows="8" placeholder="Paste your text here..."></textarea>

<p>Step 2: Set N (every Nth word will be blank) 
  <input id="nthWord" class="n-input" type="number" value="4" min="1">
</p>

<div class="button-row">
  <button id="generate">Generate Cloze</button>
  <button id="clearText">Clear Text</button>
</div>

<hr>
<div id="clozeDisplay" class="cloze"></div>

<script>
  let answers = [];

  function generateCloze(text, n) {
    let index = 0;
    answers = [];
    const regex = /\([^)]*\)|\b([a-zA-Z]+)\b/g;

    return text.replace(regex, function(match, word) {
      if (match.startsWith('(')) {
        return `<span class="brackets">${match}</span>`;
      }

      if (word) {
        index++;
        if (index % n === 1) {
          const id = answers.length;
          answers.push(word);
          return `<input data-id="${id}" autocomplete="off" size="${word.length}" data-clicks="0" data-focused="false">`;
        }
        return word;
      }
      return match;
    });
  }

  function checkInput(input) {
    const id = input.dataset.id;
    const answer = answers[id];
    if (!input.value) { input.className = ""; return; }
    input.className = input.value.trim().toLowerCase() === answer.toLowerCase() ? "correct" : "wrong";
  }

  function setupInputEvents() {
    const inputs = document.querySelectorAll("#clozeDisplay input");

    inputs.forEach(input => {
      input.dataset.clicks = 0;
      input.dataset.focused = "false"; // 第一次聚焦标记

      // 失焦检查
      input.addEventListener("blur", () => checkInput(input));

      // 点击提示
      input.addEventListener("click", () => {
        if (document.activeElement !== input) return;
        // 第一次聚焦不触发提示
        if (input.dataset.focused === "false") {
          input.dataset.focused = "true";
          return;
        }

        let clicks = parseInt(input.dataset.clicks) || 0;
        const id = input.dataset.id;
        const answer = answers[id];

        if (clicks < answer.length) {
          input.value = answer.slice(0, clicks + 1);
          input.dataset.clicks = clicks + 1;
          checkInput(input);
        }
      });

      // 按回车自动跳到下一个
      input.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          checkInput(input);
          const next = Array.from(inputs).find(inp => inp.value === "");
          if (next) next.focus();
        }
      });

      // 聚焦时重置点击次数
      input.addEventListener("focus", () => {
        input.dataset.clicks = 0;
        if (input.dataset.focused !== "true") {
          input.dataset.focused = "true"; // 标记已经聚焦过
        }
      });
    });
  }

  document.getElementById("generate").onclick = function() {
    const text = document.getElementById("inputText").value;
    const n = parseInt(document.getElementById("nthWord").value) || 4;

    document.getElementById("clozeDisplay").innerHTML = generateCloze(text, n);
    setupInputEvents();
  };

  // 清空文本功能
  document.getElementById("clearText").onclick = function() {
    document.getElementById("inputText").value = "";
    document.getElementById("clozeDisplay").innerHTML = "";
  };

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  }
</script>

</body>
</html>
