<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Cloze Master Pro</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" sizes="512x512" href="icon-512.png">
<meta property="og:title" content="Cloze Master Pro">
<meta property="og:image" content="https://x8frb7yc8z-netizen.github.io/cloze-app/icon-512.png">
<meta property="og:description" content="ä¸€ä¸ªå¥½ç”¨çš„æ–‡æœ¬æŒ–ç©ºç»ƒä¹ å·¥å…·ï¼ŒåŠ©ä½ é«˜æ•ˆèƒŒè¯µå•è¯å’Œè¯¾æ–‡ã€‚">

<style>
.manual-word {
  cursor: pointer;
  padding: 0 2px;
  border-radius: 3px;
}

.manual-word:hover {
  background: #e8f5e9;
}

:root { --primary: #43a047; --bg-light: #f8f9fa; --danger: #ff5252; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; width:100%; height:100dvh; font-family:-apple-system, system-ui, "Microsoft YaHei", sans-serif; background:#fff; color:#333; overflow:hidden; }
.app-container { display:flex; flex-direction:column; height:100%; width:100%; }
.hidden { display:none !important; }

/* é¡¶éƒ¨æ ‡ç­¾ */
.file-tabs-container {
  background:#fff; padding:8px 6px; display:flex; align-items:center; gap:6px; border-bottom:1px solid #eee; overflow-x:auto; white-space:nowrap; flex-shrink:0;
}
.file-tab { padding:6px 14px; background:var(--bg-light); border:1px solid #ddd; border-radius:20px; font-size:14px; cursor:pointer; display:inline-flex; align-items:center; }
.file-tab.active { background:var(--primary); color:white; border-color:var(--primary); }
.add-file-btn { background:var(--primary); color:white; border:none; width:28px; height:28px; border-radius:50%; font-size:20px; display:flex; align-items:center; justify-content:center; flex-shrink:0; cursor:pointer; }

/* æ§åˆ¶æ  */
.header-controls { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; background:var(--bg-light); border-bottom:1px solid #ddd; font-size:14px; flex-shrink:0; }
.small-btn { border:1px solid #ccc; background:#fff; padding:2px 8px; border-radius:4px; cursor:pointer; }

/* ä¸­é—´æ–‡æœ¬åŒº */
.input-wrapper { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
textarea { flex:1; width:100%; padding:15px 10px; border:none; outline:none; font-size:18px; line-height:1.6; resize:none; background:#fff; }

.paste-fab { position:absolute; right:20px; bottom:25px; background:var(--primary); color:white; border:none; padding:12px 22px; border-radius:30px; font-size:14px; font-weight:bold; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:100; transition:all 0.2s; cursor:pointer;}
.paste-fab:active { transform:scale(0.9); opacity:0.8; }

.cloze-display { 
  position:absolute; top:0; left:0; right:0; bottom:0; padding:15px 10px; white-space:pre-wrap; display:none; line-height:1.8; word-break:break-word; background:#fff; height:100%; overflow-y:auto; -webkit-overflow-scrolling:touch; padding-bottom:60vh !important;
}
.cloze-display.active { display:block; }
.cloze-display input { outline:none; min-width:3.6ch; padding:0 0.2ch; line-height:1.4; border:none; border-bottom:1.5px solid #666; background:#fffde7; text-align:center; color:#000; font-size:inherit; margin:0 2px; border-radius:0; }

/* åº•éƒ¨æ“ä½œåŒº */
.action-bar { display:flex; width:100%; border-top:1px solid #ddd; flex-shrink:0; background:#fff; }
.action-bar button { flex:1; padding:18px; border:none; font-weight:bold; font-size:16px; cursor:pointer; }
#clearBtn { background:#fff8f8; color:#d32f2f; }
#generate { background:var(--primary); color:white; flex:1.5; }

.footer-bar { background:#1a1a1a; color:#999; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; flex-shrink:0; padding-bottom:calc(env(safe-area-inset-bottom)+8px); }

/* å¼¹çª— */
.modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; }
.modal-content { background:white; padding:22px; border-radius:14px; width:85%; max-width:320px; position:relative; }
.close-x { position:absolute; right:12px; top:8px; font-size:24px; color:#bbb; cursor:pointer; }
.mini-coffee-btn { border-radius:6px; transition:background 0.2s; cursor:pointer; }
</style>
</head>

<body>
<div class="app-container">
  <div id="topSection">
    <div class="file-tabs-container" id="fileTabs"></div>
    <div class="header-controls">
      <span style="font-weight:bold; color:var(--primary); font-size:16px;">Cloze Master</span>
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="small-btn" onclick="changeFontSize(-2)">A-</button>
        <span id="sizeLabel" style="min-width:20px; text-align:center;">18</span>
        <button class="small-btn" onclick="changeFontSize(2)">A+</button>
      </div>
      <div>é—´éš” <input id="nthWord" type="number" value="4" style="width:35px; border:1px solid #ddd; text-align:center"> è¯</div>
    </div>
  </div>

  <div class="input-wrapper">
    <textarea id="inputText" placeholder="åœ¨æ­¤ç²˜è´´è‹±æ–‡æˆ–ä¸­æ–‡æ–‡æœ¬..."></textarea>
    <button id="pasteBtn" class="paste-fab" onclick="handlePaste()">ğŸ“‹ Paste ç²˜è´´</button>
    <div id="clozeDisplay" class="cloze-display">
      <button onclick="exitExercise()" style="background:#eee; border:1px solid #ccc; padding:8px 15px; border-radius:6px; margin-bottom:15px;">â† Back / è¿”å›ä¿®æ”¹</button>
      <div id="clozeContent"></div>
    </div>
  </div>

  <div class="action-bar" id="bottomAction">
    <button id="clearBtn" onclick="handleClear()">æ¸…ç©º</button>
    <button id="generate" onclick="handleGenerate()">ç”Ÿæˆç»ƒä¹ </button>
    <button id="customClozeBtn" onclick="enableCustomCloze()">è‡ªå®šä¹‰æŒ–ç©º</button>
  </div>

  <div class="footer-bar" id="footerSection">
    <div class="footer-left" style="display:flex; gap:18px; align-items:center;">
      <span class="footer-link" onclick="openGuide()" style="cursor:pointer; font-weight:bold; color:#81c784;">ğŸ“– Guide æ‰‹å†Œ</span>
      <a href="mailto:fnhame@gmail.com" class="footer-link" style="text-decoration:none; color:#666;">Feedback</a>
    </div>
    <div class="footer-right" style="color:#999; font-size:12px;">Ricky @ 2026</div>
  </div>
</div>

<div id="guideModal" class="modal" onclick="closeGuide()">
  <div class="modal-content" onclick="event.stopPropagation()" style="max-width:320px; width:85%; text-align:left; font-size:13px; line-height:1.6; color:#444;">
    <span class="close-x" onclick="closeGuide()">Ã—</span>
    <h4 style="color:var(--primary); text-align:center; margin-top:0;">ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
    <div style="margin-top:10px;">
      <p>1. <b>æŒ–ç©ºé—´éš”</b>ï¼šåœ¨ Every...th æ¡†ä¸­è®¾ç½®ï¼ˆå¦‚å¡« 4 è¡¨ç¤ºæ¯ 4 ä¸ªè¯æŒ–ä¸€ä¸ªç©ºï¼‰ã€‚</p>
      <p>2. <b>å•è¯æç¤º</b>ï¼šæŒ‰é”®ç›˜<b>ç©ºæ ¼é”®</b>å¯æç¤ºä¸‹ä¸€ä¸ªæ­£ç¡®å­—æ¯ã€‚</p>
      <p>3. <b>ä¿å­˜æ–‡æœ¬</b>ï¼šç‚¹å‡»é¡¶éƒ¨çš„ <b>+</b> æ–°å»ºï¼›<b>åŒå‡»</b>æ ‡ç­¾é‡å‘½å,æ¸…ç©ºæµè§ˆå™¨ç¼“å­˜å³åˆ é™¤æ‰€æœ‰æ–‡ä»¶ã€‚</p>
      <p>4. <b>ä½œä¸ºappä½¿ç”¨</b>ï¼šåœ¨æµè§ˆå™¨èœå•ä¸­é€‰æ‹©â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ã€‚</p>
    </div>
      <div style="text-align:center; margin-top:20px; border-top:1px dashed #eee; padding-top:15px;">
      <p style="font-size:11px; color:#999; margin-bottom:10px;">å¦‚æœè¿™ä¸ªå·¥å…·å¸®åˆ°äº†ä½ ï¼Œè¯·ç‚¹ä¸ªèµï¼š</p>
      <button id="likeBtn" onclick="handleLike()" style="background:#fff; color:#ff4757; border:1px solid #ff4757; padding:8px 25px; border-radius:20px; cursor:pointer; font-weight:bold; transition:all 0.3s; outline:none;">
        â¤ <span id="likeCount">...</span>
      </button>
      <p id="likeMsg" style="font-size:10px; color:#ff4757; margin-top:5px; visibility:hidden;">æ„Ÿè°¢ç‚¹èµï¼</p>
    </div>
    <button onclick="closeGuide()" style="width:100%; padding:12px; margin-top:15px; background:var(--primary); color:white; border:none; border-radius:6px; font-weight:bold;">çŸ¥é“äº†</button>
  </div>
</div>

<script>
let files = JSON.parse(localStorage.getItem('cloze_files_v5')) || [{ id: Date.now(), title: 'File 1', content: '' }];
let activeFileId = files[0].id;
let currentFontSize = 18;
let answers = [];
let clozeMode = "auto"; // auto | manual
const inputArea = document.getElementById("inputText");
const displayArea = document.getElementById("clozeDisplay");
const clozeContent = document.getElementById("clozeContent");

// function init() { renderTabs(); loadActiveFile(); }

async function handlePaste() {
  if (!navigator.clipboard) return;
  try {
    const text = await navigator.clipboard.readText();
    if (text) { inputArea.value=text; saveActiveFile(); const btn=document.getElementById("pasteBtn"); btn.style.background="#888"; setTimeout(()=>{btn.style.background="var(--primary)";},800); }
  } catch { console.log("Paste failed"); }
}

function renderTabs() {
  const tabs = document.getElementById('fileTabs'); tabs.innerHTML='';
  files.forEach(f=>{
    const div=document.createElement('div'); div.className=`file-tab ${f.id===activeFileId?'active':''}`;
    div.ondblclick=()=>{ const n=prompt("é‡å‘½åæ–‡ä»¶:", f.title); if(n){f.title=n; save(); renderTabs();} };
    div.innerHTML=`<span onclick="switchFile(${f.id})">${f.title}</span>
      <span style="color:var(--danger);margin-left:10px;font-weight:bold;font-size:16px;" onclick="deleteFile(${f.id}, event)">Ã—</span>`;
    tabs.appendChild(div);
  });
  const btn=document.createElement('button'); btn.className="add-file-btn"; btn.innerHTML='ï¼‹'; btn.onclick=addNewFile;
  tabs.appendChild(btn);
}

function generateCloze(text,n){
  let index=0; answers=[];
  const regex=/\([^)]*\]|[\u4e00-\u9fa5]|[a-zA-Z]+/g;
  return text.replace(regex,(match)=>{
    if(match.startsWith('(')) return `<span style="color:#999;font-style:italic;">${match}</span>`;
    index++;
    if(index%n===1){
      const id=answers.length; answers.push(match);
      const isChinese=/[\u4e00-\u9fa5]/.test(match);
      const boxWidth=isChinese?2.2:match.length+1.2;
      return `<input data-id="${id}" autocomplete="off" style="width:${boxWidth}ch;font-family:inherit;" onfocus="this.scrollIntoView({behavior:'smooth',block:'center'}); this.select()">`;
    }
    return match;
  });
}

function handleGenerate(){
  if(!inputArea.value.trim()) return;
  const n=parseInt(document.getElementById("nthWord").value)||4;
  clozeContent.innerHTML=generateCloze(inputArea.value,n);
  ["topSection","bottomAction","footerSection","pasteBtn","inputText"].forEach(id=>document.getElementById(id).classList.add("hidden"));
  displayArea.classList.add("active");
  displayArea.querySelectorAll("input").forEach(input=>{
    input.oninput=()=>{
      const ans=answers[input.dataset.id];
      const isCorrect=input.value.trim().toLowerCase()===ans.toLowerCase();
      input.style.backgroundColor=isCorrect?"#c8f7c5":(input.value?"#f7c5c5":"#fffde7");
    };
    input.onkeydown=(e)=>{
      if(e.code==='Space'||e.keyCode===32){ e.preventDefault(); const ans=answers[input.dataset.id]; input.value=ans.substring(0,input.value.length+1); input.oninput(); }
    };
  });
}

function enableCustomCloze() {
  if (!inputArea.value.trim()) return;

  clozeMode = "manual";
  answers = [];

  clozeContent.innerHTML = wrapSelectableWords(inputArea.value);

  ["topSection","bottomAction","footerSection","pasteBtn","inputText"]
    .forEach(id => document.getElementById(id).classList.add("hidden"));

  displayArea.classList.add("active");

  bindManualClozeEvents();
}
function wrapSelectableWords(text) {
  return text.replace(
    /([a-zA-Z]+|[\u4e00-\u9fa5])/g,
    `<span class="manual-word">$1</span>`
  );
}

function bindManualClozeEvents() {
  document.querySelectorAll('.manual-word').forEach(span => {
    span.onclick = () => {
      const word = span.innerText;
      const id = answers.length;
      answers.push(word);

      const isChinese = /[\u4e00-\u9fa5]/.test(word);
      const width = isChinese ? 2.2 : word.length + 1.2;

      span.outerHTML = `
        <input class="manual-input"
               data-id="${id}"
               data-answer="${word}"
               style="width:${width}ch"
               autocomplete="off"
               ondblclick="restoreWord(this)"
               oninput="checkAnswer(this)"
               onkeydown="hintLetter(event, this)">
      `;
    };
  });
}

function restoreWord(input) {
  const word = input.dataset.answer;
  input.outerHTML = `<span class="manual-word">${word}</span>`;
  bindManualClozeEvents();
}
function checkAnswer(input) {
  const ans = input.dataset.answer;
  const ok = input.value.trim().toLowerCase() === ans.toLowerCase();
  input.style.backgroundColor = ok
    ? "#c8f7c5"
    : (input.value ? "#f7c5c5" : "#fffde7");
}

function hintLetter(e, input) {
  if (e.code === 'Space') {
    e.preventDefault();
    const ans = input.dataset.answer;
    input.value = ans.substring(0, input.value.length + 1);
    checkAnswer(input);
  }
}

function exitExercise(){ ["topSection","bottomAction","footerSection","pasteBtn","inputText"].forEach(id=>document.getElementById(id).classList.remove("hidden")); displayArea.classList.remove("active"); }

function handleClear(){ if(!confirm("ç¡®å®šæ¸…ç©ºå½“å‰æ–‡æœ¬å—ï¼Ÿ")) return; inputArea.value=""; saveActiveFile(""); }
function addNewFile(){ const id=Date.now(); files.push({id,title:'File '+(files.length+1),content:''}); activeFileId=id; save(); renderTabs(); loadActiveFile(); }
function switchFile(id){ activeFileId=id; renderTabs(); loadActiveFile(); }
function deleteFile(id,e){ e.stopPropagation(); if(files.length<=1||!confirm("åˆ é™¤æ­¤æ–‡ä»¶ï¼Ÿ")) return; files=files.filter(x=>x.id!==id); if(activeFileId===id) activeFileId=files[0].id; save(); renderTabs(); loadActiveFile(); }

function save(){ localStorage.setItem('cloze_files_v5',JSON.stringify(files)); }
function saveActiveFile(val){ const f=files.find(x=>x.id===activeFileId); if(f){ f.content=(val!==undefined)?val:inputArea.value; save(); } }
function loadActiveFile(){ const f=files.find(x=>x.id===activeFileId); if(f) inputArea.value=f.content; }
inputArea.oninput=()=>saveActiveFile();

function changeFontSize(d){ currentFontSize+=d; if(currentFontSize<12) currentFontSize=12; inputArea.style.fontSize=displayArea.style.fontSize=currentFontSize+"px"; document.getElementById("sizeLabel").innerText=currentFontSize; }

function openModal(){ document.getElementById('coffeeModal').style.display='flex'; }
function closeModal(){ document.getElementById('coffeeModal').style.display='none'; }
function openGuide(){ document.getElementById('guideModal').style.display='flex'; }
function closeGuide(){ document.getElementById('guideModal').style.display='none'; }
  
// --- 1. å®šä¹‰å”¯ä¸€çš„é¡¹ç›®æ ‡è¯† ---
const NAMESPACE = "cloze_master_pro_unique_2026"; 
const KEY = "total_likes";

// --- 2. è·å–å¹¶æ˜¾ç¤ºäº‘ç«¯ç‚¹èµæ•° ---
async function initLikeCount() {
    try {
        // ä½¿ç”¨ jsonip.com ç±»ä¼¼çš„å…¬ç›Šæ¥å£æˆ– countapi
        const res = await fetch(`https://api.countapi.xyz/get/${NAMESPACE}/${KEY}`);
        const data = await res.json();
        if(data.value) document.getElementById('likeCount').innerText = data.value;
    } catch (e) {
        document.getElementById('likeCount').innerText = "0";
    }
}

// --- 3. å¤„ç†ç‚¹å‡»ç‚¹èµé€»è¾‘ ---
async function handleLike() {
    const btn = document.getElementById('likeBtn');
    const msg = document.getElementById('likeMsg');
    const countSpan = document.getElementById('likeCount');

    // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ï¼Œé˜²æ­¢åŒä¸€ä¸ªäººåå¤åˆ·èµ
    if (localStorage.getItem('voted_like_2026')) {
        msg.innerText = "å·²ç»æ”¶åˆ°ä½ çš„å¿ƒæ„å•¦~";
        msg.style.visibility = "visible";
        return;
    }

    try {
        // è°ƒç”¨ hit æ¥å£ï¼Œæ•°å€¼åœ¨äº‘ç«¯è‡ªåŠ¨ +1
        const res = await fetch(`https://api.countapi.xyz/hit/${NAMESPACE}/${KEY}`);
        const data = await res.json();
        
        // æ›´æ–°æ˜¾ç¤º
        countSpan.innerText = data.value;
        
        // è§†è§‰åé¦ˆ
        btn.style.background = "#ff4757";
        btn.style.color = "#fff";
        msg.style.visibility = "visible";
        
        // æœ¬åœ°è®°å½•å·²ç‚¹èµ
        localStorage.setItem('voted_like_2026', 'true');
    } catch (e) {
        // ç½‘ç»œå¤±è´¥æ—¶çš„å…œåº•æ˜¾ç¤º
        let current = parseInt(countSpan.innerText) || 0;
        countSpan.innerText = current + 1;
        msg.style.visibility = "visible";
    }
}

// --- 4. ä¿®æ”¹ä½ çš„ init å‡½æ•°ï¼Œè®©å®ƒå¯åŠ¨ ---
// æ‰¾åˆ°ä½ åŸæœ‰çš„ init()ï¼Œåœ¨é‡Œé¢åŠ ä¸Š initLikeCount();
function init() { 
    renderTabs(); 
    loadActiveFile(); 
    initLikeCount(); // <-- ç¡®ä¿è¿™è¡Œåœ¨è¿™é‡Œ
}
      
init();
</script>
</body>
</html>
