<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Cloze Master Pro</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" sizes="512x512" href="icon-512.png">
<meta property="og:title" content="Cloze Master Pro">
<meta property="og:image" content="https://x8frb7yc8z-netizen.github.io/cloze-app/icon-512.png">
<meta property="og:description" content="ä¸€ä¸ªå¥½ç”¨çš„æ–‡æœ¬æŒ–ç©ºç»ƒä¹ å·¥å…·ï¼ŒåŠ©ä½ é«˜æ•ˆèƒŒè¯µå•è¯å’Œè¯¾æ–‡ã€‚">

<style>
#hiddenInput {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 1px;
    height: 1px;
    opacity: 0;
    z-index: 9999;
}
/* è·Ÿæ‰“æ¨¡å¼ä¸“å±æ ·å¼ */
.typing-container {
    font-family: 'Consolas', 'Monaco', monospace; /* ç­‰å®½å­—ä½“å¯¹é½æ›´å‡† */
    color: #ccc; /* é»˜è®¤ç°è‰² */
    font-size: 24px;
    line-height: 1.6;
    user-select: none;
}
.char-unit { position: relative; }
.char-correct { color: #43a047; } /* æ­£ç¡®å˜ç»¿ */
.char-wrong { color: #ff5252; background: #ffebee; } /* é”™è¯¯çº¢å­—èƒŒæ™¯ */
.char-current { 
    color: #333; 
    border-bottom: 3px solid var(--primary); 
    background: #e8f5e9; 
} /* å½“å‰å…‰æ ‡ */
/* è®© placeholder çš„ä¸‹åˆ’çº¿å¯¹é½æ›´æ•´é½ */
input::placeholder {
    color: #bbb;
    font-family: monospace; /* ä½¿ç”¨ç­‰å®½å­—ä½“ */
    letter-spacing: 1px;    /* å¢åŠ ä¸‹åˆ’çº¿é—´è· */
}
/* 1. è®© Chrome, Safari, Edge çš„å°ç®­å¤´ä¸€ç›´æ˜¾ç¤º (ä¸å†éœ€è¦é¼ æ ‡æ‚¬åœ) */
input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button { 
    opacity: 1 !important; /* å¼ºåˆ¶æ˜¾ç¤º */
    appearance: auto !important;
    -webkit-appearance: auto !important;
}

/* 2. é’ˆå¯¹ Firefox çš„ä¿®å¤ */
input[type=number] {
    -moz-appearance: textfield; /* å¦‚æœä½ æƒ³å½»åº•å»æ‰æ¢æˆè‡ªå·±çš„ï¼Œç”¨è¿™ä¸ª */
}


@keyframes side-bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(4px); }
  60% { transform: translateY(2px); }
}
:root { --primary: #43a047; --bg-light: #f8f9fa; --danger: #ff5252; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; width:100%; height:100dvh; font-family:-apple-system, system-ui, "Microsoft YaHei", sans-serif; background:#fff; color:#333; overflow:hidden; }
.app-container { display:flex; flex-direction:column; height:100%; width:100%; }
.hidden { display:none !important; }

/* é¡¶éƒ¨æ ‡ç­¾ */
.file-tabs-container {
  background:#fff; padding:8px 6px; display:flex; align-items:center; gap:6px; border-bottom:1px solid #eee; overflow-x:auto; white-space:nowrap; flex-shrink:0;
}
.file-tab { padding:6px 14px; background:var(--bg-light); border:1px solid #ddd; border-radius:20px; font-size:14px; cursor:pointer; display:inline-flex; align-items:center; }
.file-tab.active { background:var(--primary); color:white; border-color:var(--primary); }
.add-file-btn { background:var(--primary); color:white; border:none; width:28px; height:28px; border-radius:50%; font-size:20px; display:flex; align-items:center; justify-content:center; flex-shrink:0; cursor:pointer; }

/* æ§åˆ¶æ  */
.header-controls { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; background:var(--bg-light); border-bottom:1px solid #ddd; font-size:14px; flex-shrink:0; }
.small-btn { border:1px solid #ccc; background:#fff; padding:2px 8px; border-radius:4px; cursor:pointer; }

/* ä¸­é—´æ–‡æœ¬åŒº */
.input-wrapper { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
textarea { flex:1; width:100%; padding:15px 10px; border:none; outline:none; font-size:18px; line-height:1.6; resize:none; background:#fff; }

.paste-fab { position:absolute; right:20px; bottom:25px; background:var(--primary); color:white; border:none; padding:12px 22px; border-radius:30px; font-size:14px; font-weight:bold; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:100; transition:all 0.2s; cursor:pointer;}
.paste-fab:active { transform:scale(0.9); opacity:0.8; }

.cloze-display { 
  position:absolute; top:0; left:0; right:0; bottom:0; padding:15px 10px; white-space:pre-wrap; display:none; line-height:1.8; word-break:break-word; background:#fff; height:100%; overflow-y:auto; -webkit-overflow-scrolling:touch; padding-bottom:60vh !important;
}
.cloze-display.active { display:block; }
.cloze-display input { min-width:3.6ch; padding:0 0.2ch; line-height:1.4; border:none; border-bottom:1.5px solid #666; background:#fffde7; text-align:center; color:#000; font-size:inherit; margin:0 2px; border-radius:0; }

/* åº•éƒ¨æ“ä½œåŒº */
.action-bar { display:flex; width:100%; border-top:1px solid #ddd; flex-shrink:0; background:#fff; }
.action-bar button { flex:1; padding:12px 12px; border:none; font-weight:bold; font-size:14px; cursor:pointer; min-width:80px;}
#clearBtn { background:#fff8f8; color:#d32f2f; }
#generate { background:var(--primary); color:white; flex:1; }

/* æ‰¾åˆ°ä½ ä»£ç ä¸­çš„ .footer-bar å¹¶æ›¿æ¢å¦‚ä¸‹å†…å®¹ */
.footer-bar { 
    background: #1a1a1a; 
    color: #bbb; 
    /* æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨åº•éƒ¨åŸæœ‰ 12px çš„åŸºç¡€ä¸Šå¢åŠ å®‰å…¨åŒºåŸŸè·ç¦» */
    padding: 12px 15px calc(12px + env(safe-area-inset-bottom)); 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    flex-shrink: 0; 
    font-size: 13px; 
}

/* é’ˆå¯¹ç‰¹å®šçš„é“¾æ¥æ–‡å­—ï¼ˆå¦‚ Guide æ‰‹å†Œï¼‰ */
.footer-link {
    font-size: 12px;     /* è®©æ‰‹å†Œå’ŒåŒæ­¥çŠ¶æ€æ›´æ¸…æ™° */
    font-weight: 600;
}

/* å¼¹çª— */
.modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; }
.modal-content { background:white; padding:22px; border-radius:14px; width:85%; max-width:320px; position:relative; }
.close-x { position:absolute; right:12px; top:8px; font-size:24px; color:#bbb; cursor:pointer; }
.mini-coffee-btn { border-radius:6px; transition:background 0.2s; cursor:pointer; }
</style>
</head>

<body>
<div class="app-container">
  <div id="topSection">
    <div class="file-tabs-container" id="fileTabs"></div>
    <div class="header-controls">
      <span style="font-weight:bold; color:var(--primary); font-size:16px;" data-i18n="appTitle">å®Œå½¢å¡«ç©º</span>
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="small-btn" onclick="changeFontSize(-2)">A-</button>
        <span id="sizeLabel" style="min-width:20px; text-align:center;">18</span>
        <button class="small-btn" onclick="changeFontSize(2)">A+</button>
      </div>
      <div style="display: flex; align-items: center; justify-content: center;">
  <span data-i18n="interval">é—´éš”</span>
  <input id="nthWord" type="number" value="4" 
         style="width:35px; border:1px solid #ddd; text-align:center; margin: 0 2px;">
  <span data-i18n="words" style="margin-left: -2px;">è¯</span>
</div>
    </div>
  </div>

<div class="input-wrapper">
Â  Â  <textarea id="inputText" data-i18n="placeholder"></textarea>
Â  Â  <button id="pasteBtn" class="paste-fab" onclick="handlePaste()" data-i18n="paste">ğŸ“‹ ç²˜è´´</button>
Â  Â  <div id="clozeDisplay" class="cloze-display">
Â  Â  Â Â 
Â  Â  Â  <button onclick="exitExercise()" data-i18n="back" style="background:#eee; border:1px solid #ccc; padding:8px 15px; border-radius:6px; margin-bottom:15px;">â† è¿”å›</button>
Â  Â  Â  
Â  Â  Â  <input type="text" id="hiddenInput">
Â  Â  Â  <div id="clozeContent"></div>
Â  Â  <div id="scoreResult" style="margin-top:20px; text-align:center; font-weight:bold; font-size:1.2em; color:var(--primary);"></div>
	 Â <button id="submitBtn"Â 
Â  Â  Â  Â  data-i18n="submit"Â 
Â  Â  Â  Â  onclick="calculateScore()"Â 
Â  Â  Â  Â  style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:8px; font-weight:bold; margin-top:20px;">
Â  Â  æäº¤å¹¶è¯„åˆ†
</button>
Â  Â  </div>
Â  </div>


  <div class="action-bar" id="bottomAction">
    <button id="clearBtn" onclick="handleClear()" data-i18n="clear">æ¸…ç©º</button>
    <button id="generate" onclick="handleGenerate()" data-i18n="generate">ç”Ÿæˆç»ƒä¹ </button>
    <button id="customClozeBtn" onclick="enableCustomCloze()" data-i18n="custom">æ‰‹åŠ¨æŒ–ç©º</button>
    <button id="typeModeBtn" onclick="startTypingMode()" style="background:#42a5f5; color:white;">è·Ÿæ‰“æ¨¡å¼</button>
  </div>

<div class="footer-bar" id="footerSection">
  <div class="footer-left" style="display:flex; gap:10px;">
    <span class="footer-link" onclick="openGuide()" style="cursor:pointer; font-weight:bold; color:#81c784;" data-i18n="guide">ğŸ“– æ‰‹å†Œ</span>
    <span class="footer-link" onclick="toggleLanguage()" style="cursor:pointer; color:#ffb74d;">ğŸŒ EN/ä¸­æ–‡</span>
  </div>
  <div class="footer-right">
    <span id="loginBtnLabel" class="footer-link" onclick="openLoginModal()" style="cursor:pointer; font-weight:bold; color:#42a5f5;" data-i18n="login">ğŸ‘¤ ç™»å½•/åŒæ­¥</span>
  </div>
</div>

<div id="loginModal" class="modal" onclick="closeLoginModal()">
  <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
    <span class="close-x" onclick="closeLoginModal()">Ã—</span>

    <div id="loggedOutUI">
      <h4 style="color:#42a5f5; margin-top:0;" data-i18n="loginTitle">ğŸ‘¤ è´¦å·ç™»å½•</h4>
      <div style="display:flex; flex-direction:column; gap:12px;">
        <button onclick="handleGoogleAuth()" style="padding:12px; background:#fff; color:#444; border:1px solid #ddd; border-radius:8px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> <span data-i18n="googleLogin">ä½¿ç”¨ Google ç™»å½•</span>
        </button>
        <div style="margin: 5px 0; color: #ccc; font-size: 12px;" data-i18n="or">â€”â€”â€”â€” æˆ–è€… â€”â€”â€”â€”</div>
        <input type="email" id="authEmail" data-i18n="emailPlace" style="padding:12px; border:1px solid #ddd; border-radius:8px;">
        <input type="password" id="authPassword" data-i18n="passPlace" style="padding:12px; border:1px solid #ddd; border-radius:8px;">
        <button onclick="handleEmailAuth('login')" style="padding:12px; background:#42a5f5; color:white; border:none; border-radius:8px; font-weight:bold;" data-i18n="loginBtn">ç™» å½•</button>
        <button onclick="handleEmailAuth('signup')" style="padding:10px; background:#fff; color:#42a5f5; border:1px solid #42a5f5; border-radius:8px;" data-i18n="signupBtn">æ–°ç”¨æˆ·æ³¨å†Œ</button>
      </div>
    </div>

    <div id="loggedInUI" class="hidden">
      <h4 style="color:#43a047; margin-top:0;" data-i18n="syncTitle">â˜ï¸ äº‘åŒæ­¥å·²å¼€å¯</h4>
      <div style="text-align:left; font-size:13px; color:#555; line-height:1.6; background:#f0f7f0; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #e0eee0;">
        <p>ğŸš€ <b data-i18n="s1t">è‡ªåŠ¨ä¸Šä¼ </b>ï¼š<span data-i18n="s1d">æ‚¨åœ¨æœ¬åœ°åšçš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šå®æ—¶åŒæ­¥è‡³äº‘ç«¯ã€‚</span></p>
        <p>ğŸ“¥ <b data-i18n="s2t">è‡ªåŠ¨ä¸‹è½½</b>ï¼š<span data-i18n="s2d">ç™»å½•æ–°è®¾å¤‡æ—¶ï¼Œæ‚¨çš„è¯¾æœ¬å’ŒæŒ–ç©ºè®°å½•ä¼šè‡ªåŠ¨æ¢å¤ã€‚</span></p>
      </div>
      <p id="userEmailDisplay" style="font-size:12px; color:#999; margin-bottom:15px;"></p>
      <button onclick="handleLogout()" style="width:100%; padding:10px; color:#ff5252; border:1px solid #ff5252; background:none; border-radius:8px; font-weight:bold; cursor:pointer;" data-i18n="logoutBtn">é€€å‡ºå½“å‰è´¦å·</button>
    </div>
    </div>
  </div>
</div>

<div id="guideModal" class="modal" onclick="closeGuide()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close-x" onclick="closeGuide()">Ã—</span>
    <h4 style="color:var(--primary); text-align:center; margin-top:0;" data-i18n="guideTitle">ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
    <div style="font-size:13px; line-height:1.6;">
      <p>1. <b data-i18n="g1t">æŒ–ç©ºé—´éš”</b>ï¼š<span data-i18n="g1d">åœ¨ Every...th æ¡†ä¸­è®¾ç½®ã€‚</span></p>
      <p>2. <b data-i18n="g2t">æ‰‹åŠ¨æŒ–ç©º</b>ï¼š<span data-i18n="g2d">ç‚¹å‡»å•è¯æŒ–ç©ºï¼Œé•¿æŒ‰æ’¤é”€ã€‚</span></p>
      <p>3. <b data-i18n="g3t">å•è¯æç¤º</b>ï¼š<span data-i18n="g3d">æŒ‰ç©ºæ ¼é”®æç¤ºä¸‹ä¸€ä¸ªæ­£ç¡®å­—æ¯ã€‚</span></p>
      <p>4. <b data-i18n="g4t">å¤ä¹ å•è¯</b>ï¼š<span data-i18n="g4d">è´¦å·ç™»å½•ä¿å­˜å½“å‰è¯¾æœ¬ï¼ŒæŒç»­è·Ÿè¿›ä¸ªäººå­¦ä¹ è¿›åº¦ã€‚</span></p>
      <p>5. <b data-i18n="g5t">å®‰è£…ä¸ºApp</b>ï¼š<span data-i18n="g5d">åœ¨æµè§ˆå™¨èœå•ä¸­é€‰æ‹©â€œæ·»åŠ åˆ°ä¸»å±å¹•â€</span></p>
    </div>
<!--  
<div style="text-align:center; margin: 20px 0;">
   <div style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; color: #888; margin-bottom: 10px;">
     <span data-i18n="feedback">If this tool helped you</span>
     <span style="font-size: 20px; color: var(--primary); animation: side-bounce 2s infinite;">â¬‡ï¸</span>
   </div>
      <hr style="margin:12px 0; border:none; border-top:1px dashed #ddd;">
      
   <div style="display: flex; justify-content: center; align-items: center; gap: 70px; margin: 10px 0; font-size: 16px;">
   <div style="display: flex; align-items: center; gap: 6px;"><span title="Visits">ğŸ“ˆ</span> <b id="visitCount" style="color: #666;">0</b></div>
   <div style="display: flex; align-items: center; gap: 6px; cursor: pointer;" onclick="likeApp()"><span>â¤ï¸</span> <b id="likeCount" style="color: #666;">0</b></div>
   </div>
</div>
-->

<div style="margin-top: 15px; text-align: center;">
  <a href="mailto:fnhame@gmail.com" style="text-decoration:none; color:#43a047; font-size: 12px; font-weight: bold;" data-i18n="contactLink">
    å¦‚åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·è”ç³»æˆ‘ ğŸ“©
  </a>
</div>
    

    <button onclick="closeGuide()" style="width:100%; padding:12px; margin-top:10px; background:var(--primary); color:white; border:none; border-radius:6px; font-weight:bold;" data-i18n="gotIt">çŸ¥é“äº†</button>
  </div>
</div>
  
<script>

	
// ================= i18n å›½é™…åŒ–æ ¸å¿ƒæ•´ç»„å‡½æ•° =================
const translations = {
    zh: {
		submit: "æäº¤å¹¶è¯„åˆ†",
        scoreLabel: "å¾—åˆ†",
        perfect: "ğŸŒŸ å¤ªæ£’äº†ï¼å…¨å¯¹ï¼",
        great: "ğŸ‘ å¾ˆå¥½ï¼Œç»§ç»­ä¿æŒï¼",
        keepGoing: "ğŸ“– è¿˜è¦åŠ æ²¹å“¦ï¼",
        practiceMore: "ğŸ’ª éœ€è¦å¤šå¤šç»ƒä¹ ï¼",
	    appTitle: "å®Œå½¢å¡«ç©º",
        gotIt: "çŸ¥é“äº†",
        feedback: "å¦‚æœè¿™ä¸ªå·¥å…·æœ‰å¸®åŠ©",
        contactLink: "å¦‚åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·è”ç³»æˆ‘ ğŸ“©",
        interval: "é—´éš”", words: "è¯", placeholder: "åœ¨æ­¤ç²˜è´´è‹±æ–‡æˆ–ä¸­æ–‡æ–‡æœ¬...", paste: "ğŸ“‹ ç²˜è´´",
        clear: "æ¸…ç©º", generate: "ç”Ÿæˆç»ƒä¹ ", custom: "æ‰‹åŠ¨æŒ–ç©º", guide: "ğŸ“– æ‰‹å†Œ", login: "ğŸ‘¤ ç™»å½•/åŒæ­¥",
        synced: "âœ… å·²åŒæ­¥", back: "â† è¿”å›",
        // Login Modal
        loginTitle: "ğŸ‘¤ è´¦å·ç™»å½•", googleLogin: "ä½¿ç”¨ Google ç™»å½•", or: "â€”â€”â€”â€” æˆ–è€… â€”â€”â€”â€”",
        emailPlace: "é‚®ç®±", passPlace: "å¯†ç ", loginBtn: "ç™» å½•", signupBtn: "æ–°ç”¨æˆ·æ³¨å†Œ",
        syncTitle: "â˜ï¸ äº‘åŒæ­¥å·²å¼€å¯", s1t: "è‡ªåŠ¨ä¸Šä¼ ", s1d: "æ‚¨åœ¨æœ¬åœ°åšçš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šå®æ—¶åŒæ­¥è‡³äº‘ç«¯",
        s2t: "è‡ªåŠ¨ä¸‹è½½", s2d: "ç™»å½•æ–°è®¾å¤‡æ—¶ï¼Œæ‚¨çš„è¯¾æœ¬å’ŒæŒ–ç©ºè®°å½•ä¼šè‡ªåŠ¨æ¢å¤ã€‚", logoutBtn: "é€€å‡ºå½“å‰è´¦å·",
        // Guide Modal
        guideTitle: "ğŸ“– ä½¿ç”¨è¯´æ˜", gotIt: "çŸ¥é“äº†",
        g1t: "æŒ–ç©ºé—´éš”", g1d: "åœ¨ Every...th æ¡†ä¸­è®¾ç½®ã€‚",
        g2t: "æ‰‹åŠ¨æŒ–ç©º", g2d: "ç‚¹å‡»å•è¯æŒ–ç©ºï¼Œé•¿æŒ‰æ’¤é”€ã€‚",
        g3t: "å•è¯æç¤º", g3d: "æŒ‰ç©ºæ ¼é”®æç¤ºä¸‹ä¸€ä¸ªæ­£ç¡®å­—æ¯ã€‚",
        g4t: "ä¿å­˜è¿›åº¦", g4d: "é€šè¿‡è´¦å·ç™»å½•ä¿å­˜å½“å‰è¯¾æœ¬ï¼ŒæŒç»­è·Ÿè¿›ä¸ªäººå­¦ä¹ è¿›åº¦ã€‚",
        g5t: "å®‰è£…ä¸ºApp", g5d: "åœ¨æµè§ˆå™¨èœå•ä¸­é€‰æ‹©â€œæ·»åŠ åˆ°ä¸»å±å¹•â€",
        // Confirmations
        confirmClear: "ç¡®å®šæ¸…ç©ºå½“å‰æ–‡æœ¬å—ï¼Ÿ", logoutConfirm: "ç¡®å®šé€€å‡ºç™»å½•å—ï¼Ÿ",
        deleteConfirm: "åˆ é™¤æ­¤æ–‡ä»¶ï¼Ÿ", revokeConfirm: "ç¡®å®šæ’¤é”€è¿™ä¸ªæŒ–ç©ºå—ï¼Ÿ",
        renamePrompt: "é‡å‘½åæ–‡ä»¶:"
    },
    en: {
		submit: "Submit & Score",
        scoreLabel: "Score",
        perfect: "ğŸŒŸ Perfect! Well done!",
        great: "ğŸ‘ Great job, keep it up!",
        keepGoing: "ğŸ“– Almost there, keep going!",
        practiceMore: "ğŸ’ª Needs more practice!",	
	    appTitle: "Cloze Test",
        gotIt: "Got it",
        feedback: "If this tool helped you",
        contactLink: "Found an issue? Contact me ğŸ“©",
        interval: "Every", words: "th", placeholder: "Paste English or Chinese text here...", paste: "ğŸ“‹ Paste Text",
        clear: "Clear", generate: "Generate", custom: "Manual", guide: "ğŸ“– Guide", login: "ğŸ‘¤ Login/Sync",
        synced: "âœ… Synced", back: "â† Back",
        // Login Modal
        loginTitle: "ğŸ‘¤ Account Login", googleLogin: "Sign in with Google", or: "â€”â€”â€”â€” OR â€”â€”â€”â€”",
        emailPlace: "Email", passPlace: "Password", loginBtn: "Login", signupBtn: "Sign Up",
        syncTitle: "â˜ï¸ Cloud Sync Active", s1t: "Auto Upload", s1d: "Changes sync to cloud instantly.",
        s2t: "Auto Download", s2d: "Data restores on new devices.", logoutBtn: "Log Out",
        // Guide Modal
        guideTitle: "ğŸ“– Instructions", gotIt: "Got it",
        g1t: "Interval", g1d: "Set gaps in the 'Every...th' box.",
        g2t: "Manual Mode", g2d: "Click a word to hide, long press to undo.",
        g3t: "Hints", g3d: "Press Space for the next correct letter.",
        g4t: "Sync Progress", g4d: "Sign in to save books and track progress.",
        g5t: "Install App", g5d: "elect 'Add to Home Screen' in the browser menu.",
        // Confirmations
        confirmClear: "Are you sure you want to clear the text?", logoutConfirm: "Are you sure you want to log out?",
        deleteConfirm: "Delete this file?", revokeConfirm: "Revoke this cloze?",
        renamePrompt: "Rename file to:"
    }
};

// ====================è·Ÿæ‰“ç»ƒä¹ ============================
let typingIndex = 0;
let rawTextArray = [];
window.typingModeActive = false;

// 1. å¼€å¯è·Ÿæ‰“æ¨¡å¼
window.startTypingMode = function() {
    const text = inputArea.value.trim();
    if (!text) return;

    rawTextArray = text.split("");
    typingIndex = 0;
    window.typingModeActive = true;

    // æ¸²æŸ“ UI
    const clozeContent = document.getElementById("clozeContent");
    clozeContent.style.position = "relative";
    clozeContent.innerHTML = `<div class="typing-container" id="typeBox" onclick="focusTyping()" style="padding-bottom: 60vh;"></div>`;
    const typeBox = document.getElementById("typeBox");
    
    typeBox.innerHTML = rawTextArray.map((char, i) => {
        let displayChar = char === '\n' ? 'â†µ<br>' : (char === ' ' ? '&nbsp;' : char);
        return `<span class="char-unit" id="char-${i}">${displayChar}</span>`;
    }).join("");

    // éšè—ä¸»ç•Œé¢
    ["topSection","bottomAction","footerSection","pasteBtn","inputText"].forEach(id => {
        document.getElementById(id).classList.add("hidden");
    });
    document.getElementById("submitBtn").style.display = "none"; // è·Ÿæ‰“æ¨¡å¼ä¸éœ€è¦æäº¤æŒ‰é’®
    displayArea.classList.add("active");
    
    updateTypingDisplay();

    // å”¤èµ·é”®ç›˜
    focusTyping();
    
    // ç›‘å¬è¾“å…¥
    const hiddenInput = document.getElementById("hiddenInput");
    hiddenInput.oninput = (e) => {
        const val = e.target.value;
        if (val) {
            handleInputChar(val.substring(val.length - 1)); // å–æœ€åä¸€ä¸ªè¾“å…¥çš„å­—ç¬¦
            e.target.value = ""; // æ¸…ç©º
        }
    };
    
    // ä¸“é—¨å¤„ç†å›è½¦æ¢è¡Œ
    hiddenInput.onkeydown = (e) => {
        if (e.key === "Enter") {
            handleInputChar("\n");
        }
    };
};

// 2. èšç„¦å‡½æ•°
window.focusTyping = function () {
    const input = document.getElementById("hiddenInput");

    if (input) {
        input.focus({ preventScroll: true });
    }
};

function handleInputChar(inputChar) {
    if (typingIndex >= rawTextArray.length) return;

    const targetChar = rawTextArray[typingIndex];
    const currentEl = document.getElementById(`char-${typingIndex}`);

    // æ­£ç¡®è¾“å…¥
    if (inputChar.toLowerCase() === targetChar.toLowerCase()) {
        currentEl.classList.remove("char-wrong");
        currentEl.classList.add("char-correct");

        typingIndex++;
        updateTypingDisplay();
    }
    // é”™è¯¯è¾“å…¥
    else {
        currentEl.classList.add("char-wrong");
    }
}

// 4. æ›´æ–°å…‰æ ‡ä½ç½®
function updateTypingDisplay() {
    document.querySelectorAll('.char-current').forEach(el => el.classList.remove('char-current'));
    const currentEl = document.getElementById(`char-${typingIndex}`);
    
    if (currentEl) {
        currentEl.classList.add('char-current');
        
        // é’ˆå¯¹ iOS çš„å¹³æ»‘æ»šåŠ¨ä¼˜åŒ–
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        requestAnimationFrame(() => {
            currentEl.scrollIntoView({ 
                behavior: 'auto', 
                block: isIOS ? 'nearest' : 'center' // iOS ä¸‹ center æœ‰æ—¶ä¼šå¯¼è‡´è¿‡åº¦æ»šåŠ¨
            });

        });
    } else if (typingIndex >= rawTextArray.length && rawTextArray.length > 0) {
        alert("ğŸ‰ ç»ƒä¹ å®Œæˆï¼");
        exitExercise();
    }
}

// 5. ä¿®æ”¹åŸæœ‰çš„ exitExercise
const oldExitExercise = window.exitExercise;
window.exitExercise = function() {
    window.typingModeActive = false;
    const hiddenInput = document.getElementById("hiddenInput");
    if (hiddenInput) hiddenInput.oninput = null;
    
    // è°ƒç”¨åŸæœ‰é€»è¾‘æ¢å¤ UI
    ["topSection","bottomAction","footerSection","pasteBtn","inputText"].forEach(id => {
        document.getElementById(id).classList.remove("hidden");
    });
    displayArea.classList.remove("active");
    document.getElementById("submitBtn").style.display = "block";
};


// =====================================================
window.calculateScore = function() {
    const inputs = document.querySelectorAll("#clozeContent input");
    if (inputs.length === 0) return;

    let correctCount = 0;
    const totalCount = inputs.length;
    const dict = translations[currentLang]; // è·å–å½“å‰è¯­è¨€åŒ…

    inputs.forEach(input => {
        const ans = answers[input.dataset.id].toLowerCase().trim();
        const val = input.value.toLowerCase().trim();
        
        if (val === ans) {
            correctCount++;
            input.style.border = "2px solid #43a047";
        } else {
            input.style.border = "2px solid #ff5252";
            input.value = ""; 
            input.placeholder = (currentLang === 'zh' ? "ç­”æ¡ˆ: " : "Ans: ") + ans;
        }
    });

    const score = Math.round((correctCount / totalCount) * 100);
    const scoreDisplay = document.getElementById("scoreResult");
    
    // æ ¹æ®è¯­è¨€åŒ…æ˜¾ç¤ºè¯„ä»·
    let comment = "";
    if (score === 100) comment = dict.perfect;
    else if (score >= 80) comment = dict.great;
    else if (score >= 60) comment = dict.keepGoing;
    else comment = dict.practiceMore;

    scoreDisplay.innerHTML = `${dict.scoreLabel}: ${score}% (${correctCount}/${totalCount}) <br> ${comment}`;
    scoreDisplay.scrollIntoView({ behavior: 'smooth' });
};

// =====================================================
let currentLang = localStorage.getItem('app_lang') || 'zh';

window.toggleLanguage = function() {
    currentLang = currentLang === 'zh' ? 'en' : 'zh';
    localStorage.setItem('app_lang', currentLang);
    applyLanguage();
};

window.applyLanguage = function() {
    const dict = translations[currentLang];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (dict[key]) {
            if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
                el.placeholder = dict[key];
            } else {
                el.innerHTML = dict[key];
            }
        }
    });
    // ç‰¹æ®ŠçŠ¶æ€æ›´æ–°
    const loginLabel = document.getElementById('loginBtnLabel');
    if (loginLabel) {
        loginLabel.innerText = window.currentUser ? dict.synced : dict.login;
    }
};
// =====================================================
  
const DEFAULT_TEXT = `"ç¤ºä¾‹æ–‡æœ¬"ã€‚

Hello?

- Sara, it's Lara.

- Oh, hi Lara, what's up?

Just wanted to check and make sure you're still coming into work tonight.

Sure, I could really use the money.

Mom, finally cut off my finances.

Oh, okay.

Well, we've got something really important to talk about when you get here.

Sure, well, I'll be there in a little bit.

Yeah, don't rush though, it's so dead in here.

Oh, that's too bad.

Well, I'll see ya.

Okay, bye.`;

	// æ ¸å¿ƒå‡½æ•°ï¼šæ ¹æ®å•è¯é•¿åº¦ç”Ÿæˆ A _ _ _ e æ ·å¼çš„æç¤º
function getSmartHint(word) {
    if (!word || word.length <= 1) return "_"; 
    
    // é€»è¾‘ï¼š
    // 1. é•¿åº¦ <= 4 (å¦‚ the, cat, book): åªç»™é¦–å­—æ¯
    // 2. é•¿åº¦ > 4 (å¦‚ apple, finances): ç»™é¦–å°¾å­—æ¯
    if (word.length <= 4) {
        return word[0] + "_".repeat(word.length - 1);
    } else {
        return word[0] + "_".repeat(word.length - 2) + word[word.length - 1];
    }
}

window.files = [];
// ç™»å½•ç”¨æˆ·æ‰å…è®¸åŠ è½½æœ¬åœ°æ–‡ä»¶
function loadLocalFilesIfLoggedIn() {

    if (!window.currentUser) {
        console.log("ğŸ‘¤ æ¸¸å®¢æ¨¡å¼ï¼šä¸åŠ è½½ä»»ä½•æ–‡ä»¶");
        return;
    }

    const saved = localStorage.getItem("cloze_files_v5");

    if (saved) {
        window.files = JSON.parse(saved);
        activeFileId = files[0]?.id || null;
    }

    console.log("âœ… ç™»å½•ç”¨æˆ·æ–‡ä»¶åŠ è½½å®Œæˆ:", files);
}
let activeFileId = null;
let currentFontSize = 18;
let answers = [];

const inputArea = document.getElementById("inputText");
const displayArea = document.getElementById("clozeDisplay");
const clozeContent = document.getElementById("clozeContent");

// ---------------- åˆå§‹åŒ– ----------------
function init() {

    // æœªç™»å½•ï¼šæ¸¸å®¢æ¨¡å¼
    if (!window.currentUser) {

        console.log("ğŸ‘¤ æ¸¸å®¢æ¨¡å¼å¯åŠ¨");

        // æ¸…ç©ºæ–‡ä»¶ç³»ç»Ÿ
        window.files = [];
        activeFileId = null;

        // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆå…³é—­ç½‘é¡µå³æ¶ˆå¤±ï¼‰
        inputArea.value = "";

        // éšè—é¡¶éƒ¨æ–‡ä»¶æ 
        document.getElementById("fileTabs").classList.add("hidden");

        return;
    }

    // ç™»å½•ç”¨æˆ·æ¨¡å¼
    console.log("âœ… ç™»å½•ç”¨æˆ·æ¨¡å¼å¯åŠ¨");

    document.getElementById("fileTabs").classList.remove("hidden");

    renderTabs();
    loadActiveFile();
}

// ---------------- ç²˜è´´ ----------------
async function handlePaste() {
  if (!navigator.clipboard) return;
  try {
    const text = await navigator.clipboard.readText();
    if (text) { inputArea.value=text; saveActiveFile(); 
      const btn=document.getElementById("pasteBtn"); 
      btn.style.background="#888"; 
      setTimeout(()=>{btn.style.background="var(--primary)";},800); 
    }
  } catch { console.log("Paste failed"); }
}

// ---------------- æ–‡ä»¶æ ‡ç­¾ ----------------
function renderTabs() {

    const tabs = document.getElementById("fileTabs");
    tabs.innerHTML = "";

    // æ¸¸å®¢æ¨¡å¼ï¼šä¸æ˜¾ç¤ºæ–‡ä»¶ç³»ç»Ÿ
    if (!window.currentUser) {
        tabs.classList.add("hidden");
        return;
    }

    tabs.classList.remove("hidden");

    // ç™»å½•ç”¨æˆ·æ–‡ä»¶æ ‡ç­¾
    files.forEach(f => {

        const div = document.createElement("div");
        div.className = `file-tab ${f.id === activeFileId ? "active" : ""}`;

        div.onclick = () => switchFile(f.id);

        div.innerHTML = `
            <span>${f.title}</span>
            <span style="color:var(--danger);margin-left:10px;font-weight:bold;"
                onclick="deleteFile(${f.id}, event)">Ã—</span>
        `;

        tabs.appendChild(div);
    });

    // âœ…â€œï¼‹â€æŒ‰é’®åªåœ¨ç™»å½•åå‡ºç°
    const btn = document.createElement("button");
    btn.className = "add-file-btn";
    btn.innerHTML = "ï¼‹";
    btn.onclick = saveAsNewCloudFile;

    tabs.appendChild(btn);
}


// âœ…ä¿å­˜é€»è¾‘ï¼šæ¸¸å®¢ä¸ä¿å­˜
function save() {

    // æ¸¸å®¢æ¨¡å¼ï¼šä¸å…è®¸ä¿å­˜
    if (!window.currentUser) {
        console.log("ğŸš« æ¸¸å®¢æ¨¡å¼ï¼šä¸ä¿å­˜ä»»ä½•æ•°æ®");
        return;
    }

    // ç™»å½•æ¨¡å¼ï¼šå†™å…¥æœ¬åœ° + äº‘åŒæ­¥
    localStorage.setItem("cloze_files_v5", JSON.stringify(files));

    if (window.syncToCloud) {
        window.syncToCloud(files);
    }
}


function saveActiveFile() {

    // æ¸¸å®¢æ¨¡å¼ï¼šè¾“å…¥å†…å®¹ä¸å­˜å‚¨
    if (!window.currentUser) return;

    const f = files.find(x => x.id === activeFileId);
    if (f) {
        f.content = inputArea.value;
        save();
    }
}
// =======================
// âœ…â€œï¼‹â€æŒ‰é’®ï¼šä¿å­˜ä¸ºæ–°æ–‡ä»¶
// =======================

async function saveAsNewCloudFile() {

    if (!window.currentUser) return;

    const content = inputArea.value.trim();
    if (!content) {
        alert("å†…å®¹ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜");
        return;
    }

    // ç”¨æˆ·å¡«å†™æ–‡ä»¶å
    const title = prompt("è¯·è¾“å…¥æ–‡ä»¶åï¼š");
    if (!title) return;

    // åˆ›å»ºæ–°æ–‡ä»¶å¯¹è±¡
    const newFile = {
        id: Date.now(),
        title: title,
        content: content,
        clozePositions: []
    };

    // æ¨å…¥æ–‡ä»¶ç³»ç»Ÿ
    files.push(newFile);
    activeFileId = newFile.id;

    // ä¿å­˜åˆ°äº‘ç«¯
    save();

    // æ›´æ–° UI
    renderTabs();
    loadActiveFile();

    alert("âœ…å·²ä¿å­˜åˆ°äº‘ç«¯ï¼");
}

// =======================
// âœ…åŠ è½½å½“å‰æ–‡ä»¶ï¼ˆç™»å½•ç”¨æˆ·ï¼‰
// =======================

function loadActiveFile() {

    if (!window.currentUser) return;

    const f = files.find(x => x.id === activeFileId);
    if (!f) return;

    inputArea.value = f.content || "";
    answers = [];
}

// ---------------- å­—ä½“ ----------------
function changeFontSize(d){ 
  currentFontSize+=d; 
  if(currentFontSize<12) currentFontSize=12; 
  inputArea.style.fontSize=displayArea.style.fontSize=currentFontSize+"px"; 
  document.getElementById("sizeLabel").innerText=currentFontSize; 
}

// ---------------- æ¸…ç©º ----------------
function handleClear() {

    if (!confirm(translations[currentLang].confirmClear)) return;

    inputArea.value = "";

    // æ¸¸å®¢æ¨¡å¼ï¼šæ¸…ç©ºå³ç»“æŸï¼Œä¸ä¿å­˜
    if (!window.currentUser) {
        console.log("ğŸ‘¤ æ¸¸å®¢æ¸…ç©ºï¼šä¸å†™å…¥ä»»ä½•æ•°æ®");
        return;
    }

    // ç™»å½•ç”¨æˆ·ï¼šåªæœ‰ä¿å­˜è¿‡æ–‡ä»¶æ‰åŒæ­¥
    const f = files.find(x => x.id === activeFileId);
    if (f) {
        f.content = "";
        f.clozePositions = [];
        save();
    }
}

// ---------------- æ¯ N ä¸ªè¯æŒ–ç©º ----------------
function generateCloze(text,n){
  let index=0; answers=[];
  const regex = /\([^)]*\)|[a-zA-Z]+|[\u4e00-\u9fa5]/g;
  return text.replace(regex,(match)=>{
    if (match.startsWith('(')) return `<span style="color:#999;font-style:italic;">${match}</span>`;
    index++;
    if(index%n===1){
      const id = answers.length;
      answers.push(match);
      const isChinese = /[\u4e00-\u9fa5]/.test(match);
      const boxWidth = isChinese ? 2 : match.length + 1;
     // æ‰¾åˆ°è¿™ä¸€è¡Œå¹¶ä¿®æ”¹
  return `<input data-id="${id}" autocomplete="off" style="width:${boxWidth}ch; font-family:inherit; vertical-align:middle; line-height:1; height:1.5em;" onfocus="this.select(); this.scrollIntoView({behavior:'smooth',block:'center'});">`;
 
    }
    return match;
  });
}

// ------------------ ä¿®æ”¹åçš„è‡ªåŠ¨ç”Ÿæˆç»ƒä¹ å‡½æ•° (å¢åŠ çº¢å­—é€»è¾‘) ------------------
function handleGenerate(){
  if(!inputArea.value.trim()) return;
  const n=parseInt(document.getElementById("nthWord").value)||4;
  clozeContent.innerHTML=generateCloze(inputArea.value,n);
  ["topSection","bottomAction","footerSection","pasteBtn","inputText"].forEach(id=>document.getElementById(id).classList.add("hidden"));
  displayArea.classList.add("active");

  clozeContent.querySelectorAll("input").forEach(input=>{
    // --- ã€æ–°å¢ï¼šåœ¨æ­¤å¤„æ·»åŠ å•è¯æç¤ºã€‘ ---
    const targetAns = answers[input.dataset.id];
    input.placeholder = getSmartHint(targetAns);

    input.oninput=()=>{
      const ans=answers[input.dataset.id];
      const val=input.value.trim();
      
      // èƒŒæ™¯è‰²é€»è¾‘
      input.style.backgroundColor=val.toLowerCase()===ans.toLowerCase()?"#c8f7c5":(val?"#f7c5c5":"#fffde7");
      
      // é”™å­—çº¢å­—é€»è¾‘
      if (val && !ans.toLowerCase().startsWith(val.toLowerCase())) {
        input.style.color = "var(--danger)"; 
      } else {
        input.style.color = "#000";
      }
    };

    input.onkeydown=(e)=>{
      if(e.code==='Space'||e.keyCode===32){ 
        e.preventDefault(); 
        const ans=answers[input.dataset.id]; 
        input.value=ans.substring(0,input.value.length+1); 
        input.oninput(); 
      }
    };
  });
}

// ---------------- é€€å‡º ----------------
function exitExercise(){ 
  ["topSection","bottomAction","footerSection","pasteBtn","inputText"].forEach(id=>document.getElementById(id).classList.remove("hidden")); 
  displayArea.classList.remove("active"); 
}

// ---------------- ç‚¹å‡»æŒ–ç©º + ä¿å­˜ ----------------
function enableCustomCloze() {
  const text = inputArea.value;
  if (!text) return;

  // æ­£åˆ™è¯´æ˜ï¼šåŒ¹é…è‹±æ–‡å•è¯ã€å•ä¸ªä¸­æ–‡å­—ç¬¦ã€æˆ–è€…éç©ºç™½æ ‡ç‚¹
  const regex = /([a-zA-Z]+|[\u4e00-\u9fa5]|[^\s\w\u4e00-\u9fa5]+)/g;
  const segments = text.split(regex);
  
  const f = files.find(x => x.id === activeFileId);
  if (!f) return;

  answers = [];
  let unitCount = 0; 

  clozeContent.innerHTML = segments.map((seg) => {
    if (!seg || !seg.trim()) return seg; 
    if (seg.startsWith('(')) return `<span style="color:#999;font-style:italic;">${seg}</span>`;

    const currentIdx = unitCount++;
    const isChinese = /[\u4e00-\u9fa5]/.test(seg);
    const boxWidth = isChinese ? 2 : seg.length + 1;

if (f.clozePositions.includes(currentIdx)) {
    answers.push(seg);
    
    // --- æ–°å¢ï¼šè·å–æç¤ºå†…å®¹ ---
    const hint = isChinese ? "?" : getSmartHint(seg);

    // åœ¨è¿”å›çš„å­—ç¬¦ä¸²ä¸­æ·»åŠ  placeholder="${hint}"
    return `<input data-id="${answers.length - 1}" data-index="${currentIdx}" autocomplete="off" 
            placeholder="${hint}"
            style="width:${boxWidth}ch; font-family:inherit; vertical-align:middle; line-height:1; height:1.5em;" 
            onfocus="this.select(); this.scrollIntoView({behavior:'smooth',block:'center'});"
            oncontextmenu="return false;">`;
}

    return `<span class="word-span" data-index="${currentIdx}">${seg}</span>`;
  }).join("");

  displayArea.classList.add("active");
  ["topSection", "bottomAction", "footerSection", "pasteBtn", "inputText"].forEach(id => document.getElementById(id).classList.add("hidden"));

  bindCustomEvents(f);
}

// ------------------ ä¿®æ”¹åçš„äº‹ä»¶ç»‘å®šå‡½æ•° (å¤„ç†é•¿æŒ‰æ’¤é”€) ------------------
function bindCustomEvents(f) {
  clozeContent.querySelectorAll(".word-span, input").forEach((el) => {
    let longPressTimer;
    let isLongPress = false;

    // --- å¤„ç† Span (æœªæŒ–ç©ºçš„å•è¯) ---
    if (el.tagName === "SPAN" && el.classList.contains('word-span')) {
      el.style.cursor = "pointer";
      el.onclick = () => {
        // å¦‚æœåˆšåˆšè§¦å‘äº†é•¿æŒ‰ï¼Œåˆ™ä¸æ‰§è¡Œå•å‡»é€»è¾‘
        if (isLongPress) {
          isLongPress = false;
          return;
        }
        const wordIndex = parseInt(el.dataset.index);
        f.clozePositions.push(wordIndex);
        save();
        enableCustomCloze();
      };
    }

    // --- å¤„ç† Input (å·²æŒ–ç©ºçš„å•è¯) ---
    if (el.tagName === "INPUT") {
      // 1. è¾“å…¥æ ¡éªŒä¸çº¢å­—é€»è¾‘ (ä¿æŒä¸å˜)
      el.oninput = () => {
        const ans = answers[el.dataset.id];
        const val = el.value.trim();
        el.style.backgroundColor = val.toLowerCase() === ans.toLowerCase() ? "#c8f7c5" : (val ? "#f7c5c5" : "#fffde7");
        el.style.color = (val && !ans.toLowerCase().startsWith(val.toLowerCase())) ? "var(--danger)" : "#000";
      };

      el.onkeydown = (e) => {
        if (e.code === 'Space' || e.keyCode === 32) {
          e.preventDefault();
          const ans = answers[el.dataset.id];
          el.value = ans.substring(0, el.value.length + 1);
          el.oninput();
        }
      };

      // 2. é•¿æŒ‰é€»è¾‘ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰ï¼šå–æ¶ˆæŒ–ç©º
      const startLongPress = (e) => {
        isLongPress = false;
        longPressTimer = setTimeout(() => {
          isLongPress = true;
          if (confirm(translations[currentLang].revokeConfirm)) {
            const wordIndex = parseInt(el.dataset.index);
            f.clozePositions = f.clozePositions.filter(i => i !== wordIndex);
            save();
            enableCustomCloze();
          }
        }, 800); // 800ms åˆ¤å®šä¸ºé•¿æŒ‰
      };

      const cancelLongPress = () => {
        clearTimeout(longPressTimer);
      };

      // æ‰‹æœºç«¯
      el.ontouchstart = startLongPress;
      el.ontouchend = cancelLongPress;
      
      // ç”µè„‘ç«¯ (å·¦é”®é•¿æŒ‰)
      el.onmousedown = (e) => {
        if (e.button === 0) startLongPress();
      };
      el.onmouseup = cancelLongPress;
      el.onmouseleave = cancelLongPress;

      // å±è”½å³é”®èœå• (é˜²æ­¢å¹²æ‰°é•¿æŒ‰ä½“éªŒ)
      el.oncontextmenu = (e) => e.preventDefault();
    }
  });
}

// âœ…è¾“å…¥å˜åŒ–ï¼šä¸å†è‡ªåŠ¨åŒæ­¥
inputArea.oninput = () => {

    // æ¸¸å®¢æ¨¡å¼ï¼šä¸ä¿å­˜
    if (!window.currentUser) return;

    // ç™»å½•æ¨¡å¼ï¼šåªæœ‰ activeFile å­˜åœ¨æ‰åŒæ­¥
    if (!activeFileId) return;

    saveActiveFile();
};



// ---------------- å¼¹çª—æ§åˆ¶ ----------------
function openGuide() {
  document.getElementById("guideModal").style.display = "flex";
}

function closeGuide() {
  document.getElementById("guideModal").style.display = "none";
}
</script>

<script type="module">
  // 1. å¯¼å…¥éƒ¨åˆ†ï¼šæ³¨æ„å¢åŠ äº† onValue
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getDatabase, ref, get, set, runTransaction, onValue , push} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
    authDomain: "cloze-master-pro.firebaseapp.com",
    projectId: "cloze-master-pro",
    databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
    storageBucket: "cloze-master-pro.firebasestorage.app",
    messagingSenderId: "697808901954",
    appId: "1:697808901954:web:32455d94bf67e522e01adb"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const googleProvider = new GoogleAuthProvider(); // åˆå§‹åŒ– Google æä¾›è€…
  let currentUser = null;

  googleProvider.setCustomParameters({
    prompt: 'select_account'
  });

// --- åŠŸèƒ½ A: ç”Ÿæˆåˆ†äº«é“¾æ¥ ---
window.shareFile = async (fileId) => {

    if (!currentUser) {
        alert(currentLang === 'zh'
            ? "è¯·å…ˆç™»å½•å†åˆ†äº«æ–‡ä»¶"
            : "Please login to share files");
        return;
    }

    const fileToShare = files.find(f => f.id === fileId);
    if (!fileToShare) return;

    try {
        const publicRef = ref(db, 'public_files');
        const newShareRef = push(publicRef);
        const shareId = newShareRef.key;

        await set(newShareRef, {
            title: fileToShare.title,
            content: fileToShare.content,
            clozePositions: fileToShare.clozePositions || [],
            author: currentUser.email,
            timestamp: Date.now()
        });

        const shareUrl =
            `${window.location.origin}${window.location.pathname}?share=${shareId}`;

        await navigator.clipboard.writeText(shareUrl);

        alert(currentLang === 'zh'
            ? "åˆ†äº«é“¾æ¥å·²å¤åˆ¶ï¼"
            : "Share link copied!");

    } catch (e) {
        alert("Share failed: " + e.message);
    }
};

// âœ…æ£€æµ‹åˆ†äº«é“¾æ¥ï¼ˆæ¸¸å®¢åªé¢„è§ˆï¼Œç™»å½•å¯å¯¼å…¥ï¼‰
window.checkAndLoadSharedFile = async () => {

    const urlParams = new URLSearchParams(window.location.search);
    const shareId = urlParams.get("share");

    if (!shareId) return;

    console.log("ğŸ“¡ æ£€æµ‹åˆ°åˆ†äº«æ–‡ä»¶:", shareId);

    const shareRef = ref(db, `public_files/${shareId}`);

    try {
        const snap = await get(shareRef);

        if (!snap.exists()) {
            alert("âš ï¸ åˆ†äº«é“¾æ¥å·²å¤±æ•ˆ");
            return;
        }

        const data = snap.val();

        // ==========================
        // ğŸ‘¤ æ¸¸å®¢æ¨¡å¼ï¼šåªè¯»é¢„è§ˆ
        // ==========================

        if (!currentUser) {

            alert(currentLang === 'zh'
                ? `æ¸¸å®¢æ¨¡å¼ï¼šæ­£åœ¨é¢„è§ˆåˆ†äº«æ–‡ä»¶ "${data.title}"`
                : `Guest preview: "${data.title}"`);

            // åªå±•ç¤ºå†…å®¹ï¼Œä¸å¯¼å…¥ï¼Œä¸ä¿å­˜
            inputArea.value = data.content;

            // ä¸æ˜¾ç¤ºæ–‡ä»¶æ 
            document.getElementById("fileTabs").classList.add("hidden");

            return;
        }

        // ==========================
        // âœ… ç™»å½•æ¨¡å¼ï¼šå…è®¸å¯¼å…¥
        // ==========================

        const msg = currentLang === 'zh'
            ? `å‘ç°åˆ†äº«æ–‡ä»¶ "${data.title}"ï¼Œæ˜¯å¦å¯¼å…¥åˆ°ä½ çš„æ–‡ä»¶ï¼Ÿ`
            : `Import shared file "${data.title}" into your account?`;

        if (!confirm(msg)) return;

        const newFile = {
            id: Date.now(),
            title: data.title + " (Shared)",
            content: data.content,
            clozePositions: data.clozePositions || []
        };

        files.push(newFile);
        activeFileId = newFile.id;
		
	    init();
        save();
        renderTabs();
        loadActiveFile();

        alert(currentLang === 'zh'
            ? "âœ…å¯¼å…¥æˆåŠŸï¼"
            : "Import successful!");

        // æ¸…é™¤ URL å‚æ•°
        window.history.replaceState({}, document.title, window.location.pathname);

    } catch (e) {
        console.error("âŒåŠ è½½åˆ†äº«å¤±è´¥:", e.message);
        alert("Load failed: " + e.message);
    }
};
  
  // --- ç™»å½•/æ³¨å†Œé€»è¾‘ ---
  window.handleEmailAuth = async (type) => {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    if (!email || !password) return alert("è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ");
    try {
      if (type === 'signup') {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("æ³¨å†ŒæˆåŠŸï¼æ•°æ®å°†åŒæ­¥è‡³æ­¤è´¦å·ã€‚");
      } else {
        await signInWithEmailAndPassword(auth, email, password);
        alert("ç™»å½•æˆåŠŸï¼");
      }
      window.closeLoginModal();
    } catch (e) { alert("æ“ä½œå¤±è´¥: " + e.message); }
  };

  window.handleLogout = () => { if(confirm(translations[currentLang].logoutConfirm)) signOut(auth); };

// ------------------ ä¿®å¤åçš„ç™»å½•çŠ¶æ€ç›‘å¬ ------------------
onAuthStateChanged(auth, (user) => {
    const btnLabel = document.getElementById('loginBtnLabel');
    const loggedOutUI = document.getElementById('loggedOutUI');
    const loggedInUI = document.getElementById('loggedInUI');
    const emailDisplay = document.getElementById('userEmailDisplay');

    if (user) {
        currentUser = user;
		window.currentUser = user;
		init();
        // æ›´æ–°åº•éƒ¨æŒ‰é’®æ–‡å­—
        if (btnLabel) {
            btnLabel.innerText = "âœ… å·²åŒæ­¥";
            btnLabel.style.color = "#81c784";
        }
        
        // åˆ‡æ¢ UI é¢æ¿ï¼šæ˜¾ç¤ºåŒæ­¥è¯´æ˜ï¼Œéšè—ç™»å½•æ¡†
        if (loggedOutUI) loggedOutUI.classList.add('hidden');
        if (loggedInUI) {
            loggedInUI.classList.remove('hidden');
            // ç¡®ä¿åŒæ­¥è¯´æ˜æ–‡å­—æ­£ç¡®æ˜¾ç¤º
            if (emailDisplay) emailDisplay.innerText = "å½“å‰è´¦å·: " + user.email;
        }

        // æ‰§è¡Œäº‘ç«¯æ•°æ®åŠ è½½
        get(ref(db, `users/${user.uid}/files`)).then(snapshot => {
            if (snapshot.exists()) applyData(snapshot.val());
        });
        startRealtimeSync(user.uid);
    } else {
        currentUser = null;
		window.currentUser = null;
        // æ¢å¤åº•éƒ¨æŒ‰é’®æ–‡å­—
        if (btnLabel) {
            btnLabel.innerText = "ğŸ‘¤ ç™»å½•/åŒæ­¥";
            btnLabel.style.color = "#42a5f5";
        }
        
        // æ¢å¤ UI é¢æ¿ï¼šæ˜¾ç¤ºç™»å½•æ¡†ï¼Œéšè—åŒæ­¥è¯´æ˜
        if (loggedOutUI) loggedOutUI.classList.remove('hidden');
        if (loggedInUI) loggedInUI.classList.add('hidden');
        
        // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œé˜²æ­¢ä¸‹æ¬¡ç™»å½•å¸¦å…¥é”™è¯¯æ•°æ®
        const emailInput = document.getElementById('authEmail');
        const passInput = document.getElementById('authPassword');
        if (emailInput) emailInput.value = "";
        if (passInput) passInput.value = "";
    }
});

// ------------------ å®æ—¶åŒæ­¥å‡½æ•°ï¼ˆå®Œæ•´å¯ç”¨ç‰ˆï¼‰ ------------------
function startRealtimeSync(uid) {
    if (!uid) return;

    const path = `users/${uid}/files`;
    const fileRef = ref(db, path);

    console.log("ğŸ“¡ å¼€å§‹ç›‘å¬äº‘ç«¯è·¯å¾„:", path);

    // ç»‘å®šå®æ—¶ç›‘å¬
    onValue(fileRef, (snapshot) => {
        if (!snapshot.exists()) {
            console.log("âš ï¸ äº‘ç«¯æš‚æ— æ•°æ®");
            return;
        }

        const cloudData = snapshot.val();
        console.log("ğŸ”¥ äº‘ç«¯æ•°æ®å˜æ›´ï¼Œè‡ªåŠ¨åŒæ­¥åˆ°æœ¬åœ°", cloudData);

        applyData(cloudData);
    });
}

	
// ------------------ åº”ç”¨äº‘ç«¯æ•°æ®åˆ°æœ¬åœ° ------------------
function applyData(data) {

    if (!Array.isArray(data)) return;

    window.files = data;
    localStorage.setItem("cloze_files_v5", JSON.stringify(data));

    // è‡ªåŠ¨é€‰ç¬¬ä¸€ä¸ªæ–‡ä»¶
    activeFileId = files[0]?.id || null;

    renderTabs();
    loadActiveFile();
}

// ------------------ ä¿®æ”¹åçš„äº‘ç«¯åŒæ­¥å‡½æ•° (å®Œæ•´ç‰ˆ) ------------------
window.syncToCloud = async function (data) {
    // 1. æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·ç™»å½•ï¼Œæ²¡ç™»å½•åˆ™ä¸ä¸Šä¼ 
    if (!currentUser) {
        console.log("â˜ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œæ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°");
        return;
    }

    try {
        const userPath = `users/${currentUser.uid}/files`;
        const userRef = ref(db, userPath);
        
        // 2. æ‰§è¡Œä¸Šä¼ 
        await set(userRef, data);
        
        console.log(`âœ… æ•°æ®å·²å®‰å…¨åŒæ­¥è‡³è·¯å¾„: ${userPath}`);
    } catch (e) {
        console.error("âŒ åŒæ­¥åˆ°äº‘ç«¯å¤±è´¥:", e.message);
        // å¦‚æœæ˜¯å› ä¸ºæƒé™é—®é¢˜ï¼ˆRulesè®¾ç½®ï¼‰ï¼Œè¿™é‡Œä¼šæŠ“åˆ°é”™è¯¯
        if (e.message.includes("Permission denied")) {
            alert("åŒæ­¥å¤±è´¥ï¼šæ‚¨æ²¡æœ‰æƒé™æ“ä½œæ­¤è·¯å¾„ã€‚");
        }
    }
};

// --- ç»Ÿè®¡é€»è¾‘ ---
const incrementVisit = async () => {
  const now = new Date();
  // è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ "2026-01-25"
  const todayStr = now.toISOString().split('T')[0]; 
  const lastVisitDay = localStorage.getItem('last_visit_day');

  // æ£€æŸ¥ï¼šå¦‚æœæœ¬åœ°å­˜çš„æ—¥æœŸä¸æ˜¯ä»Šå¤©ï¼Œè¯´æ˜æ˜¯æ–°çš„ä¸€å¤©
  if (lastVisitDay !== todayStr) {
    try {
      // 1. å¢åŠ äº‘ç«¯è®¿é—®æ¬¡æ•°
      await runTransaction(ref(db, "stats/visits"), v => (v || 0) + 1);
      
      // 2. æ›´æ–°æœ¬åœ°è®°å½•ä¸ºä»Šå¤©
      localStorage.setItem('last_visit_day', todayStr);
      console.log("ğŸš€ ä»Šå¤©çš„ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œè®¿é—®é‡å·²æ›´æ–°");
    } catch (e) {
      console.error("æ›´æ–°è®¿é—®é‡å¤±è´¥:", e);
    }
  } else {
    console.log("â³ ä»Šå¤©å·²ç»è®¡å…¥è¿‡è®¿é—®ï¼Œè·³è¿‡ç»Ÿè®¡");
  }
  
  // æ— è®ºæ˜¯å¦å¢åŠ ï¼Œæœ€åéƒ½åˆ·æ–°ä¸€ä¸‹ UI æ˜¾ç¤º
  window.loadStats();
};

window.likeApp = async () => {
    // 1. è·å–æ ‡è¯†ç¬¦ (ä¼˜å…ˆç™»å½• UIDï¼Œå…¶æ¬¡æœ¬åœ°éšæœº ID)
    const uid = currentUser ? currentUser.uid : localStorage.getItem("cloze_uid");
    if (!uid) {
        // å¦‚æœè¿æœ¬åœ° ID éƒ½æ²¡æœ‰ï¼ˆæå°‘è§ï¼‰ï¼Œå¯ä»¥ä¸´æ—¶ç”Ÿæˆä¸€ä¸ª
        const tempId = 'guest_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("cloze_uid", tempId);
    }

    const userLikeRef = ref(db, `likedUsers/${uid}`);
    
    try {
        const snap = await get(userLikeRef);
        if (snap.exists()) {
            alert(currentLang === 'zh' ? "ä½ å·²ç»ç‚¹è¿‡èµå•¦ â¤ï¸" : "You've already liked this â¤ï¸");
            return;
        }

        // 2. ä¹è§‚ UI æ›´æ–° (å¯é€‰)ï¼šç‚¹å‡»ç¬é—´è®©æ•°å­—å…ˆ +1ï¼Œæ˜¾å¾—å¾ˆå¿«
        const likeLabel = document.getElementById("likeCount");
        const currentLikes = parseInt(likeLabel.innerText);
        likeLabel.innerText = currentLikes + 1;

        // 3. å†™å…¥äº‘ç«¯
        await set(userLikeRef, true);
        await runTransaction(ref(db, "stats/likes"), v => (v || 0) + 1);
        
        // 4. åˆ·æ–°æ˜¾ç¤º (ç¡®ä¿æ•°æ®å‡†ç¡®)
        window.loadStats();
    } catch (e) {
        console.error("Like failed:", e);
    }
};
 

  window.openLoginModal = () => document.getElementById("loginModal").style.display = "flex";
  window.closeLoginModal = () => document.getElementById("loginModal").style.display = "none";

  if (typeof window.loadStats === 'function') window.loadStats();
  window.checkAndLoadSharedFile();
</script>
</body>
</html>
