<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Cloze Master Pro</title>
  <style>
    :root { --primary-color: #43a047; --bg-light: #f8f9fa; }
    * { box-sizing: border-box; }
    html, body { 
      margin: 0; padding: 0; width: 100%; height: 100%;
      font-family: -apple-system, system-ui, sans-serif; 
      background-color: #fff; color: #333;
    }

    /* 容器：使用 flex 布局填满屏幕 */
    .app-container { display: flex; flex-direction: column; height: 100vh; }

    /* 1. 文件导航栏 - 极致扁平化 */
    .file-tabs-container {
      background: #fff; padding: 8px 12px; display: flex; align-items: center;
      gap: 8px; border-bottom: 1px solid #eee; overflow-x: auto; white-space: nowrap;
    }
    .file-tab {
      padding: 4px 12px; background: var(--bg-light); border: 1px solid #ddd;
      border-radius: 15px; font-size: 13px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;
    }
    .file-tab.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    .delete-file-btn { color: #ff5252; font-size: 16px; margin-left: 4px; }

    /* 2. 控制栏 - 紧凑型 */
    .header-controls {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 15px; background: var(--bg-light); border-bottom: 1px solid #ddd;
      font-size: 14px;
    }
    .brand { font-weight: bold; color: var(--primary-color); font-size: 16px; }
    .font-controls { display: flex; align-items: center; gap: 5px; }
    .small-btn { border: 1px solid #ccc; background: #fff; padding: 2px 8px; border-radius: 4px; }

    /* 3. 文本输入区 - 占据剩余空间 */
    .input-wrapper { flex: 1; display: flex; flex-direction: column; position: relative; }
    textarea { 
      flex: 1; width: 100%; padding: 15px; border: none; outline: none; 
      font-size: 18px; background: #fff; resize: none;
    }

    /* 4. 动作按钮 */
    .action-bar { display: flex; width: 100%; border-top: 1px solid #ddd; }
    .action-bar button { flex: 1; padding: 14px; border: none; font-weight: bold; font-size: 15px; cursor: pointer; }
    #clearBtn { background: #fdf2f2; color: #d32f2f; }
    #generate { background: var(--primary-color); color: white; flex: 1.5; }

    /* 练习显示区 */
    .cloze-display { padding: 20px; white-space: pre-wrap; display: none; }
    .cloze-display.active { display: block; }

    /* 5. 底部状态栏 - 紧凑并排 */
    .footer-bar { 
      background: #222; color: #bbb; padding: 8px 15px; font-size: 11px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .footer-bar a { color: #81c784; text-decoration: none; }
    .mini-coffee-btn { 
      background: #ff9800; color: white; border: none; padding: 3px 8px; 
      border-radius: 4px; font-weight: bold; font-size: 10px; cursor: pointer;
    }

    /* 弹窗 */
    .modal {
      display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); align-items: center; justify-content: center;
    }
    .modal-content { background: white; padding: 20px; border-radius: 12px; text-align: center; width: 260px; }
    .modal-content img { width: 100%; border-radius: 8px; margin-top: 10px; }

    /* 针对不同字号的自适应输入框样式 */
    .cloze-display input {
      border: none; border-bottom: 1.5px solid #666; background: #fffde7;
      text-align: center; color: #000; font-family: inherit; font-size: inherit;
    }
  </style>
</head>
<body>

<div class="app-container">
  <div class="file-tabs-container" id="fileTabs">
    <button class="add-file-btn" style="background:none; border:none; font-size:24px; color:var(--primary-color)" onclick="addNewFile()">+</button>
  </div>

  <div class="header-controls">
    <span class="brand">Cloze</span>
    <div class="font-controls">
      <button class="small-btn" onclick="changeFontSize(-2)">A-</button>
      <span id="sizeLabel">18</span>
      <button class="small-btn" onclick="changeFontSize(2)">A+</button>
    </div>
    <div>
      Every <input id="nthWord" type="number" value="4" style="width:35px; border:1px solid #ddd; text-align:center"> th
    </div>
  </div>

  <div class="input-wrapper">
    <textarea id="inputText" placeholder="Paste your English text here..."></textarea>
    <div id="clozeDisplay" class="cloze-display"></div>
  </div>

  <div class="action-bar">
    <button id="clearBtn">CLEAR</button>
    <button id="generate">GENERATE</button>
  </div>

  <div class="footer-bar">
    <span><a href="mailto:fnhame@gmail.com">fnhame@gmail.com</a></span>
    <div style="display:flex; align-items:center; gap:10px;">
      <button class="mini-coffee-btn" onclick="openModal()">☕ Buy Coffee</button>
      <span>Ricky @ 2026</span>
    </div>
  </div>
</div>

<div id="coffeeModal" class="modal" onclick="closeModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h4 style="margin:0">Support Development</h4>
    <img src="coffee.png" alt="QR Code">
    <p style="font-size:11px; color:#999; margin-top:10px">Thank you for your kindness!</p>
  </div>
</div>

<script>
  // 保持之前的 JavaScript 逻辑基本不变，但针对 UI 切换做一点微调
  let files = JSON.parse(localStorage.getItem('cloze_files_v5')) || [{ id: Date.now(), title: 'File 1', content: '' }];
  let activeFileId = files[0].id;
  let currentFontSize = 18;
  let answers = [];

  const inputArea = document.getElementById("inputText");
  const displayArea = document.getElementById("clozeDisplay");

  function init() { renderTabs(); loadActiveFile(); }

  function renderTabs() {
    const tabs = document.getElementById('fileTabs');
    tabs.innerHTML = '';
    files.forEach(f => {
      const div = document.createElement('div');
      div.className = `file-tab ${f.id === activeFileId ? 'active' : ''}`;
      div.ondblclick = () => renameFile(f.id);
      div.innerHTML = `<span onclick="switchFile(${f.id})">${f.title}</span>
                       <span class="delete-file-btn" onclick="deleteFile(${f.id}, event)">×</span>`;
      tabs.appendChild(div);
    });
    const btn = document.createElement('button');
    btn.innerHTML = '+'; btn.style = "background:none; border:none; font-size:24px; color:var(--primary-color); cursor:pointer;";
    btn.onclick = addNewFile;
    tabs.appendChild(btn);
  }

  function renameFile(id) {
    const file = files.find(x => x.id === id);
    const newName = prompt("Rename to:", file.title);
    if (newName) { file.title = newName; save(); renderTabs(); }
  }

  function loadActiveFile() {
    const f = files.find(x => x.id === activeFileId);
    if (f) { inputArea.value = f.content; inputArea.style.display = 'block'; displayArea.classList.remove('active'); }
  }

  function addNewFile() {
    const id = Date.now();
    files.push({ id, title: 'File ' + (files.length + 1), content: '' });
    activeFileId = id; save(); renderTabs(); loadActiveFile();
  }

  function switchFile(id) { activeFileId = id; renderTabs(); loadActiveFile(); }

  function deleteFile(id, e) {
    e.stopPropagation();
    if (files.length <= 1) return;
    if (confirm("Delete?")) {
      files = files.filter(x => x.id !== id);
      if (activeFileId === id) activeFileId = files[0].id;
      save(); renderTabs(); loadActiveFile();
    }
  }

  function save() { localStorage.setItem('cloze_files_v5', JSON.stringify(files)); }

  inputArea.oninput = () => {
    const f = files.find(x => x.id === activeFileId);
    if (f) { f.content = inputArea.value; save(); }
  };

  function changeFontSize(d) {
    currentFontSize += d;
    if (currentFontSize < 12) currentFontSize = 12;
    inputArea.style.fontSize = currentFontSize + "px";
    displayArea.style.fontSize = currentFontSize + "px";
    document.getElementById("sizeLabel").innerText = currentFontSize;
  }

  document.getElementById("generate").onclick = () => {
    if (!inputArea.value.trim()) return;
    const n = parseInt(document.getElementById("nthWord").value) || 4;
    displayArea.innerHTML = generateCloze(inputArea.value, n);
    inputArea.style.display = 'none';
    displayArea.classList.add('active');
    
    // 绑定 input 事件
    displayArea.querySelectorAll("input").forEach(input => {
      input.oninput = () => {
        const ans = answers[input.dataset.id];
        input.style.backgroundColor = input.value.trim().toLowerCase() === ans.toLowerCase() ? "#c8f7c5" : "#f7c5c5";
      };
      // Space 提示逻辑保持不变
    });
  };

  document.getElementById("clearBtn").onclick = () => {
    inputArea.value = ""; 
    const f = files.find(x => x.id === activeFileId);
    if(f) f.content = ""; save();
    inputArea.style.display = 'block';
    displayArea.classList.remove('active');
  };

  function generateCloze(text, n) {
    let index = 0; answers = [];
    const regex = /\([^)]*\)|\b([a-zA-Z]+)\b/g;
    return text.replace(regex, (match, word) => {
      if (match.startsWith('(')) return `<span style="color:#999; font-style:italic;">${match}</span>`;
      if (word) {
        index++;
        if (index % n === 1) {
          const id = answers.length; answers.push(word);
          return `<input data-id="${id}" autocomplete="off" style="width: ${word.length + 1}ch">`;
        }
        return word;
      }
      return match;
    });
  }

  function openModal() { document.getElementById('coffeeModal').style.display = 'flex'; }
  function closeModal() { document.getElementById('coffeeModal').style.display = 'none'; }

  init();
</script>
</body>
</html>
