<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Cloze Master Pro</title>
<style>
:root { --primary: #43a047; --bg-light: #f8f9fa; --danger: #ff5252; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; width:100%; height:100dvh; font-family:-apple-system, system-ui, "Microsoft YaHei", sans-serif; background:#fff; color:#333; overflow:hidden; }
.app-container { display:flex; flex-direction:column; height:100%; width:100%; }
.hidden { display:none !important; }

/* UI æ ·å¼ (ä¿æŒä½ åŸå§‹è®¾è®¡çš„å…¨éƒ¨æ ·å¼) */
.file-tabs-container { background:#fff; padding:8px 6px; display:flex; align-items:center; gap:6px; border-bottom:1px solid #eee; overflow-x:auto; white-space:nowrap; flex-shrink:0; }
.file-tab { padding:6px 14px; background:var(--bg-light); border:1px solid #ddd; border-radius:20px; font-size:14px; cursor:pointer; display:inline-flex; align-items:center; }
.file-tab.active { background:var(--primary); color:white; border-color:var(--primary); }
.add-file-btn { background:var(--primary); color:white; border:none; width:28px; height:28px; border-radius:50%; font-size:20px; display:flex; align-items:center; justify-content:center; flex-shrink:0; cursor:pointer; }
.header-controls { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; background:var(--bg-light); border-bottom:1px solid #ddd; font-size:14px; flex-shrink:0; }
.small-btn { border:1px solid #ccc; background:#fff; padding:2px 8px; border-radius:4px; cursor:pointer; }
.input-wrapper { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
textarea { flex:1; width:100%; padding:15px 10px; border:none; outline:none; font-size:18px; line-height:1.6; resize:none; background:#fff; }
.paste-fab { position:absolute; right:20px; bottom:25px; background:var(--primary); color:white; border:none; padding:12px 22px; border-radius:30px; font-size:14px; font-weight:bold; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:100; transition:all 0.2s; cursor:pointer;}
.cloze-display { position:absolute; top:0; left:0; right:0; bottom:0; padding:15px 10px; white-space:pre-wrap; display:none; line-height:1.8; word-break:break-word; background:#fff; height:100%; overflow-y:auto; padding-bottom:60vh !important; }
.cloze-display.active { display:block; }
.cloze-display input { min-width:3.6ch; padding:0 0.2ch; border:none; border-bottom:1.5px solid #666; background:#fffde7; text-align:center; color:#000; font-size:inherit; margin:0 2px; }
.action-bar { display:flex; width:100%; border-top:1px solid #ddd; flex-shrink:0; background:#fff; }
.action-bar button { flex:1; padding:18px; border:none; font-weight:bold; font-size:16px; cursor:pointer; }
#clearBtn { background:#fff8f8; color:#d32f2f; }
#generate { background:var(--primary); color:white; flex:1.5; }
.footer-bar { background:#1a1a1a; color:#999; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; flex-shrink:0; padding-bottom:calc(env(safe-area-inset-bottom)+8px); }
.modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; }
.modal-content { background:white; padding:22px; border-radius:14px; width:85%; max-width:320px; position:relative; }
.close-x { position:absolute; right:12px; top:8px; font-size:24px; color:#bbb; cursor:pointer; }
</style>
</head>

<body>
<div class="app-container">
  <div id="topSection">
    <div class="file-tabs-container" id="fileTabs"></div>
    <div class="header-controls">
      <span style="font-weight:bold; color:var(--primary); font-size:16px;">Cloze Master</span>
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="small-btn" onclick="changeFontSize(-2)">A-</button>
        <span id="sizeLabel" style="min-width:20px; text-align:center;">18</span>
        <button class="small-btn" onclick="changeFontSize(2)">A+</button>
      </div>
      <div>é—´éš” <input id="nthWord" type="number" value="4" style="width:35px; border:1px solid #ddd; text-align:center"> è¯</div>
    </div>
  </div>

  <div class="input-wrapper">
    <textarea id="inputText" placeholder="åœ¨æ­¤ç²˜è´´è‹±æ–‡æˆ–ä¸­æ–‡æ–‡æœ¬..."></textarea>
    <button id="pasteBtn" class="paste-fab" onclick="handlePaste()">ğŸ“‹ Paste ç²˜è´´</button>
    <div id="clozeDisplay" class="cloze-display">
      <button onclick="exitExercise()" style="background:#eee; border:1px solid #ccc; padding:8px 15px; border-radius:6px; margin-bottom:15px;">â† Back / è¿”å›ä¿®æ”¹</button>
      <div id="clozeContent"></div>
    </div>
  </div>

  <div class="action-bar" id="bottomAction">
    <button id="clearBtn" onclick="handleClear()">æ¸…ç©º</button>
    <button id="generate" onclick="handleGenerate()">ç”Ÿæˆç»ƒä¹ </button>
    <button id="customClozeBtn" onclick="enableCustomCloze()">æ‰‹åŠ¨æŒ–ç©º</button>
  </div>

  <div class="footer-bar" id="footerSection">
    <div class="footer-left" style="display:flex; gap:18px; align-items:center;">
      <span class="footer-link" onclick="openGuide()" style="cursor:pointer; font-weight:bold; color:#81c784;">ğŸ“– Guide æ‰‹å†Œ</span>
      <span id="loginBtnLabel" class="footer-link" onclick="openLoginModal()" style="cursor:pointer; font-weight:bold; color:#42a5f5;">ğŸ‘¤ ç™»å½•/åŒæ­¥</span>
    </div>
    <div class="footer-right" style="color:#999; font-size:12px;">Ricky @ 2026</div>
  </div>
</div>

<div id="loginModal" class="modal" onclick="closeLoginModal()">
  <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
    <span class="close-x" onclick="closeLoginModal()">Ã—</span>
    <h4 style="color:#42a5f5; margin-top:0;">ğŸ‘¤ è´¦å·ç™»å½•</h4>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <input type="email" id="authEmail" placeholder="é‚®ç®±" style="padding:12px; border:1px solid #ddd; border-radius:8px;">
      <input type="password" id="authPassword" placeholder="å¯†ç " style="padding:12px; border:1px solid #ddd; border-radius:8px;">
      <button onclick="handleEmailAuth('login')" style="padding:12px; background:#42a5f5; color:white; border:none; border-radius:8px; font-weight:bold;">ç™» å½•</button>
      <button onclick="handleEmailAuth('signup')" style="padding:10px; background:#fff; color:#42a5f5; border:1px solid #42a5f5; border-radius:8px;">æ–°ç”¨æˆ·æ³¨å†Œ</button>
      <button id="logoutBtn" class="hidden" onclick="handleLogout()" style="color:#ff5252; border:none; background:none; font-size:12px;">é€€å‡ºç™»å½•</button>
    </div>
  </div>
</div>

<div id="guideModal" class="modal" onclick="closeGuide()">
  <div class="modal-content" onclick="event.stopPropagation()" style="font-size:13px; color:#444;">
    <span class="close-x" onclick="closeGuide()">Ã—</span>
    <h4 style="color:var(--primary); text-align:center;">ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
    <p>1. <b>æŒ–ç©ºé—´éš”</b>ï¼šè®¾ç½®æ¯å‡ ä¸ªè¯æŒ–ä¸€ä¸ªç©ºã€‚</p>
    <p>2. <b>æ‰‹åŠ¨æŒ–ç©º</b>ï¼šç‚¹å‡»å•è¯æŒ–ç©ºï¼ŒåŒå‡»æ’¤é”€ã€‚</p>
    <p>3. <b>å•è¯æç¤º</b>ï¼šæŒ‰é”®ç›˜ç©ºæ ¼é”®æç¤ºä¸‹ä¸€ä¸ªå­—æ¯ã€‚</p>
    <hr>
    <div style="display:flex; justify-content:center; gap:30px; margin:15px 0;">
      <div>ğŸ“ˆ <b id="visitCount">0</b></div>
      <div onclick="likeApp()" style="cursor:pointer;">â¤ï¸ <b id="likeCount">0</b></div>
    </div>
    <button onclick="closeGuide()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:6px;">çŸ¥é“äº†</button>
  </div>
</div>

<script>
// --- å…¨å±€æ ¸å¿ƒæ•°æ® (å¿…é¡»æŒ‚è½½åˆ° window æ‰èƒ½è®© Firebase ä¿®æ”¹) ---
const DEFAULT_TEXT = `Hello! Welcome to Cloze Master.`;
window.files = JSON.parse(localStorage.getItem('cloze_files_v5')) || [{
  id: Date.now(), title: 'File 1', content: DEFAULT_TEXT, clozePositions: []
}];
let activeFileId = window.files[0].id;
let currentFontSize = 18;
let answers = [];

const inputArea = document.getElementById("inputText");
const displayArea = document.getElementById("clozeDisplay");
const clozeContent = document.getElementById("clozeContent");

function init() { renderTabs(); loadActiveFile(); }

// --- åŸºç¡€åŠŸèƒ½é€»è¾‘ ---
function renderTabs() {
  const tabs = document.getElementById('fileTabs'); tabs.innerHTML='';
  window.files.forEach(f=>{
    const div=document.createElement('div');
    div.className=`file-tab ${f.id===activeFileId?'active':''}`;
    div.ondblclick=()=>{ const n=prompt("é‡å‘½å:", f.title); if(n){f.title=n; save(); renderTabs();} };
    div.innerHTML=`<span onclick="switchFile(${f.id})">${f.title}</span><span style="color:var(--danger);margin-left:10px;" onclick="deleteFile(${f.id}, event)">Ã—</span>`;
    tabs.appendChild(div);
  });
  const btn=document.createElement('button'); btn.className="add-file-btn"; btn.innerHTML='ï¼‹'; btn.onclick=addNewFile;
  tabs.appendChild(btn);
}

function save() {
  localStorage.setItem('cloze_files_v5', JSON.stringify(window.files));
  if (window.syncToCloud) window.syncToCloud(window.files);
}

function loadActiveFile(){
  const f=window.files.find(x=>x.id===activeFileId);
  if(f) { inputArea.value = f.content || ""; answers = []; }
}

function saveActiveFile(val) {
  const f = window.files.find(x => x.id === activeFileId);
  if (f) { f.content = (val !== undefined) ? val : inputArea.value; save(); }
}

async function handlePaste() {
  const text = await navigator.clipboard.readText();
  if (text) { inputArea.value=text; saveActiveFile(); }
}

function switchFile(id){ activeFileId=id; renderTabs(); loadActiveFile(); }
function addNewFile(){
  const id=Date.now();
  window.files.push({id, title:'File '+(window.files.length+1), content:'', clozePositions:[]});
  activeFileId=id; save(); renderTabs(); loadActiveFile();
}
function deleteFile(id, e){ e.stopPropagation(); if(window.files.length<=1)return; window.files=window.files.filter(x=>x.id!==id); if(activeFileId===id)activeFileId=window.files[0].id; save(); renderTabs(); loadActiveFile(); }

function handleClear(){ if(confirm("ç¡®å®šæ¸…ç©ºï¼Ÿ")){ inputArea.value=""; saveActiveFile(""); } }
function changeFontSize(d){ currentFontSize+=d; inputArea.style.fontSize=displayArea.style.fontSize=currentFontSize+"px"; document.getElementById("sizeLabel").innerText=currentFontSize; }

// --- æŒ–ç©ºé€»è¾‘ (ä¿æŒåŸé€»è¾‘) ---
function generateCloze(text, n){
  let index=0; answers=[];
  const regex = /\([^)]*\)|[a-zA-Z]+|[\u4e00-\u9fa5]/g;
  return text.replace(regex,(match)=>{
    if (match.startsWith('(')) return `<span style="color:#999;font-style:italic;">${match}</span>`;
    index++;
    if(index%n===1){
      const id = answers.length; answers.push(match);
      const isChinese = /[\u4e00-\u9fa5]/.test(match);
      return `<input data-id="${id}" autocomplete="off" style="width:${isChinese?2:match.length+1}ch;font-family:inherit;" onfocus="this.select();">`;
    }
    return match;
  });
}

function handleGenerate(){
  const n=parseInt(document.getElementById("nthWord").value)||4;
  clozeContent.innerHTML=generateCloze(inputArea.value, n);
  toggleUI(true);
  clozeContent.querySelectorAll("input").forEach(input=>{
    input.oninput=()=>{ const ans=answers[input.dataset.id]; input.style.backgroundColor=input.value.trim().toLowerCase()===ans.toLowerCase()?"#c8f7c5":(input.value?"#f7c5c5":"#fffde7"); };
    input.onkeydown=(e)=>{ if(e.keyCode===32){ e.preventDefault(); const ans=answers[input.dataset.id]; input.value=ans.substring(0,input.value.length+1); input.oninput(); } };
  });
}

function enableCustomCloze() {
  const f = window.files.find(x => x.id === activeFileId);
  const regex = /([a-zA-Z]+|[\u4e00-\u9fa5]|[^\s\w\u4e00-\u9fa5]+)/g;
  const segments = inputArea.value.split(regex);
  answers = []; let unitCount = 0;
  clozeContent.innerHTML = segments.map((seg) => {
    if (!seg || !seg.trim()) return seg;
    const currentIdx = unitCount++;
    if (f.clozePositions && f.clozePositions.includes(currentIdx)) {
      answers.push(seg);
      return `<input data-id="${answers.length-1}" data-index="${currentIdx}" style="width:${seg.length+1}ch;" onfocus="this.select();">`;
    }
    return `<span class="word-span" data-index="${currentIdx}" style="cursor:pointer" onclick="toggleCloze(${currentIdx})">${seg}</span>`;
  }).join("");
  toggleUI(true);
}

function toggleCloze(idx){
  const f = window.files.find(x => x.id === activeFileId);
  if(!f.clozePositions) f.clozePositions=[];
  if(f.clozePositions.includes(idx)) f.clozePositions = f.clozePositions.filter(i=>i!==idx);
  else f.clozePositions.push(idx);
  save(); enableCustomCloze();
}

function toggleUI(isExercise){
  ["topSection","bottomAction","footerSection","pasteBtn","inputText"].forEach(id=>document.getElementById(id).classList.toggle("hidden", isExercise));
  displayArea.classList.toggle("active", isExercise);
}
function exitExercise(){ toggleUI(false); }
function openGuide(){ document.getElementById("guideModal").style.display="flex"; }
function closeGuide(){ document.getElementById("guideModal").style.display="none"; }
function openLoginModal(){ document.getElementById("loginModal").style.display="flex"; }
function closeLoginModal(){ document.getElementById("loginModal").style.display="none"; }

inputArea.oninput=()=>saveActiveFile();
init();
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getDatabase, ref, get, set, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
    authDomain: "cloze-master-pro.firebaseapp.com",
    projectId: "cloze-master-pro",
    databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  let currentUser = null;

  onAuthStateChanged(auth, (user) => {
    const btnLabel = document.getElementById('loginBtnLabel');
    if (user) {
      currentUser = user;
      btnLabel.innerText = "âœ… å·²åŒæ­¥: " + user.email.split('@')[0];
      startRealtimeSync(user.uid);
    } else {
      currentUser = null;
      btnLabel.innerText = "ğŸ‘¤ ç™»å½•/åŒæ­¥";
    }
  });

  function startRealtimeSync(uid) {
    onValue(ref(db, `users/${uid}/files`), (snap) => {
      if (!snap.exists()) return;
      const data = snap.val();
      if (JSON.stringify(data) !== JSON.stringify(window.files)) {
        window.files = data;
        localStorage.setItem('cloze_files_v5', JSON.stringify(data));
        renderTabs();
        const f = window.files.find(x => x.id === activeFileId);
        if (f) {
          const start = inputArea.selectionStart, end = inputArea.selectionEnd;
          inputArea.value = f.content || "";
          inputArea.setSelectionRange(start, end);
        }
      }
    });
  }

  window.syncToCloud = (data) => { if(currentUser) set(ref(db, `users/${currentUser.uid}/files`), data); };
  window.handleEmailAuth = async (type) => {
    const e = document.getElementById('authEmail').value, p = document.getElementById('authPassword').value;
    if(type==='signup') await createUserWithEmailAndPassword(auth, e, p);
    else await signInWithEmailAndPassword(auth, e, p);
    closeLoginModal();
  };
  window.handleLogout = () => { if(confirm("é€€å‡ºï¼Ÿ")) signOut(auth); };

  // ç»Ÿè®¡é€»è¾‘
  runTransaction(ref(db, "stats/visits"), v => (v || 0) + 1);
  get(ref(db, "stats")).then(s => { if(s.exists()){ document.getElementById("visitCount").innerText=s.val().visits; document.getElementById("likeCount").innerText=s.val().likes; }});
  window.likeApp = () => runTransaction(ref(db, "stats/likes"), v => (v || 0) + 1).then(() => location.reload());
</script>
</body>
</html>
