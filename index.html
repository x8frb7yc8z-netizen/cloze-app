<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Cloze Master Pro</title>
<style>
:root { --primary: #43a047; --bg-light: #f8f9fa; --danger: #ff5252; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { margin:0; padding:0; width:100%; height:100dvh; font-family:-apple-system, system-ui, "Microsoft YaHei", sans-serif; background:#fff; color:#333; overflow:hidden; }
.app-container { display:flex; flex-direction:column; height:100%; width:100%; }
.hidden { display:none !important; }

/* é¡¶éƒ¨æ ‡ç­¾ */
.file-tabs-container {
  background:#fff; padding:8px 6px; display:flex; align-items:center; gap:6px; border-bottom:1px solid #eee; overflow-x:auto; white-space:nowrap; flex-shrink:0;
}
.file-tab { padding:6px 14px; background:var(--bg-light); border:1px solid #ddd; border-radius:20px; font-size:14px; cursor:pointer; display:inline-flex; align-items:center; }
.file-tab.active { background:var(--primary); color:white; border-color:var(--primary); }
.add-file-btn { background:var(--primary); color:white; border:none; width:28px; height:28px; border-radius:50%; font-size:20px; display:flex; align-items:center; justify-content:center; flex-shrink:0; cursor:pointer; }

/* æ§åˆ¶æ  */
.header-controls { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; background:var(--bg-light); border-bottom:1px solid #ddd; font-size:14px; flex-shrink:0; }
.small-btn { border:1px solid #ccc; background:#fff; padding:2px 8px; border-radius:4px; cursor:pointer; }

/* ä¸­é—´æ–‡æœ¬åŒº */
.input-wrapper { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
textarea { flex:1; width:100%; padding:15px 10px; border:none; outline:none; font-size:18px; line-height:1.6; resize:none; background:#fff; }

.paste-fab { position:absolute; right:20px; bottom:25px; background:var(--primary); color:white; border:none; padding:12px 22px; border-radius:30px; font-size:14px; font-weight:bold; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:100; transition:all 0.2s; cursor:pointer;}
.paste-fab:active { transform:scale(0.9); opacity:0.8; }

.cloze-display { 
  position:absolute; top:0; left:0; right:0; bottom:0; padding:15px 10px; white-space:pre-wrap; display:none; line-height:1.8; word-break:break-word; background:#fff; height:100%; overflow-y:auto; -webkit-overflow-scrolling:touch; padding-bottom:60vh !important;
}
.cloze-display.active { display:block; }
.cloze-display input { min-width:3.6ch; padding:0 0.2ch; line-height:1.4; border:none; border-bottom:1.5px solid #666; background:#fffde7; text-align:center; color:#000; font-size:inherit; margin:0 2px; border-radius:0; }

/* åº•éƒ¨æ“ä½œåŒº */
.action-bar { display:flex; width:100%; border-top:1px solid #ddd; flex-shrink:0; background:#fff; }
.action-bar button { flex:1; padding:18px; border:none; font-weight:bold; font-size:16px; cursor:pointer; }
#clearBtn { background:#fff8f8; color:#d32f2f; }
#generate { background:var(--primary); color:white; flex:1.5; }

.footer-bar { background:#1a1a1a; color:#999; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; flex-shrink:0; padding-bottom:calc(env(safe-area-inset-bottom)+8px); }

/* å¼¹çª— */
.modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; }
.modal-content { background:white; padding:22px; border-radius:14px; width:85%; max-width:320px; position:relative; }
.close-x { position:absolute; right:12px; top:8px; font-size:24px; color:#bbb; cursor:pointer; }
</style>
</head>

<body>
<div class="app-container">
  <div id="topSection">
    <div class="file-tabs-container" id="fileTabs"></div>
    <div class="header-controls">
      <span style="font-weight:bold; color:var(--primary); font-size:16px;">Cloze Master</span>
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="small-btn" onclick="changeFontSize(-2)">A-</button>
        <span id="sizeLabel" style="min-width:20px; text-align:center;">18</span>
        <button class="small-btn" onclick="changeFontSize(2)">A+</button>
      </div>
      <div>é—´éš” <input id="nthWord" type="number" value="4" style="width:35px; border:1px solid #ddd; text-align:center"> è¯</div>
    </div>
  </div>

  <div class="input-wrapper">
    <textarea id="inputText" placeholder="åœ¨æ­¤ç²˜è´´è‹±æ–‡æˆ–ä¸­æ–‡æ–‡æœ¬..."></textarea>
    <button id="pasteBtn" class="paste-fab" onclick="handlePaste()">ğŸ“‹ Paste ç²˜è´´</button>
    <div id="clozeDisplay" class="cloze-display">
      <button onclick="exitExercise()" style="background:#eee; border:1px solid #ccc; padding:8px 15px; border-radius:6px; margin-bottom:15px;">â† Back / è¿”å›ä¿®æ”¹</button>
      <div id="clozeContent"></div>
    </div>
  </div>

  <div class="action-bar" id="bottomAction">
    <button id="clearBtn" onclick="handleClear()">æ¸…ç©º</button>
    <button id="generate" onclick="handleGenerate()">ç”Ÿæˆç»ƒä¹ </button>
    <button id="customClozeBtn" onclick="enableCustomCloze()">æ‰‹åŠ¨æŒ–ç©º</button>
  </div>

  <div class="footer-bar" id="footerSection">
    <div class="footer-left" style="display:flex; gap:18px; align-items:center;">
      <span class="footer-link" onclick="openGuide()" style="cursor:pointer; font-weight:bold; color:#81c784;">ğŸ“– Guide æ‰‹å†Œ</span>
      <span id="loginBtnLabel" class="footer-link" onclick="openLoginModal()" style="cursor:pointer; font-weight:bold; color:#42a5f5;">ğŸ‘¤ ç™»å½•/åŒæ­¥</span>
    </div>
    <div class="footer-right" style="color:#999; font-size:12px;">Ricky @ 2026</div>
  </div>
</div>

<div id="loginModal" class="modal" onclick="closeLoginModal()">
  <div class="modal-content" onclick="event.stopPropagation()" style="text-align:center;">
    <span class="close-x" onclick="closeLoginModal()">Ã—</span>
    <h4 style="color:#42a5f5; margin-top:0;">ğŸ‘¤ è´¦å·ç™»å½•</h4>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <input type="email" id="authEmail" placeholder="é‚®ç®±" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
      <input type="password" id="authPassword" placeholder="å¯†ç " style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
      <button onclick="handleEmailAuth('login')" style="padding:12px; background:#42a5f5; color:white; border:none; border-radius:8px; font-weight:bold;">ç™» å½•</button>
      <button onclick="handleEmailAuth('signup')" style="padding:10px; background:#fff; color:#42a5f5; border:1px solid #42a5f5; border-radius:8px;">æ–°ç”¨æˆ·æ³¨å†Œ</button>
      <button id="logoutBtn" class="hidden" onclick="handleLogout()" style="color:#ff5252; border:none; background:none; font-size:12px;">é€€å‡ºç™»å½•</button>
    </div>
  </div>
</div>

<script>
// --- æ ¸å¿ƒä¿®æ”¹ï¼šæ•°æ®æºæŒ‚è½½åˆ° window ---
const DEFAULT_TEXT = `Hello world! This is a test.`;
window.files = JSON.parse(localStorage.getItem('cloze_files_v5')) || [{
  id: Date.now(),
  title: 'File 1',
  content: DEFAULT_TEXT,
  clozePositions: []
}];
let activeFileId = window.files[0].id;
let currentFontSize = 18;
let answers = [];

const inputArea = document.getElementById("inputText");
const displayArea = document.getElementById("clozeDisplay");

function init() { renderTabs(); loadActiveFile(); }

function renderTabs() {
  const tabs = document.getElementById('fileTabs'); tabs.innerHTML='';
  window.files.forEach(f=>{
    const div=document.createElement('div');
    div.className=`file-tab ${f.id===activeFileId?'active':''}`;
    div.innerHTML=`<span onclick="switchFile(${f.id})">${f.title}</span>
      <span style="color:var(--danger);margin-left:10px;" onclick="deleteFile(${f.id}, event)">Ã—</span>`;
    tabs.appendChild(div);
  });
  const btn=document.createElement('button'); btn.className="add-file-btn"; btn.innerHTML='ï¼‹'; btn.onclick=addNewFile;
  tabs.appendChild(btn);
}

function save() {
    localStorage.setItem('cloze_files_v5', JSON.stringify(window.files));
    if (window.syncToCloud) window.syncToCloud(window.files);
}

function saveActiveFile(val) {
    const f = window.files.find(x => x.id === activeFileId);
    if (f) {
        f.content = (val !== undefined) ? val : inputArea.value;
        save();
    }
}

function loadActiveFile(){
  const f=window.files.find(x=>x.id===activeFileId);
  if(!f) return;
  inputArea.value=f.content || "";
}

function switchFile(id){ activeFileId=id; renderTabs(); loadActiveFile(); }
function addNewFile(){
  const id=Date.now();
  window.files.push({id, title:'File '+(window.files.length+1), content:'', clozePositions:[]});
  activeFileId=id; save(); renderTabs(); loadActiveFile();
}

inputArea.oninput=()=>saveActiveFile();
init();
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getDatabase, ref, get, set, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDQwjomxjLURd0nWmS0RuhkaecXISqALzs",
    authDomain: "cloze-master-pro.firebaseapp.com",
    projectId: "cloze-master-pro",
    databaseURL: "https://cloze-master-pro-default-rtdb.asia-southeast1.firebasedatabase.app",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  let currentUser = null;

  // --- ç™»å½•ç›‘å¬ ---
  onAuthStateChanged(auth, (user) => {
    const btnLabel = document.getElementById('loginBtnLabel');
    if (user) {
      currentUser = user;
      btnLabel.innerText = "âœ… å·²åŒæ­¥: " + user.email.split('@')[0];
      // å¼€å¯å®æ—¶ç›‘å¬
      startRealtimeSync(user.uid);
    } else {
      currentUser = null;
      btnLabel.innerText = "ğŸ‘¤ ç™»å½•/åŒæ­¥";
    }
  });

  // --- å®æ—¶ç›‘å¬é€»è¾‘ï¼ˆä¿®å¤æ ¸å¿ƒï¼‰ ---
  function startRealtimeSync(uid) {
    onValue(ref(db, `users/${uid}/files`), (snapshot) => {
      if (!snapshot.exists()) return;
      const cloudData = snapshot.val();
      
      // æ·±åº¦æ¯”è¾ƒï¼Œé¿å…æ­»å¾ªç¯ä¸Šä¼ 
      if (JSON.stringify(cloudData) !== JSON.stringify(window.files)) {
        console.log("æ£€æµ‹åˆ°äº‘ç«¯æ›´æ–°ï¼Œæ­£åœ¨å¼ºåˆ¶è¦†ç›–æœ¬åœ°...");
        applyData(cloudData);
      }
    });
  }

  function applyData(data) {
    // 1. æ›´æ–°å…¨å±€æ•°æ®
    window.files = data;
    localStorage.setItem('cloze_files_v5', JSON.stringify(data));

    // 2. åˆ·æ–°æ–‡ä»¶æ ‡ç­¾é¡µ
    if (window.renderTabs) window.renderTabs();

    // 3. å¼ºåˆ¶æ›´æ–°ç¼–è¾‘æ¡†ï¼ˆå¸¦å…‰æ ‡ä¿æŠ¤ï¼ŒæŒ‰è¦æ±‚åˆ æ‰ focus åˆ¤æ–­ï¼‰
    const f = window.files.find(x => x.id === activeFileId);
    if (f) {
      const inputArea = document.getElementById("inputText");
      const start = inputArea.selectionStart; // è®°å½•å…‰æ ‡ä½ç½®
      const end = inputArea.selectionEnd;
      
      inputArea.value = f.content || "";
      
      // è¿˜åŸå…‰æ ‡ä½ç½®ï¼Œé˜²æ­¢æ‰“å­—æ—¶è·³åŠ¨
      inputArea.setSelectionRange(start, end);
    }
  }

  window.syncToCloud = async (data) => {
    if (currentUser) await set(ref(db, `users/${currentUser.uid}/files`), data);
  };

  // ç»‘å®šå…¨å±€ç™»å½•å‡½æ•°
  window.handleEmailAuth = async (type) => {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    if (type === 'signup') await createUserWithEmailAndPassword(auth, email, password);
    else await signInWithEmailAndPassword(auth, email, password);
    window.closeLoginModal();
  };
</script>
</body>
</html>
